<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vertriebs-Dashboard v16.9 - A4 Druck & Flow Fix</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- html2canvas for JPEG export -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <style>
        /* Global Visual Boost */
        html {
            filter: saturate(1.4) contrast(1.05);
            -webkit-font-smoothing: antialiased;
            -moz-osx-osx-font-smoothing: grayscale;
            font-family: ui-sans-serif, system-ui, sans-serif;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background-color: #94a3b8; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-in { animation: fadeIn 0.3s ease-out forwards; }
        
        /* Animation definitions */
        @keyframes flow { from { stroke-dashoffset: 20; } to { stroke-dashoffset: 0; } }
        .flow-anim { stroke-dasharray: 10, 10; animation: flow 1s linear infinite; }
        
        @keyframes signal { 0% { opacity: 1; r: 5; } 100% { opacity: 0; r: 30; } }
        .signal-wave { animation: signal 2s infinite ease-out; opacity: 0; transform-origin: center; }
        .delay-1 { animation-delay: 0.5s; }

        @keyframes beam { 0% { stroke-dashoffset: 20; opacity: 0.5; } 50% { opacity: 1; } 100% { stroke-dashoffset: 0; opacity: 0.5; } }
        .beam-anim { animation: beam 1.5s linear infinite; }

        /* General Layout */
        html, body, #root { width: 100%; height: 100%; margin: 0; overflow: hidden; background-color: #f0f6ff; }
        

            /* FORCE: Backgrounds/Gradients im Druck (Chrome/Edge) */
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            /* Manche Browser drucken Hintergründe nur, wenn Elemente explizit ein BG haben */
            .print-offer-view, .situation-view-wrapper { background: #f0f6ff !important; }
        /* Canvas Layer: touch-action none is crucial for pen handling */
        .canvas-layer { pointer-events: auto; touch-action: none; }
        .input-layer { pointer-events: auto; z-index: 30; }
        
        /* --- WLAN PLANER STYLES --- */
        .wlan-chip {
            padding: 8px 16px; border-radius: 8px; border: 1px solid #e2e8f0; background: white; 
            color: #64748b; font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.2s;
        }
        .wlan-chip:hover { background: #f8fafc; }
        .wlan-chip.toggled { background: #eff6ff; border-color: #3b82f6; color: #2563eb; }
        .wlan-num { width: 40px; height: 40px; display: flex; items-center; justify-content: center; padding: 0; }
        
        .wlan-badge {
            padding: 4px 12px; border-radius: 999px; font-size: 11px; font-weight: 700; 
            text-transform: uppercase; letter-spacing: 0.05em; background: #f1f5f9; color: #94a3b8;
        }
        .wlan-badge.glow { background: #dbeafe; color: #1e40af; box-shadow: 0 0 10px rgba(59, 130, 246, 0.3); }
        
        .wifi-glow { animation: pulse-blue 2s infinite; }
        @keyframes pulse-blue { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

        /* SVG Styles */
        .wlan-svg .roof { fill: #e0f2fe; stroke: #94a3b8; }
        .wlan-svg .house-body { fill: #ffffff; stroke: #94a3b8; }
        .wlan-svg .keller { fill: #f1f5f9; stroke: #94a3b8; }
        .wlan-svg .floor-line { stroke: #e2e8e0; }
        
        /* Offer Canvas Styling */
        .offer-canvas-container {
            border: 4px solid #e5e5e5;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            background: white;
            min-height: 600px; 
            transition: all 0.25s ease; 
        }
        
        .canvas-lines {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: repeating-linear-gradient(to bottom, transparent, transparent 19px, #cbd5e1 20px);
            pointer-events: none;
            z-index: 1; 
        }
        
        .drawing-canvas { position: relative; z-index: 3; }
        
        .canvas-image {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: contain; pointer-events: none; z-index: 1; transform-origin: center center;
        }

        /* --- STIFT-FÄHIGE INPUTS --- */
        .small-canvas-wrapper {
            position: relative; width: 100%; height: 100%;
            background-color: white; border: 1px solid #e5e7eb; border-radius: 0.5rem;
            overflow: hidden; flex-grow: 1;
        }
        
        /* Unterschrifts-Canvas im Modal */
        .signature-canvas-container {
            width: 100%; height: 200px; background: #fff; border: 1px solid #e2e8f0; border-radius: 0.5rem;
            position: relative;
            background-image: linear-gradient(to bottom, transparent 90%, #6b7280 91%, transparent 92%);
            background-size: 100% 100%; background-repeat: no-repeat; background-position: 0 90%;
            overflow: hidden; touch-action: none;
        }
        
        
        /* Print-only Offer Header: am Bildschirm ausblenden */
        .print-only-offer-header { display: none; }
        /* Druck: Empfehlungen unter Buttons anzeigen */
        .print-reco { display: none; }

        /* --- EXPORT MODE (JPEG): nutzt Print-Layout ohne Druckdialog --- */
        .export-mode * {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        .export-mode .footer-bar,
        .export-mode .fixed.inset-0.z-50,
        .export-mode .no-print { display: none !important; }

        /* Header: wie Druck, ohne Buttons/Badge */
        .export-mode header{
            display:flex !important;
            padding:6px 10px !important;
            border-bottom:1px solid #e2e8f0 !important;
        }
        .export-mode header button,
        .export-mode header .no-print,
        .export-mode header span.bg-blue-600 { display:none !important; }
        .export-mode header h1{ font-size:28px !important; line-height:1.1 !important; }

        /* Seite 1: Situation exakt wie Druck (rechte Sidebar erzwingen + Row-Layout) */
        .export-mode .situation-view-wrapper aside{
            display:flex !important;
            visibility:visible !important;
            overflow:visible !important;
            height:auto !important;
        }
        .export-mode .situation-view-wrapper{
            display:flex !important;
            flex-direction:row !important;
            align-items:stretch !important;
            height:auto !important;
            overflow:visible !important;
            position:relative !important;
            width:100% !important;
            max-width:100% !important;
            zoom:0.82 !important;
            transform:none !important;
            transform-origin:top left !important;
            margin:0 !important;
            padding:0 !important;
        }

        /* Placeholders/„Eingabe…“ im Export ausblenden */
        .export-mode input::placeholder,
        .export-mode textarea::placeholder{ color: transparent !important; }

        /* Seite 2: Print-Container sichtbar (print-page-2 wird genutzt) */
        .export-mode .print-only-offer-header{ display:flex !important; }
        .export-mode .print-page-2{ background:#fff !important; }


/* --- PRINT STYLES (A4 Querformat + Skalierung/Komprimierung) --- */
        
        @media print {
  .print-reco{display:block !important;margin-top:6px !important;font-size:10px !important;font-weight:800 !important;color:#0f172a !important;background:#ffffff !important;border:1px solid #cbd5e1 !important;border-radius:10px !important;padding:6px 8px !important;}

  .no-print{display:none !important;}

            /* --- Druck: Farben/Verläufe wirklich mitdrucken (auch auf Seite 2) --- */
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            /* --- Druck: Offer-Header nur auf Seite 2 anzeigen --- */
            .print-only-offer-header { 
                display: flex !important; 
            }

            /* A4 Querformat */
            @page { size: A4 landscape; margin: 0.35cm; }

            /* Grundreset für Druck */
            html, body, #root {
                height: auto !important;
                overflow: visible !important;
                background: #f0f6ff !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            /* UI ausblenden (aber NICHT den Seiten-Header mit "Ihre Aktuelle Situation") */
            .footer-bar,
            .fixed.inset-0.z-50, /* Modals */
            .no-print {
                display: none !important;
            }

            /* Header im Druck sichtbar halten, aber kompakter */
            header {
                display: flex !important;
                padding: 6px 10px !important;
                border-bottom: 1px solid #e2e8f0 !important;
            }
            header * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            header button, header .no-print { display: none !important; }
            header span, header h1, header h2, header h3 { font-size: 11px !important; }


            /* Rechte Seitenleiste (Stammdaten etc.) im Druck sichtbar machen (Tailwind 'hidden' überschreiben) */
            .situation-view-wrapper aside {
                display: flex !important;
                visibility: visible !important;
                overflow: visible !important;
                height: auto !important;
            }

            /* -------- Seite 1: Situation / Analyse -------- */
            .situation-view-wrapper {
                /* Layout wie im UI beibehalten (sonst verschiebt sich der Flow im Druck) */
                display: flex !important;
                flex-direction: row !important;
                align-items: stretch !important;

                height: auto !important;
                overflow: visible !important;
                position: relative !important;

                /* Nicht breiter als die Seite (kein Clipping rechts) */
                width: 100% !important;
                max-width: 100% !important;

                /* Etwas kleiner, damit ALLES sicher auf Seite 1 passt */
                zoom: 0.82; /* Chrome/Edge */
                transform: none !important;
                transform-origin: top left;

                /* Seite 1 sauber beenden – aber NICHT 'inside: avoid' (sonst springt es komplett auf Seite 2) */
                page-break-after: always !important;
                page-break-before: auto !important;
                page-break-inside: auto !important;
                break-inside: auto !important;

                margin: 0 !important;
                padding: 0 !important;
            }

            .situation-view-wrapper .overflow-hidden,
            .situation-view-wrapper .overflow-y-auto,
            .situation-view-wrapper .flex-1 {
                overflow: visible !important;
                height: auto !important;
            }

            /* Verhindert riesige "100%" Höhen im Druck (Tailwind h-full) */
            .situation-view-wrapper .h-full,
            .situation-view-wrapper [class*="h-full"] {
                height: auto !important;
                min-height: 0 !important;
            }

            /* Druck-Padding etwas reduzieren, damit es garantiert auf 1 Seite bleibt */
            .situation-view-wrapper .p-4 { padding: 0.35cm !important; }
            .situation-view-wrapper .rounded-2xl { border-radius: 0.8rem !important; }

            /* Unterschrifts-/Zeichen-Canvas: innerhalb der Seite halten */
                        /* FIX: In Stift-Modus sind Texte per Tailwind transparent (text-slate-700/0) – im Druck wieder sichtbar machen */
            .situation-view-wrapper input,
            .situation-view-wrapper textarea {
                color: #0f172a !important;
                -webkit-text-fill-color: #0f172a !important;
                opacity: 1 !important;
            }
            .situation-view-wrapper input::placeholder,
            .situation-view-wrapper textarea::placeholder {
                color: transparent !important; /* "Skizze aktiv..." nicht drucken */
                -webkit-text-fill-color: transparent !important;
            }

.situation-view-wrapper canvas {
                position: absolute !important;
                top: 0 !important;
                left: 28% !important;
                width: 72% !important;
                height: 100% !important;
                z-index: 50 !important;
                background: transparent !important;
            }

            /* Schwarze Balken/Flächen im Druck entfernen */
            .situation-view-wrapper .bg-black,
            .situation-view-wrapper .bg-slate-900,
            .situation-view-wrapper .bg-slate-950 {
                background: transparent !important;
                color: #000 !important;
            }
            .situation-view-wrapper svg rect[fill="#0f172a"] { fill: transparent !important; stroke: transparent !important; }

            /* -------- Seite 2: Angebot -------- */
             .print-offer-view {
                display: block !important;
                position: relative !important;
                left: auto !important;
                top: auto !important;
                height: auto !important;
                padding: 0 !important;
                margin: 0 !important;
                overflow: visible !important;
                background: #f0f6ff !important;

                width: 100% !important;
                max-width: 100% !important;

                /* NICHT mehr verkleinern -> weniger „zu komprimiert“ */
                zoom: 1.0;
                transform: none !important;
            }

            .offer-canvas-container {
                box-shadow: none !important;
                border: 1px solid #ccc !important;
                page-break-inside: avoid !important;
                min-height: 340px !important;
            }

            .canvas-lines {
                background-image: repeating-linear-gradient(to bottom, transparent, transparent 19px, #d1d5db 20px) !important;
            }

            .offer-canvas-container textarea {
                color: #000 !important;
                -webkit-text-fill-color: #000 !important;
                opacity: 1 !important;
                font-size: 12px !important;
                line-height: 1.25 !important;
            }

            /* Grid im Druck etwas luftiger (aber weiter 2 Seiten bleiben) */
                        /* Kostenübersicht & Abschluss unten kompakter, damit oben mehr Platz bleibt */
            .print-offer-view .shadow-xl.shrink-0 {
                padding: 12px !important;
            }
            .print-offer-view .shadow-xl.shrink-0 h3 {
                font-size: 14px !important;
                margin-bottom: 6px !important;
            }
            .print-offer-view .shadow-xl.shrink-0 label {
                font-size: 9px !important;
            }
            .print-offer-view .shadow-xl.shrink-0 input {
                height: 42px !important;
            }

.offer-print-grid {
                display: grid !important;
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 1.1rem !important;
            }

            /* Kostenübersicht & Abschluss unten kompakter, damit Rest mehr Platz hat */
            .print-offer-view .shadow-xl.shrink-0 {
                padding: 10px !important;
            }
            .print-offer-view .shadow-xl.shrink-0 h3 { margin-bottom: 8px !important; font-size: 13px !important; }
            .print-offer-view .shadow-xl.shrink-0 .grid { gap: 10px !important; }
            .print-offer-view .shadow-xl.shrink-0 input,
            .print-offer-view .shadow-xl.shrink-0 textarea {
                font-size: 11px !important;
                line-height: 1.2 !important;
                padding: 6px 8px !important;
            }
        
            /* --- FIX: Texte in den rechten Feldern IM DRUCK immer sichtbar (auch wenn Stift-Modus aktiv ist) --- */
            .situation-view-wrapper input {
                color: #0f172a !important;
                -webkit-text-fill-color: #0f172a !important;
                opacity: 1 !important;
                text-shadow: none !important;
            }
            .situation-view-wrapper input::placeholder { color: transparent !important; }

            /* --- SEITE 2 (Angebot): mehr Fläche für die 3 Kästen, Kosten/Abschluss kompakter --- */
            .print-offer-view .offer-canvas-container {
                min-height: 460px !important;
            }
            /* Außenabstände im Druck etwas reduzieren */
            .print-offer-view .space-y-6 > :not([hidden]) ~ :not([hidden]) { margin-top: 0.9rem !important; }
            .print-offer-view .p-4 { padding: 0.35cm !important; }
            /* Kostenübersicht/Abschluss-Card kleiner */
            .print-offer-view .shadow-xl.shrink-0 {
                padding: 0.85rem !important;
            }
            .print-offer-view .shadow-xl.shrink-0 h3 { margin-bottom: 0.5rem !important; font-size: 1.0rem !important; }
            .print-offer-view .shadow-xl.shrink-0 label { font-size: 10px !important; margin-bottom: 0.15rem !important; }
            .print-offer-view .shadow-xl.shrink-0 .text-[10px] { font-size: 9px !important; }


            /* --- Seite 2: "Kostenübersicht & Abschluss" kompakter, damit nichts abgeschnitten wird --- */
            .print-kostenabschluss{
                padding: 0.30cm !important;
            }
            .print-kostenabschluss h3{
                font-size: 14px !important;
                margin-bottom: 0.20cm !important;
            }
            .print-kostenabschluss .grid{
                gap: 0.20cm !important;
            }
            .print-kostenabschluss .mb-6{ margin-bottom: 0.20cm !important; }
            .print-kostenabschluss .mt-4{ margin-top: 0.15cm !important; }
            .print-kostenabschluss .pt-4{ padding-top: 0.15cm !important; }
            .print-kostenabschluss .h-12{ height: 34px !important; }
            .print-kostenabschluss label{
                font-size: 8.5px !important;
                margin-bottom: 2px !important;
                letter-spacing: .06em !important;
            }
            .print-kostenabschluss .text-sm{ font-size: 11px !important; }
            .print-kostenabschluss .text-[10px]{ font-size: 8px !important; line-height: 1.15 !important; }
            .print-kostenabschluss .rounded-2xl{ border-radius: 0.8rem !important; }

        }

    
.ink-paper{background-image:repeating-linear-gradient(to bottom, rgba(148,163,184,.45) 0, rgba(148,163,184,.45) 2px, transparent 2px, transparent 34px);} 
.ink-hide::placeholder{color:transparent;}
</style>

    <style id="print-page2-scale">
      @media print {
        /* Seite 2: nur Kostenübersicht & Abschluss skalieren + leicht nach oben schieben (Seite 1 bleibt unverändert) */
        .print-page-2 {
          break-before: page !important;
          page-break-before: always !important;
          /* WICHTIG: zoom beeinflusst das Layout (verhindert Seite 3), transform alleine nicht */
          zoom: 0.88 !important;
          position: relative !important;
          top: -60px !important; /* 50px + 10px höher */
          left: 0 !important;
          transform: none !important;
          transform-origin: top center !important;
        }

        /* Keine ungewollten Schnitte innerhalb des Blocks */
        .print-page-2, .print-page-2 * {
          break-inside: avoid !important;
          page-break-inside: avoid !important;
        }
      }
    </style>

<style id="print-kosten-kompakt">
@media print {
  /* Seite 2: Kostenübersicht & Abschluss kompakter (nur Druck) */
  .print-page-2{
    padding: 10px !important; /* war p-6 */
    border-radius: 14px !important;
  }
  .print-page-2 h3{
    font-size: 14px !important;
    margin-bottom: 6px !important;
  }
  .print-page-2 .grid{
    gap: 10px !important; /* gap-4 -> 10px */
  }
  .print-page-2 .mb-6{ margin-bottom: 8px !important; }
  .print-page-2 .mt-4{ margin-top: 6px !important; }
  .print-page-2 .pt-4{ padding-top: 6px !important; }

  /* Labels kleiner/kompakter */
  .print-page-2 label{
    font-size: 8.5px !important;
    margin-bottom: 2px !important;
    letter-spacing: .06em !important;
  }

  /* Feldhöhen reduzieren (h-12) + Innenpadding */
  .print-page-2 .h-12{ height: 34px !important; }
  .print-page-2 .p-2{ padding: 6px !important; } /* z.B. Stempel-Feld */
  .print-page-2 .text-sm{ font-size: 11px !important; }
  .print-page-2 .text-[10px]{ font-size: 8px !important; line-height: 1.15 !important; }

  /* Canvas wrapper soll sich an neue Höhe anpassen */
  .print-page-2 .small-canvas-wrapper{ border-radius: 10px !important; }
}
</style>

<style>
@media print {

  /* Block deutlich kompakter + höher */
  .print-page-2 {
    padding: 0.5rem !important;           /* p-6 → p-2 */
    margin-top: -80px !important;         /* sichtbar höher */
  }

  /* Titel kleiner & enger */
  .print-page-2 h3 {
    font-size: 13px !important;
    margin-bottom: 0.4rem !important;
  }

  /* Grid stark verdichten */
  .print-page-2 .grid {
    gap: 0.4rem !important;               /* gap-4 → gap-1.5 */
    margin-bottom: 0.4rem !important;
  }

  /* Labels sehr kompakt */
  .print-page-2 label {
    margin-bottom: 1px !important;
    font-size: 8.5px !important;
    letter-spacing: 0.03em !important;
  }

  /* Eingabefelder flach */
  .print-page-2 .h-12 {
    height: 28px !important;              /* ~h-7 */
  }

  /* Canvas exakt gleich hoch */
  .print-page-2 canvas {
    height: 28px !important;
  }

  /* Unterschrift / Stempel */
  .print-page-2 .col-span-2 .h-12 {
    height: 30px !important;
  }

  /* Datenschutz extrem platzsparend */
  .print-page-2 p {
    margin-top: 2px !important;
    padding-top: 2px !important;
    font-size: 8.5px !important;
    line-height: 1.15 !important;
  }

  /* Trennlinie minimal */
  .print-page-2 .border-t {
    border-top-width: 0.5px !important;
  }
}
</style>


<style id="print-offer-header-tighten">
@media print {
  /* Seite 2: Gesamtblock minimal höher (reduziert obere Luft) */
  .print-offer-view{ position: relative !important; top: 0px !important; }
/* Seite-2 Header ("Ihr Persönliches Angebot") kleiner & flacher */
  .print-only-offer-header{
    height: 44px !important;         /* statt h-16 (64px) */
    padding: 4px 10px !important;
    margin: 0 0 6px 0 !important;
  }
  .print-only-offer-header h1{
    font-size: 20px !important;      /* statt text-3xl */
    line-height: 1.05 !important;
    letter-spacing: -0.02em !important;
  }
  /* Badge/kleine Texte im Header etwas kleiner */
  .print-only-offer-header .text-xs,
  .print-only-offer-header .text-sm{
    font-size: 10px !important;
  }

  /* Seite 2: vertikale Abstände reduzieren, damit Kostenbox komplett passt */
  .print-offer-view .space-y-6 > :not([hidden]) ~ :not([hidden]){
    margin-top: 0.55rem !important;
  }
  .offer-print-grid{
    gap: 0.85rem !important;
  }
  .print-offer-view .offer-canvas-container{
    min-height: 480px !important;    /* war 520px */
  }
}
</style>


<style id="print-kosten-top-shift">
@media print {
  .print-kostenabschluss{
    position: relative !important;
    top: -20px !important;
  }
}
</style>


<style id="print-page2-translatey-final">
@media print {
  /* FINAL: Seite 2 komplett nach oben schieben – nur Druck */
  .print-page-2 {
    transform: translateY(-170px) !important;
    transform-origin: top center !important;
  }
}
</style>


<style id="print-2page-hardlock">
@media print {
  /* =========================
     2-SEITEN-HARDLOCK
     Seite 1 = Situation
     Seite 2 = Angebot
     Alles darüber hinaus wird im Druck ausgeblendet
     ========================= */

  /* 1) Situation immer Seite 1 (NICHT abschneiden -> lieber minimal kleiner skalieren) */
  .situation-view-wrapper{
    display: flex !important;
    break-after: page !important;
    page-break-after: always !important;

    /* Kein Clipping auf Seite 1 */
    max-height: none !important;
    overflow: visible !important;

    /* Mini-Reserve, damit wirklich alles auf Seite 1 passt */
    zoom: 0.80 !important;
  }

  /* 2) Angebot immer Seite 2 */
  .print-offer-view{
    display: block !important;
    break-before: page !important;
    page-break-before: always !important;

    /* Hardlock: niemals über 1 Seite hinaus wachsen (Seite 3 verhindern) */
    max-height: 205mm !important;
    overflow: hidden !important;
  }

  /* 3) Kostenbox darf KEINEN eigenen Page-Break erzwingen */
  .print-page-2{
    break-before: auto !important;
    page-break-before: auto !important;
    break-after: auto !important;
    page-break-after: auto !important;

    break-inside: auto !important;
    page-break-inside: auto !important;

    /* dein gewünschter Shift */
    transform: translateY(80px) !important;
  }

  /* 4) Falls doch noch etwas NACH dem Angebot im DOM kommt: im Druck ausblenden */
  .print-offer-view ~ *{
    display: none !important;
  }

  /* 5) Kein globales Clipping im Druck */
  html, body, #root{
    overflow: visible !important;
  }
}
</style>



<style id="print-header-situation-match-offer">
@media print {
  /* Seite 1: Titel 'Ihre Aktuelle Situation' gleich groß wie Seite 2 */
  header h1,
  header h2 {
    font-size: 20px !important;
    font-weight: 900 !important;
    line-height: 1.05 !important;
    letter-spacing: -0.02em !important;
  }

  /* Analyse / Angebot Badges NIEMALS drucken */
  span.bg-blue-600.text-white {
    display: none !important;
  }
}
</style>


<style id="print-status-markers-red-green">
@media print {
  /* Status-Markierung (Rot/Grün) IM DRUCK erzwingen */
  .offer-canvas-container.border-red-500{
    border: 4px solid #ef4444 !important; /* Tailwind red-500 */
    box-shadow: 0 0 0 6px #fee2e2 !important; /* red-100 */
  }
  .offer-canvas-container.border-green-500{
    border: 4px solid #22c55e !important; /* Tailwind green-500 */
    box-shadow: 0 0 0 6px #dcfce7 !important; /* green-100 */
  }

  /* Fallback: falls Ring-Klassen separat greifen */
  .offer-canvas-container.ring-4.ring-red-100\/50{
    box-shadow: 0 0 0 6px #fee2e2 !important;
  }
  .offer-canvas-container.ring-4.ring-green-100\/50{
    box-shadow: 0 0 0 6px #dcfce7 !important;
  }
}
</style>


<style id="hide-toast-print-and-timeout">
/* Schwarze Status-/Toast-Meldungen */
.toast,
.toast-message,
[class*="toast"],
[class*="Toast"] {
  transition: opacity .3s ease, visibility .3s ease;
}

/* Im DRUCK grundsätzlich ausblenden */
@media print {
  .toast,
  .toast-message,
  [class*="toast"],
  [class*="Toast"] {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
  }
}
</style>

<script>
/* Fallback: falls Toast sichtbar bleibt, nach 1 Sekunde ausblenden */
(function(){
  function hideToasts(){
    document.querySelectorAll('.toast,.toast-message,[class*="toast"],[class*="Toast"]').forEach(el=>{
      setTimeout(()=>{
        el.style.opacity='0';
        el.style.visibility='hidden';
        el.style.display='none';
      },1000);
    });
  }
  document.addEventListener('DOMContentLoaded', hideToasts);
  document.addEventListener('click', hideToasts);
  window.addEventListener('beforeprint', hideToasts);
})();
</script>


<style id="hetec-logo-top-right">
/* HeTec Logo oben rechts auf Seite 1 (Header) & Seite 2 (Offer-Header) – ohne Layout-Verschiebung */
header, .print-only-offer-header {
  position: relative !important;
}
header::after,
.print-only-offer-header::after {
  content: "" !important;
  position: absolute !important;
  right: 10px !important;
  top: 6px !important;
  width: 190px !important;
  height: 70px !important;
  background-image: url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%20320%20120%22%3E%0A%20%20%3Cline%20x1%3D%2210%22%20y1%3D%2222%22%20x2%3D%22120%22%20y2%3D%2222%22%20stroke%3D%22%23777777%22%20stroke-width%3D%226%22%20stroke-linecap%3D%22round%22/%3E%0A%20%20%3Cline%20x1%3D%22200%22%20y1%3D%2222%22%20x2%3D%22310%22%20y2%3D%2222%22%20stroke%3D%22%23777777%22%20stroke-width%3D%226%22%20stroke-linecap%3D%22round%22/%3E%0A%20%20%3Ctext%20x%3D%22160%22%20y%3D%2232%22%20text-anchor%3D%22middle%22%20font-family%3D%22Arial%2C%20Helvetica%2C%20sans-serif%22%20font-size%3D%2228%22%20font-weight%3D%22700%22%20fill%3D%22%23777777%22%3ESHOP%3C/text%3E%0A%20%20%3Ctext%20x%3D%22160%22%20y%3D%2282%22%20text-anchor%3D%22middle%22%20font-family%3D%22Arial%2C%20Helvetica%2C%20sans-serif%22%20font-size%3D%2264%22%20font-weight%3D%22900%22%20fill%3D%22%23595959%22%3EHeTec%3C/text%3E%0A%20%20%3Ctext%20x%3D%22160%22%20y%3D%22108%22%20text-anchor%3D%22middle%22%20font-family%3D%22Arial%2C%20Helvetica%2C%20sans-serif%22%20font-size%3D%2218%22%20font-weight%3D%22700%22%20letter-spacing%3D%224%22%20fill%3D%22%232bd38b%22%3EWIR%20GESTALTEN%20ZUKUNFT%3C/text%3E%0A%3C/svg%3E") !important;
  background-repeat: no-repeat !important;
  background-position: right top !important;
  background-size: contain !important;
  pointer-events: none !important;
  z-index: 9999 !important;
}

/* Im Druck etwas tighter, damit garantiert nichts überlappt */
@media print {
  header::after,
  .print-only-offer-header::after {
    right: 8px !important;
    top: 4px !important;
    width: 175px !important;
    height: 64px !important;
  }
}
</style>


<style id="hetec-logo-smaller">
/* Logo oben rechts weiter verkleinern – Screen + Print */
.hetec-logo-wrap{
  transform: scale(0.72) !important;
  transform-origin: top right !important;
}

@media print{
  .hetec-logo-wrap{
    transform: scale(0.68) !important;
  }
}
</style>


<style id="hetec-logo-4px-smaller">
/* Logo minimal kleiner (≈ -4px visuell), ohne Layout-Verschiebung */
.hetec-logo-wrap{
  transform: scale(0.66) !important; /* vorher ~0.72 */
  transform-origin: top right !important;
}

@media print{
  .hetec-logo-wrap{
    transform: scale(0.62) !important;
  }
}
</style>


<style id="hetec-logo-final-small">
/* FINAL: Logo nochmals kleiner, passt sicher in Header */
.hetec-logo-wrap{
  transform: scale(0.58) !important;
  transform-origin: top right !important;
}

@media print{
  .hetec-logo-wrap{
    transform: scale(0.55) !important;
  }
}
</style>


<style id="hetec-logo-header-safe">
/* ABSOLUT SAFE: Logo kleiner + minimal nach oben/rechts, nie im Header */
.hetec-logo-wrap{
  transform: scale(0.45) !important;
  transform-origin: top right !important;
  margin-top: -4px !important;
}

@media print{
  .hetec-logo-wrap{
    transform: scale(0.42) !important;
    margin-top: -6px !important;
  }
}
</style>


<style id="hetec-logo-final-scale-move">
/* FINAL FIX: Logo insgesamt ~3px kleiner + nach oben (Screen & Print) */
.hetec-logo-wrap{
  transform: scale(0.42) translateY(-3px) !important;
  transform-origin: top right !important;
}

@media print{
  .hetec-logo-wrap{
    transform: scale(0.39) translateY(-5px) !important;
  }
}
</style>


<style id="hetec-logo-pseudo-final">
/* FINAL: HeTec-Logo (Pseudo-Element) kleiner + höher – Screen & Print */
header::after,
.print-only-offer-header::after{
  width: 170px !important;   /* kleiner */
  height: 62px !important;   /* kleiner */
  top: 2px !important;       /* höher */
  right: 8px !important;
  background-size: contain !important;
  background-repeat: no-repeat !important;
}

/* Druck: nochmals minimal kompakter */
@media print{
  header::after,
  .print-only-offer-header::after{
    width: 160px !important;
    height: 58px !important;
    top: 0px !important;
    right: 6px !important;
  }
}
</style>


<style id="hetec-logo-page2-fix">
/* =========================
   LOGO POSITION – SEITE 2 FIX
   Seite 1 bleibt UNVERÄNDERT
   ========================= */

/* Seite 2 (Angebot) – Header explizit anpassen */
.print-only-offer-header::after{
  transform: scale(0.42) translateY(-6px) !important;
  transform-origin: top right !important;
  right: 12px !important;
  top: 6px !important;
}

/* Druck: Seite 2 noch kompakter */
@media print{
  .print-only-offer-header::after{
    transform: scale(0.38) translateY(-8px) !important;
    right: 10px !important;
    top: 4px !important;
  }
}
</style>


<style id="hetec-logo-page2-print-bigger">
/* =========================
   SEITE 2: LOGO IM DRUCK GRÖSSER
   Screen bleibt UNVERÄNDERT
   ========================= */

/* Druck – Seite 2 Logo bewusst größer */
@media print{
  .print-only-offer-header::after{
    transform: scale(0.45) translateY(-6px) !important;
    transform-origin: top right !important;
  }
}
</style>


<style id="hetec-logo-page2-print-plus2">
/* =========================
   SEITE 2: LOGO IM DRUCK +2
   ========================= */
@media print{
  .print-only-offer-header::after{
    /* vorher 0.45 -> jetzt +2 Schritte */
    transform: scale(0.49) translateY(-6px) !important;
    transform-origin: top right !important;
  }
}
</style>


<style id="hetec-logo-page2-print-match-screen">
/* =========================
   SEITE 2: DRUCK = SCREEN-GRÖSSE MATCHEN
   ========================= */
@media print{
  .print-only-offer-header::after{
    /* Screen-Wirkung nachstellen */
    transform: scale(0.55) translateY(-6px) !important;
    transform-origin: top right !important;
  }
}
</style>


<style id="hetec-logo-page2-print-plus2-final">
/* =========================
   SEITE 2: LOGO IM DRUCK +2 (FINAL)
   ========================= */
@media print{
  .print-only-offer-header::after{
    /* vorher 0.55 -> +2 Schritte */
    transform: scale(0.59) translateY(-6px) !important;
    transform-origin: top right !important;
  }
}
</style>


<style id="hetec-logo-page2-print-plus4-final">
/* =========================
   SEITE 2: LOGO IM DRUCK +4 (FINAL)
   ========================= */
@media print{
  .print-only-offer-header::after{
    /* vorher 0.59 -> +4 Schritte */
    transform: scale(0.63) translateY(-6px) !important;
    transform-origin: top right !important;
  }
}
</style>


<style id="jpeg-capture-style">
/* JPEG Capture Mode: show both pages, hide overlays */
.jpeg-capture-mode .footer-bar,
.jpeg-capture-mode .fixed.inset-0.z-50,
.jpeg-capture-mode .no-print { display:none !important; }

.jpeg-capture-mode html, 
.jpeg-capture-mode body, 
.jpeg-capture-mode #root { overflow: visible !important; height: auto !important; }

.jpeg-capture-mode .print-offer-view{
  display:block !important;
  position: relative !important;
  left:auto !important;
  top:auto !important;
  opacity:1 !important;
  z-index: 1 !important;
  height:auto !important;
  overflow: visible !important;
}

.jpeg-capture-mode .situation-view-wrapper{
  display:flex !important;
  height:auto !important;
  overflow: visible !important;
}
</style>


<style id="jpeg-capture-printlike">
/* JPEG Export: print-like rendering (ohne @media print) */
.jpeg-capture-mode *{
  -webkit-print-color-adjust: exact !important;
  print-color-adjust: exact !important;
}

/* Header wie im Druck (Buttons/Badges raus) */
.jpeg-capture-mode header{
  display:flex !important;
  padding:6px 10px !important;
  border-bottom:1px solid #e2e8f0 !important;
}
.jpeg-capture-mode header button,
.jpeg-capture-mode header .no-print,
.jpeg-capture-mode header span.bg-blue-600{ display:none !important; }

/* Seite 2 Header sichtbar */
.jpeg-capture-mode .print-only-offer-header{ display:flex !important; }

/* Modals/Overlays ausblenden */
.jpeg-capture-mode .fixed.inset-0.z-50,
.jpeg-capture-mode .no-print,
.jpeg-capture-mode .footer-bar{
  display:none !important;
}

/* Seite 1/2: kein Clipping/Scroll-Container beim Capture */
.jpeg-capture-mode html,
.jpeg-capture-mode body,
.jpeg-capture-mode #root{
  overflow: visible !important;
  height: auto !important;
}

.jpeg-capture-mode .situation-view-wrapper,
.jpeg-capture-mode .print-offer-view{
  overflow: visible !important;
  height: auto !important;
  max-height: none !important;
}

/* Typische Tailwind-Overflow-Klassen neutralisieren */
.jpeg-capture-mode .overflow-hidden,
.jpeg-capture-mode .overflow-y-auto,
.jpeg-capture-mode .overflow-x-auto{
  overflow: visible !important;
  height: auto !important;
  max-height: none !important;
}

/* "Eingabe..." & andere Placeholders im JPEG ausblenden */
.jpeg-capture-mode .situation-view-wrapper input::placeholder,
.jpeg-capture-mode .situation-view-wrapper textarea::placeholder{
  color: transparent !important;
  -webkit-text-fill-color: transparent !important;
}

/* Auch Seite 2 Placeholders ausblenden */
.jpeg-capture-mode .print-offer-view input::placeholder,
.jpeg-capture-mode .print-offer-view textarea::placeholder{
  color: transparent !important;
  -webkit-text-fill-color: transparent !important;
}

/* Inputs im JPEG immer sichtbar (auch wenn Stiftmodus sie transparent macht) */
.jpeg-capture-mode .situation-view-wrapper input,
.jpeg-capture-mode .situation-view-wrapper textarea{
  color: #0f172a !important;
  -webkit-text-fill-color: #0f172a !important;
  opacity: 1 !important;
  text-shadow: none !important;
}

/* Optional: leichter Druck-Look (wie print zoom) */
.jpeg-capture-mode .situation-view-wrapper{ zoom: 1.0; }
.jpeg-capture-mode .print-offer-view{ zoom: 1.0; }
</style>


<style id="print-stamp-qr-fix">
@media print {
  /* Fix: Print-CSS reduziert .h-12 -> QR passt sonst nicht in den Kasten */
  .print-page-2 .stamp-box{
    height: 34px !important; /* leicht größer als globales 28px */
    padding-top: 2px !important;
    padding-bottom: 2px !important;
  }
  .print-page-2 .stamp-qr{
    width: 26px !important;
    height: 26px !important;
    display: block !important;
  }
  .print-page-2 .stamp-text{
    font-size: 9px !important;
    line-height: 1.05 !important;
  }
}
</style>

<style id="print-signature-center">
@media print {
  /* Kunden-Unterschrift (Seite 2): weniger Linienplatz + zentriert */
  .print-page-2 .signature-box{
    width: 70% !important;           /* kürzere Linie */
    margin-left: auto !important;
    margin-right: auto !important;
    justify-content: center !important;
  }
  .print-page-2 .signature-box .signature-img{
    object-position: center bottom !important; /* statt rechts */
  }

  /* Sicherheitsnetz: falls Tailwind-Klasse greift */
  .print-page-2 .object-right-bottom{
    object-position: center bottom !important;
  }
}
</style>

<style id="print-align-agent-date-stamp-signature">
@media print {
  /* WICHTIG: In dieser Abschluss-Zeile NICHT bottom-alignen (items-end),
     sonst rutschen Felder mit abweichender Label-Höhe nach unten */
  .print-page-2 .grid.items-end{
    align-items: flex-start !important;
  }

  /* Abschluss-Zeile: Agent / Datum / Stempel / Unterschrift exakt auf gleiche Feldhöhe bringen */
  .print-page-2 .stamp-box,
  .print-page-2 .signature-box,
  .print-page-2 .signature-placeholder,
  .print-page-2 .paper-signature-box{
    height: 28px !important;              /* match print-page-2 .h-12 override */
    min-height: 28px !important;
    max-height: 28px !important;
  }

  /* Stempel: Innenabstände im Druck reduzieren + QR sicher innerhalb */
  .print-page-2 .stamp-box{
    padding-left: 8px !important;
    padding-right: 8px !important;
    gap: 8px !important;
    align-items: center !important;
  }
  .print-page-2 .stamp-qr{
    width: 24px !important;
    height: 24px !important;
  }
  .print-page-2 .stamp-text{
    line-height: 1.05 !important;
    margin-top: 0 !important;
  }

  /* Unterschrift: kein extra Padding, Signatur mittig im Feld */
  .print-page-2 .signature-box{
    padding: 0 !important;               /* remove p-1 in print */
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
  }
  .print-page-2 .signature-img{
    max-height: 24px !important;
    width: 100% !important;
    object-fit: contain !important;
    object-position: center bottom !important;
  }

  /* Placeholder & Papier-Variante gleich behandeln */
  .print-page-2 .signature-placeholder,
  .print-page-2 .paper-signature-box{
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    padding: 0 8px !important;
  }

  /* Labels in dieser Zeile kompakt, damit alles gleich wirkt */
  .print-page-2 label{
    margin-bottom: 2px !important;
    white-space: nowrap !important;
  }
}
</style>


<style id="final-hide-signature-toast">
/* FINAL: Signature-Toast nie anzeigen (Screen + Print + Export) */
.fixed.bottom-4.left-1\/2.-translate-x-1\/2.z-\[100\].bg-slate-900,
.fixed.bottom-4.left-1\/2.-translate-x-1\/2.z-\[100\],
.toast, .toast-message, [class*="toast"], [class*="Toast"]{
  display:none !important;
  visibility:hidden !important;
  opacity:0 !important;
}
</style>


<style id="ink-overlay-hide-placeholder">
/* Wenn Handschrift-Overlay aktiv ist: Text + Placeholder im Feld ausblenden */
.ink-hide{
  color: transparent !important;
  -webkit-text-fill-color: transparent !important;
  caret-color: transparent !important;
}
.ink-hide::placeholder{
  color: transparent !important;
  -webkit-text-fill-color: transparent !important;
}
</style>


<style id="print-force-remove-blue-canvas-final">
@media print {
  /* FINAL HARD FIX:
     Entfernt JEDEN hellblauen Hintergrund im Bereich
     "Ihre Aktuelle Situation", egal ob Popup, Canvas,
     Inline-Style oder Tailwind /xx */
  .situation-view-wrapper,
  .situation-view-wrapper * {
    background-color: transparent !important;
    background-image: none !important;
  }

  /* ABER: Karten & Boxen sollen weiß bleiben */
  .situation-view-wrapper .bg-white,
  .situation-view-wrapper aside,
  .situation-view-wrapper aside * {
    background-color: #ffffff !important;
  }
}
</style>

<style id="print-hide-blue-kasten-v2">
@media print{
  /* Der "blaue Kasten" ist die große Zeichenfläche (Canvas-Layer) – im Druck komplett ausblenden */
  .situation-view-wrapper .canvas-layer,
  .situation-view-wrapper canvas{
    display:none !important;
    visibility:hidden !important;
    opacity:0 !important;
  }
  /* falls die Fläche über ein Wrapper-DIV kommt: Hintergrund neutralisieren */
  .situation-view-wrapper .canvas-layer *{
    background:transparent !important;
  }
}

/* Auch im Print-like JPEG Export (jpeg-capture-mode) ausblenden */
.jpeg-capture-mode .situation-view-wrapper .canvas-layer,
.jpeg-capture-mode .situation-view-wrapper canvas{
  display:none !important;
  visibility:hidden !important;
  opacity:0 !important;
}
</style>

</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect, useMemo, useCallback } = React;

        // --- 0. ICONS ---
        const Icon = ({ d, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <g dangerouslySetInnerHTML={{ __html: d }} />
            </svg>
        );

        const ICONS = {
            Search: '<circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/>',
            User: '<path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>',
            Activity: '<path d="M22 12h-4l-3 9L9 3l-3 9H2"/>',
            Smartphone: '<rect width="14" height="20" x="5" y="2" rx="2" ry="2"/><path d="M12 18h.01"/>',
            Plus: '<path d="M5 12h14"/><path d="M12 5v14"/>',
            Home: '<path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>',
            Monitor: '<rect width="20" height="14" x="2" y="3" rx="2"/><line x1="8" x2="16" y1="21" y2="21"/><line x1="12" x2="12" y1="17" y2="21"/>',
            Cast: '<path d="M2 16.1A5 5 0 0 1 5.9 20"/><path d="M2 12.05A9 9 0 0 1 9.95 20"/><path d="M2 8V6a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2h-6"/><line x1="2" x2="2.01" y1="20" y2="20"/>',
            Menu: '<line x1="4" y1="12" x2="20" y2="12"/><line x1="4" y1="6" x2="20" y2="6"/><line x1="4" y1="18" x2="20" y2="18"/>',
            Wallet: '<path d="M20 12V8H6a2 2 0 0 1-2-2c0-1.1.9-2 2-2h12v4"/><path d="M4 6v12c0 1.1.9 2 2 2h14v-4"/><path d="M18 12a2 2 0 0 0 0 4h4v-4z"/>',
            X: '<path d="M18 6 6 18"/><path d="m6 6 18 18"/>',
            Pen: '<path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>',
            Keyboard: '<rect width="20" height="16" x="2" y="4" rx="2"/><path d="M12 18h.01"/><path d="M8 8h.01"/><path d="M12 8h.01"/><path d="M16 8h.01"/><path d="M8 12h.01"/><path d="M12 12h.01"/><path d="M16 12h.01"/><path d="M8 16h.01"/><path d="M12 16h.01"/><path d="M16 16h.01"/>',
            Eraser: '<path d="m2.9 15.8a2.9 2.9 0 0 0 9.9 0l5.6-5.6a2.9 2.9 0 0 0-4.2-4.2l-5.6 5.6c-.4.4-.5 1.05-.2 1.6"/><path d="m11 7 5.3 5.3"/><path d="M22 21H7"/>',
            Palette: '<circle cx="13.5" cy="6.5" r=".5" fill="currentColor"/><circle cx="17.5" cy="10.5" r=".5" fill="currentColor"/><circle cx="8.5" cy="7.5" r=".5" fill="currentColor"/><circle cx="6.5" cy="12.5" r=".5" fill="currentColor"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"/>',
            Wifi: '<path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" x2="12.01" y1="20" y2="20"/>',
            Zap: '<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>',
            Globe: '<circle cx="12" cy="12" r="10"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10z"/><path d="M2 12h20"/>',
            Gauge: '<path d="m12 15 3.5-3.5"/><path d="M20.3 18c.6-1 .9-2.2.9-3.5a9 9 0 1 0-9 9c1.3 0 2.5-.3 3.5-.9"/>',
            Calculator: '<rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/>',
            ArrowRight: '<path d="M5 12h14"/><path d="m12 5 7 7-7 7"/>',
            ArrowLeft: '<path d="m12 19-7-7 7-7"/><path d="M19 12H5"/>',
            Highlighter: '<path d="m9 11-6 6v3h9l3-3"/><path d="m22 12-4.6-4.6a2 2 0 0 0-2.8 0l-5.2 5.2a2 2 0 0 0 0 2.8l4.6 4.6"/><path d="m5.7 5.7 3.1 3.1"/>',
            FileText: '<path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y1="9"/>',
            CheckCircle: '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/>',
            AlertCircle: '<circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/>',
            Phone: '<path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>',
            Tv: '<rect width="20" height="15" x="2" y="7" rx="2" ry="2"/><polyline points="17 2 12 7 7 2"/>',
            Router: '<rect width="20" height="8" x="2" y="14" rx="2"/><path d="M6.01 18h.01"/><path d="M10.01 18h.01"/><path d="M15 10v4"/><path d="M17.84 7.17a4 4 0 0 0-5.66 0"/><path d="M20.66 4.34a8 8 0 0 0-11.31 0"/>',
            Layers: '<path d="m12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83Z"/><path d="m22 17.65-9.17 4.16a2 2 0 0 1-1.66 0L2 17.65"/><path d="m22 12.65-9.17 4.16a2 2 0 0 1-1.66 0L2 12.65"/>',
            Disc: '<circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/>',
            Lock: '<rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>',
            Trash: '<path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>',
            Bold: '<path d="M6 4h8a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"/><path d="M6 12h9a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"/>',
            Italic: '<line x1="19" y1="4" x2="10" y2="4"/><line x1="14" y1="20" x2="5" y2="20"/><line x1="15" y1="4" x2="9" y1="20"/>',
            Type: '<polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/>',
            List: '<line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line>',
            Clipboard: '<rect x="9" y="4" width="6" height="6" rx="1"/><path d="M15 8h.01"/><path d="M15 12h.01"/><path d="M15 16h.01"/><path d="M9 8h.01"/><path d="M9 12h.01"/><path d="M9 16h.01"/><rect x="3" y="2" width="18" height="20" rx="2"/>',
            Sun: '<circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/>',
            Users: '<path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>',
            Maximize: '<path d="M8 3v3a2 2 0 0 1-2 2H3"/><path d="M21 8h-3a2 2 0 0 1-2-2V3"/><path d="M3 16h3a2 2 0 0 1 2 2v3"/><path d="M16 21v-3a2 2 0 0 1 2-2h3"/>',
            Minimize: '<path d="M8 3v3a2 2 0 0 1-2 2H3"/><path d="M21 8h-3a2 2 0 0 1-2-2V3"/><path d="M3 16h3a2 2 0 0 1 2 2v3"/><path d="M16 21v-3a2 2 0 0 1 2-2h3"/>', 
            ZoomIn: '<circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/>', 
            ZoomOut: '<circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="8" y1="11" x2="14" y2="11"/>', 
            RotateCcw: '<path d="M3 6.02v0a8 8 0 1 0 17.65 4.39"/>', 
            Camera: '<path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/>',
            Folder: '<path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>', 
            RefreshCw: '<path d="M21 2v6h-6"/><path d="M21 13a9 9 0 1 1-3-7.7L21 8"/>', 
            Square: '<rect width="18" height="18" x="3" y="3" rx="2" ry="2"/>',
            Book: '<path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1-2.5-2.5zM20 18H6.5a.5.5 0 0 0-.5.5V20h14z"/>',
            Signature: '<path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>', 
            Share: '<path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" x2="12" y1="2" y2="15"/>',
            EraserLine: '<path d="m5 20 5-5-2-2-5 5-2 2z"/><path d="M22 12 18 8 14 12 18 16Z"/><path d="M5 20 9 16"/><path d="M18 8 22 12"/>',
            Gift: '<polyline points="20 12 20 22 4 22 4 12"/><rect x="2" y="7" width="20" height="5"/><line x1="12" y1="22" x2="12" y2="7"/><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/>',
            Printer: '<polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect>'
        };

        
        // --- SHARE HINT (Desktop) ---
        const showDesktopShareHint = () => {
            // avoid duplicates
            const existing = document.getElementById('shareHintOverlay');
            if (existing) return;
            const overlay = document.createElement('div');
            overlay.id = 'shareHintOverlay';
            overlay.className = 'fixed inset-0 z-[99999] flex items-center justify-center bg-black/40 p-4';
            overlay.innerHTML = `
              <div class="w-full max-w-md bg-white rounded-2xl shadow-2xl border border-slate-200 p-5">
                <div class="flex items-start gap-3">
                  <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-700 font-black">i</div>
                  <div class="flex-1">
                    <div class="text-lg font-black text-slate-900 mb-1">Teilen am PC</div>
                    <div class="text-sm text-slate-700 leading-relaxed">
                      <strong>Windows unterstützt das direkte Teilen aus dem Browser oft nicht.</strong><br/>
                      Die JPEG-Dateien wurden gespeichert. Jetzt in Outlook/WhatsApp einfach anhängen.
                    </div>
                    <div class="mt-3 text-xs text-slate-500">
                      Tipp: Outlook → Neue E‑Mail → Büroklammer → <span class="font-mono">Angebot_Seite1.jpg</span> & <span class="font-mono">Angebot_Seite2.jpg</span>.
                    </div>
                  </div>
                </div>
                <div class="mt-4 flex gap-2 justify-end">
                  <button id="shareHintOk" class="px-4 py-2 rounded-xl bg-slate-900 text-white font-bold hover:bg-slate-800">OK</button>
                </div>
              </div>
            `;
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) overlay.remove();
            });
            document.body.appendChild(overlay);
            const okBtn = overlay.querySelector('#shareHintOk');
            if (okBtn) okBtn.addEventListener('click', () => overlay.remove());
        };

// --- 1. DATA CONFIG ---
        const ALL_LANGUAGES = [{code:'de',name:'Deutsch',flag:'🇩🇪',languageCode:'de'},{code:'ar',name:'Arabisch',flag:'🇸🇦',languageCode:'ar'},{code:'en',name:'Englisch',flag:'🇬🇧',languageCode:'en'},{code:'el',name:'Griechisch',flag:'🇬🇷',languageCode:'el'},{code:'it',name:'Italienisch',flag:'🇮🇹',languageCode:'it'},{code:'pl',name:'Polnisch',flag:'🇵🇱',languageCode:'pl'},{code:'pt',name:'Portugiesisch',flag:'🇵🇹',languageCode:'pt'},{code:'ro',name:'Rumänisch',flag:'🇷🇴',languageCode:'ro'},{code:'es',name:'Spanisch',flag:'🇪🇸',languageCode:'es'},{code:'tr',name:'Türkisch',flag:'🇹🇷',languageCode:'tr'}];
        const SORTED_LANGUAGES = [ALL_LANGUAGES.find(l=>l.code==='de'),...ALL_LANGUAGES.filter(l=>l.code!=='de').sort((a,b)=>a.name.localeCompare(b.name))];
        const SITUATION_ITEMS = [
            { id: 'Kundenname', label: 'Kundenname', icon: ICONS.Search }, { id: 'Rufnummer', label: 'Rufnummer', icon: ICONS.User }, { id: 'Anbieter', label: 'Anbieter', icon: ICONS.Activity }, { id: 'Hardware', label: 'Hardware', icon: ICONS.Smartphone },
            { id: 'Nutzung', label: 'Nutzung', icon: ICONS.Plus }, { id: 'Haushalt', label: 'Haushalt', icon: ICONS.Home }, { id: 'Weitere Produkte', label: 'Weitere Produkte', icon: ICONS.Monitor }, { id: 'Fernsehen', label: 'Fernsehen', icon: ICONS.Cast },
            { id: 'WiFi', label: 'WiFi', icon: ICONS.Menu }, { id: 'Gesamtkosten', label: 'Gesamtkosten', icon: ICONS.Wallet }
        ];
        
        const STATIC_LABELS = { 
            'Offer1Title': '1. Hardware, Anbieter & Nutzung', 
            'Offer2Title': '2. Haushalt und weitere Produkte', 
            'Offer3Title': '3. Fernsehen & Wi-Fi', 
            'CostHeader': 'Kostenübersicht & Abschluss', 'CostEinmalig': 'EINMALIG (€)', 'CostMonatlich1': 'MONATLICH IM 1. JAHR (€)', 'CostMonatlich2': 'MONATLICH IM 2. JAHR (€)', 'AgentLabel': 'PERSÖNLICHER AGENT', 'DateLabel': 'DATUM', 'Kundenname_Label': 'Kundenname', 'Rufnummer_Label': 'Rufnummer', 'Anbieter_Label': 'Anbieter', 'Hardware_Label': 'Hardware', 'Nutzung_Label': 'Nutzung', 'Haushalt_Label': 'Haushalt', 'Weitere Produkte_Label': 'Weitere Produkte', 
            'Fernsehen_Label': 'Fernsehen', 'WiFi_Label': 'WiFi', 'Gesamtkosten_Label': 'Gesamtkosten', 'StatusOpen': 'Offen', 'StatusClosed': 'Abgeschlossen', 'StatusNeutral': 'Neutral'
        };
        
        const INITIAL_QUESTIONS_DATA = { 'Kundenname': ["Wie lautet der Name?", "Rechnungsempfänger?", "Bestandskunde?"], 'Rufnummer': ["Rufnummer behalten?", "Portierung?", "Multi-SIM?"], 'Anbieter': ["Welcher Anbieter?", "Laufzeit?", "Gekündigt?"], 'Hardware': ["Aktuelles Handy?", "iOS oder Android?", "Kamera wichtig?", "Zubehör?", "Kaufdatum?"], 'Nutzung': ["Datenvolumen?", "Ausland?", "Hotspot?", "Streaming?", "5G?"], 'Haushalt': ["Personenanzahl?", "Geräte im WLAN?", "Jugendschutz?", "Smarthome?", "Partnerkarte?"], 'Weitere Produkte': ["Smartwatch?", "Tablet?", "Versicherung?", "Cloud?", "Music?"], 'Fernsehen': ["Streaming?", "Lineares TV?", "HD?", "Aufnahme?", "Mobile TV?"], 'WiFi': ["Empfang?", "Repeater?", "Router Standort?", "Wände?", "Geschwindigkeit?"], 'Gesamtkosten': ["Aktuelle Kosten?", "Budget?", "Mehrleistung?", "Zahlungsweise?", "Preisgarantie?"], 'default': ["Offene Fragen?", "Details?"] };
        const COLORS = [{ id: 'black', value: '#000000', label: 'Schwarz' }, { id: 'pencil', value: '#374151', label: 'Bleistift' }, { id: 'blue', value: '#0044ff', label: 'Blau' }, { id: 'red', value: '#ff0000', label: 'Rot' }, { id: 'green', value: '#00cc00', label: 'Grün' }, { id: 'yellow', value: '#ffcc00', label: 'Gelb' }, { id: 'pink', value: '#ff00cc', label: 'Rosa' }, { id: 'purple', value: '#8800ff', label: 'Lila' }];
        const STROKE_SIZES = [{ id: 1, width: 2, label: 'Dünn' }, { id: 2, width: 4, label: 'Mittel' }, { id: 3, width: 8, label: 'Dick' }];
        
        // --- MOCK TRANSLATION DATA (Lokale Simulation) ---
        const MOCK_TRANSLATIONS = {
            // English (en)
            en: {
                // Static Labels
                Offer1Title: '1. Hardware, Provider & Usage',
                Offer2Title: '2. Household and other products',
                Offer3Title: '3. TV & Wi-Fi',
                CostHeader: 'Cost Overview & Conclusion',
                CostEinmalig: 'ONE-TIME (€)',
                CostMonatlich1: 'MONTHLY IN 1ST YEAR (€)',
                CostMonatlich2: 'MONTHLY IN 2ND YEAR (€)',
                AgentLabel: 'PERSONAL AGENT',
                DateLabel: 'DATE',
                Kundenname_Label: 'Customer Name',
                Rufnummer_Label: 'Phone Number',
                Anbieter_Label: 'Provider',
                Hardware_Label: 'Hardware',
                Nutzung_Label: 'Usage',
                Haushalt_Label: 'Household',
                'Weitere Produkte_Label': 'Other Products',
                Fernsehen_Label: 'Television',
                WiFi_Label: 'WiFi',
                Gesamtkosten_Label: 'Total Cost',
                StatusOpen: 'Open',
                StatusClosed: 'Closed',
                StatusNeutral: 'Neutral',
                // Dynamic Text Data (Mocked content)
                AgentName: 'Max Sampleman',
                DateValue: new Date().toLocaleDateString('en-US', { year: 'numeric', month: '2-digit', day: '2-digit' }),
                offer1: 'Example text for Offer 1: Mobile plan with unlimited data and new smartphone included.',
                offer2: 'Example text for Offer 2: Internet 1000 MBit/s fiber connection and additional devices.',
                offer3: 'Example text for Offer 3: TV streaming package and Mesh Wi-Fi solution for the entire house.',
            },
            // Spanish (es) - partial translation
            es: {
                // Static Labels
                Offer1Title: '1. Hardware, Proveedor y Uso',
                Offer2Title: '2. Hogar y otros productos',
                CostHeader: 'Resumen de Costos y Cierre',
                CostEinmalig: 'PAGO ÚNICO (€)',
                AgentLabel: 'AGENTE PERSONAL',
                Kundenname_Label: 'Nombre del Cliente',
                // Dynamic Text Data (Mocked content)
                AgentName: 'Max Muestras',
                offer1: 'Texto de ejemplo para Oferta 1 en español.',
            }
        };

        const SectionCard = ({ title, children, className = "" }) => (<div className={`bg-white p-3 rounded-xl border border-slate-200 shadow-sm ${className}`}><h3 className="font-bold text-slate-800 mb-2 text-[10px] uppercase tracking-wide text-slate-500 flex items-center gap-2 shrink-0">{title}</h3><div className="flex-1 min-h-0 flex flex-col justify-center">{children}</div></div>);
        const copyToClipboard = (text) => { const ta = document.createElement("textarea"); ta.value = text; document.body.appendChild(ta); document.execCommand("copy"); document.body.removeChild(ta); };
        // NOTE: fetchWithRetry is removed as we are using local mock translation now.

        // --- MODALS ---
        const ImagePlacementModal = ({ isOpen, onClose, onPlace, imageName }) => { if (!isOpen) return null; const handleSelect = (key) => { onPlace(key); }; return (<div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4 animate-in fade-in"><div className="bg-white w-full max-w-lg rounded-2xl shadow-2xl p-6 relative border border-slate-200"><h3 className="text-xl font-black text-slate-800 mb-2 flex items-center gap-2"><Icon d={ICONS.Folder} size={24} className="text-blue-600"/> Bild platzieren</h3><p className="text-sm text-slate-600 mb-6">Wählen Sie den Abschnitt, in den das Bild "<span className="font-bold truncate">{imageName}</span>" eingefügt werden soll.</p><div className="grid grid-cols-3 gap-4">{['offer1', 'offer2', 'offer3'].map((key, index) => (<button key={key} onClick={() => handleSelect(key)} className="p-4 bg-slate-50 border border-slate-200 rounded-xl text-center hover:bg-blue-100 transition-colors flex flex-col items-center justify-center min-h-[100px]"><Icon d={index === 0 ? ICONS.Smartphone : index === 1 ? ICONS.Users : ICONS.Router} size={30} className="text-slate-500 mb-1"/><span className="font-bold text-slate-700 text-sm">{index + 1}. Angebot</span></button>))}</div><div className="flex justify-end mt-6"><button onClick={() => onClose(true)} className="px-4 py-2 text-slate-500 font-medium hover:bg-slate-100 rounded-lg transition-colors">Abbrechen</button></div></div></div>); };
        
        // Modal für die Kundenunterschrift (SignatureModal) MIT PAPIER-OPTION
        const SignatureModal = ({ isOpen, onClose, onSign }) => {
            const canvasRef = useRef(null);
            const isDrawingRef = useRef(false);
            const lastPointerIdRef = useRef(null);
            const [hasSigned, setHasSigned] = useState(false);

            // ✅ Pixelgenaues Mapping: ausschließlich über getBoundingClientRect()
            const getPoint = (e, canvas) => {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                return { x, y };
            };

            const setupCanvas = useCallback(() => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                const rect = canvas.getBoundingClientRect();
                const dpr = window.devicePixelRatio || 1;

                // Set internal buffer size (keine doppelte DPR-Skalierung!)
                const w = Math.max(1, Math.round(rect.width * dpr));
                const h = Math.max(1, Math.round(rect.height * dpr));
                if (canvas.width !== w || canvas.height !== h) {
                    canvas.width = w;
                    canvas.height = h;
                }

                const ctx = canvas.getContext('2d');
                // Wichtig: Transform *ersetzen* (nicht addieren)
                ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 3; // in CSS-Pixel
            }, []);

            const clearCanvas = useCallback(() => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                ctx.save();
                ctx.setTransform(1, 0, 0, 1, 0, 0);
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.restore();
                setHasSigned(false);
                isDrawingRef.current = false;
                lastPointerIdRef.current = null;
            }, []);

            const startDrawing = (e) => {
                const canvas = canvasRef.current;
                if (!canvas) return;

                // Nur primärer Pointer (keine Rechtsklicks)
                if (e.button !== undefined && e.button !== 0) return;

                e.preventDefault();

                // PointerEvents = eine Quelle für Maus/Touch/Pen
                canvas.setPointerCapture(e.pointerId);
                lastPointerIdRef.current = e.pointerId;
                isDrawingRef.current = true;

                const { x, y } = getPoint(e, canvas);
                const ctx = canvas.getContext('2d');
                ctx.beginPath();
                ctx.moveTo(x, y);
                setHasSigned(true);
            };

            const draw = (e) => {
                if (!isDrawingRef.current) return;
                const canvas = canvasRef.current;
                if (!canvas) return;

                // nur der Pointer, der auch gestartet hat
                if (lastPointerIdRef.current !== null && e.pointerId !== lastPointerIdRef.current) return;

                e.preventDefault();
                const { x, y } = getPoint(e, canvas);
                const ctx = canvas.getContext('2d');
                ctx.lineTo(x, y);
                ctx.stroke();
            };

            const stopDrawing = (e) => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                if (!isDrawingRef.current) return;

                e.preventDefault();
                try { canvas.releasePointerCapture(e.pointerId); } catch (err) {}
                isDrawingRef.current = false;
                lastPointerIdRef.current = null;
            };

            const handleSave = () => {
                const canvas = canvasRef.current;
                if (!canvas || !hasSigned) return;
                // PNG ist sauber für Signatur
                const dataUrl = canvas.toDataURL('image/png');
                onSign(dataUrl);
                onClose();
            };

            const handlePaperSignature = () => { onSign('PAPER_SIGNATURE'); onClose(); };

            useEffect(() => {
                if (!isOpen) return;

                let cancelled = false;
                let raf1 = 0, raf2 = 0, raf3 = 0;
                let ro = null;

                const runSetup = () => {
                    if (cancelled) return;
                    setupCanvas();
                };

                // 1) Sofort + 2 Frames später erneut (Modal-Layout/Animation/Fonts brauchen oft 1–2 Frames)
                runSetup();
                raf1 = requestAnimationFrame(() => {
                    runSetup();
                    raf2 = requestAnimationFrame(runSetup);
                });

                // 2) Wenn Fonts nachladen (selten, aber möglich), danach nochmals sauber setzen
                if (document.fonts && document.fonts.ready) {
                    document.fonts.ready.then(() => {
                        if (cancelled) return;
                        raf3 = requestAnimationFrame(runSetup);
                    }).catch(() => {});
                }

                // 3) Resize: Window + Element (falls Container durch Layout/Zoom/Keyboard ändert)
                const onResize = () => {
                    runSetup();
                    requestAnimationFrame(runSetup);
                };
                window.addEventListener('resize', onResize, { passive: true });

                const canvas = canvasRef.current;
                if (canvas && typeof ResizeObserver !== 'undefined') {
                    ro = new ResizeObserver(() => onResize());
                    ro.observe(canvas);
                    if (canvas.parentElement) ro.observe(canvas.parentElement);
                }

                return () => {
                    cancelled = true;
                    window.removeEventListener('resize', onResize);
                    if (ro) try { ro.disconnect(); } catch (e) {}
                    if (raf1) cancelAnimationFrame(raf1);
                    if (raf2) cancelAnimationFrame(raf2);
                    if (raf3) cancelAnimationFrame(raf3);
                };
            }, [isOpen, setupCanvas]);

            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/70 backdrop-blur-sm p-4 animate-in fade-in">
                    <div className="bg-white w-full max-w-xl rounded-2xl shadow-2xl p-6 relative border border-slate-200">
                        <h3 className="text-xl font-black text-slate-800 mb-2 flex items-center gap-2">
                            <Icon d={ICONS.Signature} size={24} className="text-green-600"/> Kundenunterschrift
                        </h3>
                        <p className="text-sm text-slate-600 mb-1">Bitte unterschreiben Sie mit Ihrem Finger oder Stylus in der dafür vorgesehenen Fläche.</p>
                        <button type="button" onClick={handlePaperSignature} className="text-xs text-slate-500 hover:text-slate-700 underline decoration-dotted mb-3">
                            Papier-Unterschrift – Kunde unterschreibt klassisch auf Papier und wir machen weiter
                        </button>

                        <div className="signature-canvas-container relative" style={{ touchAction: 'none' }}>
                            <canvas
                                ref={canvasRef}
                                className="absolute inset-0 w-full h-full cursor-crosshair"
                                style={{ touchAction: 'none' }}
                                onPointerDown={startDrawing}
                                onPointerMove={draw}
                                onPointerUp={stopDrawing}
                                onPointerCancel={stopDrawing}
                                onPointerLeave={stopDrawing}
                            />
                        </div>

                        <div className="flex justify-between items-center mt-4">
                            <button onClick={clearCanvas} className="px-4 py-2 text-slate-500 font-medium hover:bg-slate-100 rounded-lg transition-colors flex items-center gap-2" disabled={!hasSigned}>
                                <Icon d={ICONS.Trash} size={16}/> Löschen
                            </button>
                            <div className="flex gap-2">
                                <button onClick={() => onClose(true)} className="px-4 py-2 text-slate-500 font-medium hover:bg-slate-100 rounded-lg transition-colors">Abbrechen</button>
                                <button onClick={handleSave} className={`px-6 py-2 rounded-lg font-bold shadow-md transition-all flex items-center gap-2 ${hasSigned ? 'bg-green-600 text-white hover:bg-green-700' : 'bg-slate-300 text-slate-500 cursor-not-allowed'}`} disabled={!hasSigned}>
                                    Übernehmen <Icon d={ICONS.CheckCircle} size={16}/>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- REFERRAL MODAL (Neu hinzugefügt/wiederhergestellt) --- (Neu hinzugefügt/wiederhergestellt) ---
        const ReferralModal = ({ isOpen, onClose, onPrint, onPdfShare, onJpegShare }) => {
            if (!isOpen) return null;
            const handlePrintAction = () => {
                onClose();
                setTimeout(() => onPrint(), 300);
            };

            const handlePdfAction = () => {
                onClose();
                setTimeout(() => { try { onPdfShare && onPdfShare(); } catch(e){} }, 320);
            };
return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4 animate-in fade-in">
                    <div className="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 relative border border-slate-200 flex flex-col items-center text-center">
                        <div className="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mb-4 text-purple-600">
                            <Icon d={ICONS.Gift} size={32}/>
                        </div>
                        <h3 className="text-2xl font-black text-slate-800 mb-2">Angebot Teilen</h3>
                        <p className="text-sm text-slate-600 mb-6 leading-relaxed">
                            Empfehlen Sie uns weiter! Für jeden geworbenen Neukunden erhalten Sie eine <strong>50€ Prämie</strong> gutgeschrieben.
                        </p>
{/* Freunde-werben-Freunde: Link wird NICHT angezeigt (kann später leicht ersetzt werden) */}
<button
    onClick={() => {
        const REFERRAL_URL = 'https://empfehlen.de/u/kunden-id'; // später hier ersetzen
        try { window.open(REFERRAL_URL, '_blank', 'noopener,noreferrer'); } catch (e) {
                                        document.documentElement.classList.remove('export-mode');}
    }}
    className="w-full bg-slate-50 border border-slate-200 rounded-xl p-4 mb-6 flex items-center gap-3 hover:bg-slate-100 transition-colors text-left"
    title="Freunde werden Freunde öffnen"
>
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-slate-500 shrink-0">
        <g>
            <rect width="18" height="11" x="3" y="11" rx="2" ry="2"></rect>
            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
        </g>
    </svg>
    <span className="text-sm font-bold text-slate-700 flex-1">Freunde werden Freunde öffnen</span>
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-slate-400">
        <path d="M5 12h14"/><path d="m12 5 7 7-7 7"/>
    </svg>
</button>

                        <div className="flex flex-col w-full gap-3">
                            <button onClick={handlePdfAction} className="w-full py-3 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700 transition-colors shadow-lg flex items-center justify-center gap-2">
    PDF direkt teilen (WhatsApp/Mail) <Icon d={ICONS.ArrowRight} size={18}/>
</button>

<button onClick={handlePrintAction} className="w-full py-3 bg-white border border-slate-200 text-slate-800 font-bold rounded-xl hover:bg-slate-50 transition-colors shadow-sm flex items-center justify-center gap-2">
    PDF drucken / speichern <Icon d={ICONS.Printer} size={18}/>
</button>
<button onClick={onClose} className="w-full py-3 bg-slate-50 border border-slate-200 text-slate-700 font-bold rounded-xl hover:bg-slate-100 transition-colors">
                                Schließen
                            </button>

                        </div>
                    </div>
                </div>
            );
        };

        const WlanModal=({isOpen,onClose,triggerToast,onCopyRecommendation})=>{const[floors,setFloors]=useState(2);const[router,setRouter]=useState('eg');const[needs,setNeeds]=useState(new Set(['eg','og1']));const[thickWalls,setThickWalls]=useState(false);const toggleNeed=(f)=>setNeeds(prev=>prev.has(f)?new Set([...prev].filter(x=>x!==f)):new Set([...prev,f]));const{sugg,reason,badgeId}=useMemo(()=>{let s='Repeater';let r='Standard zur Flächenabdeckung';let b='bRep';if(floors>2){s='Mesh / Powerline';r='Größere Fläche';b='bMesh';}if(thickWalls){s='Repeater';r='Dicke Wände (Verstärkung notwendig)';b='bRep';}return{sugg:s,reason:r,badgeId:b};},[floors,router,needs,thickWalls]);const yForFloor=(f)=>{if(f==='keller')return 495;const houseBottom=460;const houseHeight=300;const floorHeight=houseHeight/floors;let index=0;if(f==='eg')index=0;else if(f==='og1')index=1;else if(f==='og2')index=2;else if(f==='dg')index=floors-1;return houseBottom-(index*floorHeight)-(floorHeight/2);};const handleCopy=()=>{const txt=`Empfehlung: ${sugg} (${reason})`;copyToClipboard(txt);triggerToast('WLAN-Empfehlung kopiert!');try{onCopyRecommendation&&onCopyRecommendation(txt);}catch(e){};};if(!isOpen)return null;const availableFloors=['KELLER','EG'];if(floors>=2)availableFloors.push('OG1');if(floors>=3)availableFloors.push('DG');if(floors>=4){availableFloors[3]='OG2';availableFloors.push('DG');}return(<div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4 animate-in fade-in"><div className="bg-white w-full max-w-[1000px] max-h-[90vh] overflow-y-auto relative rounded-2xl border border-[#cbd5e1] shadow-2xl flex flex-col md:flex-row"><button onClick={onClose} className="absolute top-4 right-4 z-50 p-2 hover:bg-slate-100 rounded-full text-slate-500"><Icon d={ICONS.X} size={20}/></button><div className="w-full md:w-1/2 bg-blue-50/50 p-8 flex flex-col justify-center border-b md:border-b-0 md:border-r border-slate-100 relative"><div className="absolute top-4 left-4 text-slate-400 font-bold text-xs tracking-widest">VORSCHAU</div><svg viewBox="0 0 560 560" className="w-full h-auto house-svg drop-shadow-xl wlan-svg"><path d="M80 160 L280 70 L480 160" className="roof" strokeWidth="2"/><rect x="80" y="160" width="400" height="300" rx="12" className="house-body" strokeWidth="2"/>{Array.from({length:floors-1}).map((_,i)=><line key={i} x1="90" x2="470" y1={460-(300/floors)*(i+1)} y2={460-(300/floors)*(i+1)} className="floor-line" strokeWidth="2"/>)}<rect x="80" y="470" width="400" height="50" rx="8" className="keller" strokeWidth="2"/><text x="90" y="502" fontSize="12" fontWeight="700" fill="#64748b">Keller</text><defs><clipPath id="aboveClip"><rect x="80" y="160" width="400" height="300"/></clipPath><clipPath id="basementClip"><rect x="80" y="470" width="400" height="50"/></clipPath></defs><g clipPath="url(#aboveClip)">{router!=='keller'&&<g transform={`translate(140, ${yForFloor(router)-16})`}><rect x="-20" y="-12" width="40" height="24" rx="6" fill="#0f172a"/><circle cx="0" cy="-2" r="2" fill="#22c55e"/></g>}{Array.from(needs).filter(n=>n!=='keller').map(n=>(<g key={n} transform={`translate(390, ${yForFloor(n)-24})`} className="wifi-glow"><path d="M-10 -10 L0 0 L10 -10" stroke="#3b82f6" strokeWidth="3" fill="none"/><circle r="3" fill="#3b82f6"/></g>))}</g><g clipPath="url(#basementClip)">{router==='keller'&&<g transform={`translate(140, ${yForFloor('keller')-16})`}><rect x="-20" y="-12" width="40" height="24" rx="6" fill="#0f172a"/><circle cx="0" cy="-2" r="2" fill="#22c55e"/></g>}{needs.has('keller')&&<g transform={`translate(390, ${yForFloor('keller')-24})`} className="wifi-glow"><path d="M-10 -10 L0 0 L10 -10" stroke="#3b82f6" strokeWidth="3" fill="none"/><circle r="3" fill="#3b82f6"/></g>}</g></svg></div><div className="w-full md:w-1/2 p-8 overflow-y-auto relative"><h2 className="text-2xl font-black text-slate-800 mb-6 flex items-center gap-2"><Icon d={ICONS.Wifi} className="text-blue-600"/> WLAN Haus-Planer</h2><div className="space-y-6"><div><label className="block text-sm font-bold text-slate-700 mb-2">Anzahl Etagen</label><div className="flex gap-2">{[1,2,3,4].map(n=><button key={n} onClick={()=>setFloors(n)} className={`wlan-num wlan-chip ${floors===n?'toggled':''}`}>{n}</button>)}</div><label className="flex gap-2 items-center mt-2 cursor-pointer"><input type="checkbox" checked={thickWalls} onChange={(e)=>setThickWalls(e.target.checked)} className="accent-blue-600"/> <span className="text-xs text-slate-500">Dicke Wände / Stahlbeton</span></label></div><div><h3 className="font-bold text-slate-700 mb-2">Router Standort</h3><div className="flex flex-wrap gap-2">{availableFloors.map(f=><button key={f} onClick={()=>setRouter(f.toLowerCase())} className={`wlan-chip ${router===f.toLowerCase()?'toggled':''}`}>{f.toUpperCase()}</button>)}</div></div><div><h3 className="font-bold text-slate-700 mb-2">WLAN Bedarf</h3><div className="flex flex-wrap gap-2">{availableFloors.map(f=><button key={f} onClick={()=>toggleNeed(f.toLowerCase())} className={`wlan-chip ${needs.has(f.toLowerCase())?'toggled':''}`}>{f.toUpperCase()}</button>)}</div></div><div className="p-4 bg-white border border-blue-100 rounded-xl shadow-sm"><div className="text-xs text-slate-400 uppercase tracking-wider font-bold mb-1">EMPFEHLUNG</div><div className="text-xl font-black text-blue-900 mb-1">{sugg}</div><div className="text-sm text-slate-600">{reason}</div><div className="flex gap-2 mt-3">{['Mesh','Repeater','Powerline'].map(t=><span key={t} className={`wlan-badge ${badgeId===(t==='Mesh'?'bMesh':t==='Repeater'?'bRep':'bPow')?'glow':''}`}>{t}</span>)}</div><button onClick={handleCopy} className="w-full py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 transition-colors shadow-md mt-4">Empfehlung kopieren</button></div></div></div></div></div>);};
        const SpeedModal=({isOpen,onClose,triggerToast,onCopyRecommendation})=>{const[simDl,setSimDl]=useState(100);const[simUl,setSimUl]=useState(40);const[tiers,setTiers]=useState([{dl:16,ul:2.4,on:true},{dl:50,ul:10,on:true},{dl:100,ul:40,on:true},{dl:250,ul:40,on:true},{dl:1000,ul:100,on:true}]);const[activities,setActivities]=useState([{k:'surf',label:'Surfen',dl:1.5,ul:0.2,n:2},{k:'video',label:'Videotelefonie',dl:3,ul:1.5,n:1},{k:'stream',label:'Streaming HD',dl:5,ul:1,n:1},{k:'stream4k',label:'4K‑Streaming',dl:25,ul:2,n:0},{k:'gaming',label:'Online‑Gaming',dl:3,ul:0.5,n:1},{k:'home',label:'Home‑Office',dl:4,ul:2,n:1}]);const[prefs,setPrefs]=useState(new Set());const{rec,needDl,needUl,gaugePct}=useMemo(()=>{let nDl=0,nUl=0;activities.forEach(a=>{nDl+=a.n*a.dl;nUl+=a.n*a.ul;});nDl=Math.ceil(nDl*1.2);nUl=Math.ceil(nUl*1.2);const avail=tiers.filter(t=>t.on).sort((a,b)=>a.dl-b.dl);let r=avail.find(t=>t.dl>=nDl&&t.ul>=Math.max(nUl,2));if(!r&&avail.length>0)r=avail[avail.length-1];const pct=r?Math.min(100,Math.round((nDl/r.dl)*100)):0;return{needDl:nDl,needUl:nUl,rec:r,gaugePct:pct};},[activities,tiers,prefs]);useEffect(()=>{if(rec){setSimDl(rec.dl);setSimUl(Math.max(rec.ul,1));}},[rec]);const toggleTier=(i)=>{const newT=[...tiers];newT[i].on=!newT[i].on;setTiers(newT);};const updateAct=(k,delta)=>{setActivities(prev=>prev.map(a=>a.k===k?{...a,n:Math.max(0,a.n+delta)}:a));};const togglePref=(k)=>{const p=new Set(prefs);if(p.has(k))p.delete(k);else p.add(k);setPrefs(p);};const secsToStr=(s)=>{if(!isFinite(s)||s<0)return'–';const m=Math.floor(s/60),sec=Math.round(s%60);return m>=60?`${Math.floor(m/60)} h ${m%60} min`:m>=1?`${m} min ${sec} s`:`${sec} s`;};const handleCopy=()=>{const txt=`Empfehlung: ${rec?.dl}/${rec?.ul}`;copyToClipboard(txt);triggerToast('Speed-Empfehlung kopiert!');try{onCopyRecommendation&&onCopyRecommendation(txt);}catch(e){};};if(!isOpen)return null;return(<div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4 animate-in fade-in duration-200"><style>{` .sp-modal { --primary: #3949AB; --bg: #FFFFFF; --panel: #F5F5F5; --border: #E0E0E0; --text: #424242; --muted: #757575; font-family: system-ui,-apple-system,sans-serif; } .sp-modal .card { background: var(--panel); border: 1px solid var(--border); border-radius: 16px; padding: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); } .sp-modal h3 { margin: 0 0 10px 0; font-size: 14px; font-weight: 800; color: #1A237E; letter-spacing:.2px; } .sp-modal .chip { background: #ffffff; border: 1px solid var(--border); color: #424242; border-radius: 999px; padding: 6px 12px; cursor: pointer; font-size: 13px; transition: all 0.2s; } .sp-modal .chip:hover { background: #e0e0e0; } .sp-modal .chip.toggled { background: #BBDEFB; color: #1A237E; border-color: #3949AB; box-shadow: 0 2px 4px rgba(57, 73, 171, 0.2); font-weight: 600; } .sp-modal .gauge { width: 280px; aspect-ratio: 1/1; margin: 0 auto; position: relative; background: conic-gradient(from -90deg, #3949AB 0 var(--p), #E0E0E0 var(--p) 360deg); border-radius: 999px; border: 12px solid #F5F5F5; box-shadow: 0 4px 12px rgba(0,0,0,0.05); } .sp-modal .gauge .inner { position: absolute; inset: 40px; background: #ffffff; border-radius: 999px; display: grid; place-items: center; border: 6px solid #F5F5F5; } .sp-modal .val { font-size: 36px; font-weight: 900; line-height: 1; color: #3949AB; } .sp-modal .val-ul { font-size: 20px; color: #424242; } .sp-modal .text-label { font-size: 10px; uppercase; tracking-widest; color: #757575; } .sp-modal .btn { padding: 8px 12px; border-radius: 10px; border: 1px solid var(--border); background: #ffffff; color: #424242; cursor: pointer; font-size: 13px; font-weight: 600; } .sp-modal .btn:hover { background: #f0f0f0; } .sp-modal .btn.primary { background: #3949AB; border-color: #3949AB; color: #ffffff; } .sp-modal input[type=range] { width: 100%; accent-color: #3949AB; } .sp-modal table { width: 100%; font-size: 14px; border-collapse: collapse; color: #424242; } .sp-modal td, .sp-modal th { padding: 8px 10px; border-bottom: 1px solid var(--border); text-align: left; } .sp-modal th { color: #757575; } .sp-modal .metric { background: #ffffff; border: 1px solid var(--border); padding: 8px 10px; border-radius: 12px; text-align: center; font-size: 13px; color: var(--muted); } .sp-modal .metric b { color: #424242; display: block; font-size: 14px; margin-top: 2px; } .sp-modal .rowlabel { display: flex; align-items: center; justify-content: space-between; padding: 4px 0; } .sp-modal .act-btn { width: 28px; height: 28px; border-radius: 8px; border: 1px solid var(--border); background: #ffffff; color: #424242; display: grid; place-items: center; cursor: pointer; } .sp-modal .act-val { width: 30px; text-align: center; font-weight: bold; color: #0f172a; } `}</style><div className="sp-modal bg-white w-full max-w-[1100px] max-h-[95vh] overflow-y-auto rounded-2xl relative border border-[#E0E0E0] shadow-2xl flex flex-col text-[#424242]"><button onClick={onClose} className="absolute top-4 right-4 p-2 rounded-full bg-[#F5F5F5] hover:bg-[#E0E0E0] text-[#424242] border border-[#E0E0E0]"><Icon d={ICONS.X} size={20}/></button><div className="p-6 pb-2 text-center"><div className="inline-flex items-center gap-2 bg-[#F5F5F5] px-4 py-2 rounded-full border border-[#E0E0E0] shadow-sm mb-2"><span className="w-2.5 h-2.5 rounded-full bg-[#3949AB] shadow-[0_0_0_3px_rgba(57,73,171,0.2)]"></span><span className="font-bold text-sm text-[#1A237E] tracking-wide">Speed-Rechner</span></div><h1 className="text-2xl font-black mt-2 text-[#1A237E]">Tarifempfehlung</h1><p className="text-sm text-[#757575] mt-1">{rec?`${rec.dl} MBit/s Download`:'Bitte wählen'}</p></div><div className="grid grid-cols-1 lg:grid-cols-[1fr_340px_1fr] gap-4 p-6 pt-2"><div className="flex flex-col gap-4"><div className="card"><h3>Verfügbares Breitband</h3><div className="flex flex-wrap gap-2">{tiers.map((t,i)=><button key={i} onClick={()=>toggleTier(i)} className={`chip ${t.on?'toggled':''}`}>{t.dl}</button>)}</div></div><div className="card"><h3>Wichtige Themen?</h3><div className="flex flex-wrap gap-2">{['download','upload','stability','latency'].map(k=>(<button key={k} onClick={()=>togglePref(k)} className={`chip ${prefs.has(k)?'toggled':''}`}>{k==='download'?'Download':k==='upload'?'Upload':k==='stability'?'Stabilität':'Ping'}</button>))}</div></div></div><div className="flex flex-col items-center gap-4"><div className="gauge" style={{'--p':`${Math.max(0,Math.min(100,gaugePct))*3.6}deg`}}><div className="inner"><div className="text-center"><div className="val" style={{color:'#3949AB'}}>{rec?rec.dl:0}</div><div className="text-label mb-2">MBit/s Down</div><div className="val-ul" style={{fontSize:'20px',color:'#424242'}}>{rec?rec.ul:0}</div><div className="text-label">MBit/s Up</div></div></div></div><div className="w-full bg-[#F5F5F5] border border-[#E0E0E0] rounded-xl p-4 text-center shadow-sm"><div className="text-lg font-bold text-[#3949AB] mb-3">{rec?`Empfehlung: ${rec.dl} / ${rec.ul}`:'Keine Empfehlung'}</div><div className="grid grid-cols-2 gap-2 text-xs"><div className="metric">Bedarf Down <b>{needDl}</b></div><div className="metric">Bedarf Up <b>{needUl}</b></div></div></div><button onClick={handleCopy} className="btn primary w-full py-3 shadow-md">Empfehlung kopieren</button></div><div className="flex flex-col gap-4"><div className="card"><h3>Aktivitäten (gleichzeitig)</h3><div className="flex flex-col gap-2">{activities.map(a=>(<div key={a.k} className="rowlabel"><span className="text-sm text-[#424242]">{a.label}</span><div className="flex items-center gap-2"><button className="act-btn" onClick={()=>updateAct(a.k,-1)}>-</button><span className="act-val">{a.n}</span><button className="act-btn" onClick={()=>updateAct(a.k,1)}>+</button></div></div>))}</div></div><div className="card"><h3>Simulation</h3><div className="mb-3 space-y-2 text-xs"><div className="flex justify-between"><span className="text-[#757575]">Download</span> <b className="text-[#3949AB]">{simDl} MBit</b></div><input type="range" min="10" max="1000" value={simDl} onChange={(e)=>setSimDl(parseInt(e.target.value))}/></div><table><thead><tr><th>Datei</th><th>Größe</th><th>Zeit</th></tr></thead><tbody>{[{l:'Film HD',gb:4},{l:'Game',gb:50},{l:'Cloud',gb:2,up:true}].map((row,i)=>{const rate=row.up?simUl*125000:simDl*125000;const time=(row.gb*1024*1024*1024)/rate;const hours = Math.floor(time / 3600); const minutes = Math.floor((time % 3600) / 60); const seconds = Math.round(time % 60); const timeStr = hours > 0 ? `${hours} h ${minutes} min` : minutes > 0 ? `${minutes} min ${seconds} s` : `${seconds} s`; return<tr key={i}><td>{row.l}</td><td>{row.gb} GB</td><td className="font-mono text-[#3949AB]">{timeStr}</td></tr>;})}</tbody></table></div></div></div></div></div>);};
        const TechVisualizer = ({ type }) => { function CableOutlet() { return (<g transform="translate(0, 0)"><rect x="0" y="20" width="60" height="80" rx="4" fill="#f1f5f9" stroke="#94a3b8" strokeWidth="2"/><rect x="5" y="30" width="50" height="60" rx="8" fill="#ffffff" stroke="#cbd5e1" strokeWidth="2"/><circle cx="30" cy="45" r="6" fill="#f1f5f9" stroke="#94a3b8" strokeWidth="2"/><circle cx="20" cy="75" r="6" fill="#f1f5f9" stroke="#94a3b8" strokeWidth="2"/><circle cx="40" cy="75" r="6" fill="#f1f5f9" stroke="#94a3b8" strokeWidth="2"/><text x="30" y="115" textAnchor="middle" fontSize="10" fill="#64748b" fontWeight="bold">DATA - TV - RADIO</text></g>); } function TaeOutlet() { return (<g transform="translate(0, 0)"><rect x="0" y="20" width="60" height="80" rx="4" fill="#f1f5f9" stroke="#94a3b8" strokeWidth="2"/><rect x="10" y="30" width="40" height="60" rx="8" fill="#ffffff" stroke="#cbd5e1" strokeWidth="2"/><rect x="15" y="40" width="8" height="40" rx="2" fill="#d1d5db" stroke="#9ca3af" strokeWidth="0.5"/><rect x="26" y="40" width="8" height="40" rx="2" fill="#d1d5db" stroke="#9ca3af" strokeWidth="0.5"/><rect x="37" y="40" width="8" height="40" rx="2" fill="#d1d5db" stroke="#9ca3af" strokeWidth="0.5"/><text x="30" y="115" textAnchor="middle" fontSize="10" fill="#64748b" fontWeight="bold">TAE-Dose</text></g>); } const [fiberVariant, setFiberVariant] = useState('ont'); const FiberVisualization = ({ variant }) => { if (variant === 'sfp') { return (<g transform="translate(30,40)"><g transform="translate(20, 0)"><rect x="0" y="20" width="60" height="60" rx="4" fill="#f8fafc" stroke="#cbd5e1" strokeWidth="2"/><rect x="15" y="45" width="10" height="10" fill="#94a3b8"/><rect x="35" y="45" width="10" height="10" fill="#94a3b8"/><text x="30" y="95" textAnchor="middle" fontSize="10" fill="#64748b" fontWeight="bold">GF-Dose</text></g><path d="M80 50 L380 50" stroke="#22c55e" strokeWidth="3" strokeDasharray="4,4" fill="none" className="flow-anim"/><g transform="translate(380, 20)"><rect x="0" y="0" width="100" height="60" rx="8" fill="#ffffff" stroke="#94a3b8" strokeWidth="2"/><rect x="10" y="0" width="80" height="5" rx="2" fill="#22c55e" opacity="0.8"/><circle cx="30" cy="40" r="3" fill="#22c55e"/><circle cx="50" cy="40" r="3" fill="#22c55e"/><circle cx="70" cy="40" r="3" fill="#cbd5e1"/><text x="50" y="80" textAnchor="middle" fontSize="10" fill="#64748b" fontWeight="bold">Router (SFP)</text></g><text x="250" y="15" textAnchor="middle" fontSize="10" fill="#15803d" fontWeight="bold">Variante A: Direkt</text></g>); } else { return (<g transform="translate(30,40)"><g transform="translate(20, 0)"><rect x="0" y="20" width="60" height="60" rx="4" fill="#f8fafc" stroke="#cbd5e1" strokeWidth="2"/><rect x="15" y="45" width="10" height="10" fill="#94a3b8"/><rect x="35" y="45" width="10" height="10" fill="#94a3b8"/><text x="30" y="95" textAnchor="middle" fontSize="10" fill="#64748b" fontWeight="bold">GF-Dose</text></g><path d="M80 50 Q 150 30, 220 50" stroke="#22c55e" strokeWidth="3" strokeDasharray="4,4" fill="none" className="flow-anim"/><g transform="translate(220, 20)"><rect x="0" y="0" width="70" height="60" rx="4" fill="#f1f5f9" stroke="#94a3b8" strokeWidth="2"/><text x="35" y="35" textAnchor="middle" fontSize="12" fontWeight="bold">ONT</text><rect x="10" y="60" width="50" height="10" rx="2" fill="#cbd5e1"/><text x="35" y="80" textAnchor="middle" fontSize="8" fill="#64748b">230V</text></g><path d="M290 50 L380 50" stroke="#3b82f6" strokeWidth="3" fill="none" strokeDasharray="6,6"/><g transform="translate(380, 20)"><rect x="0" y="0" width="100" height="60" rx="8" fill="#ffffff" stroke="#94a3b8" strokeWidth="2"/><rect x="10" y="0" width="80" height="5" rx="2" fill="#fca5a5" opacity="0.8"/><circle cx="30" cy="40" r="3" fill="#22c55e"/><circle cx="50" cy="40" r="3" fill="#22c55e"/><circle cx="70" cy="40" r="3" fill="#cbd5e1"/><text x="50" y="80" textAnchor="middle" fontSize="10" fill="#64748b" fontWeight="bold">Router</text></g><text x="250" y="15" textAnchor="middle" fontSize="10" fill="#2563eb" fontWeight="bold">Variante B: Über ONT</text></g>); } }; const renderContent = () => { switch(type) { case 'dsl': return (<g transform="translate(50,40)"><TaeOutlet /><path d="M60 60 L180 60" stroke="#3b82f6" strokeWidth="4" fill="none"/><rect x="180" y="52" width="40" height="16" rx="4" fill="#ffffff" stroke="#94a3b8" strokeWidth="2"/><text x="200" y="62" textAnchor="middle" fontSize="8" fill="#64748b" fontWeight="bold">RJ11</text><path d="M220 60 L340 60" stroke="#3b82f6" strokeWidth="4" fill="none"/><path d="M60 60 L340 60" stroke="#bfdbfe" strokeWidth="2" fill="none" className="flow-anim"/><g transform="translate(340, 30)"><rect x="0" y="0" width="100" height="60" rx="8" fill="#ffffff" stroke="#94a3b8" strokeWidth="2"/><rect x="10" y="0" width="80" height="5" rx="2" fill="#fca5a5" opacity="0.8"/><circle cx="30" cy="40" r="3" fill="#22c55e"/><circle cx="50" cy="40" r="3" fill="#22c55e"/><circle cx="70" cy="40" r="3" fill="#cbd5e1"/><text x="50" y="80" textAnchor="middle" fontSize="10" fill="#64748b" fontWeight="bold">DSL Router</text></g></g>); case 'cable': return (<g transform="translate(50,40)"><CableOutlet /><path d="M60 45 L340 60" stroke="#3b82f6" strokeWidth="4" fill="none"/><rect x="180" y="42" width="40" height="16" rx="4" fill="#ffffff" stroke="#94a3b8" strokeWidth="2"/><text x="200" y="52" textAnchor="middle" fontSize="8" fill="#64748b" fontWeight="bold">F-Stecker</text><path d="M60 45 L340 60" fill="none" stroke="#bfdbfe" strokeWidth="2" className="flow-anim"/><g transform="translate(340, 30)"><rect x="0" y="0" width="100" height="60" rx="8" fill="#ffffff" stroke="#94a3b8" strokeWidth="2"/><rect x="10" y="0" width="80" height="5" rx="2" fill="#fca5a5" opacity="0.8"/><circle cx="30" cy="40" r="3" fill="#22c55e"/><circle cx="50" cy="40" r="3" fill="#22c55e"/><circle cx="70" cy="40" r="3" fill="#cbd5e1"/><text x="50" y="80" textAnchor="middle" fontSize="10" fill="#64748b" fontWeight="bold">Kabel Router</text></g></g>); case 'fiber': return (<g transform="translate(0, 0)"><FiberVisualization variant={fiberVariant} /></g>); case 'mobile': return (<g transform="translate(60,40)"><g transform="translate(50, 20)"><path d="M20 80 L50 0 L80 80" stroke="#475569" strokeWidth="4" fill="none"/><line x1="35" y1="40" x2="65" y2="40" stroke="#475569" strokeWidth="3"/><circle cx="50" cy="0" r="5" fill="#ef4444"/><text x="50" y="100" textAnchor="middle" fontSize="10" fill="#64748b">5G Mast</text><path d="M20 -10 A 40 40 0 0 1 20 50" stroke="#3b82f6" strokeWidth="3" fill="none" className="signal-wave"/><path d="M40 -20 A 60 60 0 0 1 40 70" stroke="#3b82f6" strokeWidth="3" fill="none" className="signal-wave delay-1"/></g><g transform="translate(200, 40)"><rect x="0" y="0" width="60" height="60" rx="4" fill="#f1f5f9" stroke="#94a3b8" strokeWidth="2"/><circle cx="20" cy="30" r="5" fill="#ffffff" stroke="#94a3b8" strokeWidth="2"/><circle cx="40" cy="30" r="5" fill="#ffffff" stroke="#94a3b8" strokeWidth="2"/><text x="30" y="80" textAnchor="middle" fontSize="10" fill="#64748b" fontWeight="bold">Schuko</text></g><path d="M260 55 L350 55" stroke="#3b82f6" strokeWidth="3" fill="none" strokeDasharray="6,6"/><g transform="translate(350, 30)"><rect x="0" y="0" width="80" height="60" rx="6" fill="#ffffff" stroke="#cbd5e1" strokeWidth="2"/><rect x="45" y="65" width="40" height="10" rx="2" fill="#ffbf00"/><text x="65" y="72" textAnchor="middle" fontSize="8" fill="#ffffff" fontWeight="bold">SIM</text><circle cx="40" cy="30" r="4" fill="#22c55e" className="animate-pulse"/><text x="40" y="80" textAnchor="middle" fontSize="10" fill="#64748b" fontWeight="bold">5G Router</text></g></g>); case 'hybrid': return (<g transform="translate(40,40)"><TaeOutlet /><g transform="translate(200, -20)"><path d="M-10 80 L10 20 L30 80" stroke="#ef4444" strokeWidth="3" fill="none"/><circle cx="10" cy="20" r="3" fill="#ef4444"/></g><path d="M60 60 L340 60" stroke="#3b82f6" strokeWidth="3" fill="none" strokeDasharray="8,4" className="flow-anim"/><path d="M200 40 Q 300 20, 340 40" stroke="#ef4444" strokeWidth="2" fill="none" strokeDasharray="4,4" className="beam-anim"/><g transform="translate(340, 30)"><rect x="0" y="0" width="100" height="60" rx="8" fill="#ffffff" stroke="#94a3b8" strokeWidth="2"/><rect x="10" y="65" width="40" height="10" rx="2" fill="#ffbf00"/><text x="30" y="72" textAnchor="middle" fontSize="8" fill="#ffffff" fontWeight="bold">SIM</text><rect x="10" y="0" width="80" height="5" rx="2" fill="#fca5a5" opacity="0.8"/><circle cx="30" cy="40" r="3" fill="#22c55e"/><circle cx="50" cy="40" r="3" fill="#22c55e"/><circle cx="70" cy="40" r="3" fill="#cbd5e1"/><text x="50" y="80" textAnchor="middle" fontSize="10" fill="#64748b" fontWeight="bold">Hybrid Router</text></g></g>); case 'sat': return (<g transform="translate(60,20)"><g transform="translate(100, 20)"><rect x="-30" y="-5" width="60" height="10" fill="#3b82f6"/><circle cx="0" cy="0" r="8" fill="#1e40af"/><text x="0" y="-15" textAnchor="middle" fontSize="10" fill="#64748b">Satellit</text></g><g transform="translate(100, 150)"><path d="M-40 0 C -20 -30, 20 -30, 40 0" fill="none" stroke="#475569" strokeWidth="3"/><line x1="0" y1="0" x2="0" y2="-50" stroke="#475569" strokeWidth="2"/><line x="0" y="0" x="0" y="40" stroke="#475569" strokeWidth="4"/><text x="0" y="55" textAnchor="middle" fontSize="10" fill="#64748b" fontWeight="bold">Sat-Schüssel</text></g><path d="M100 20 L100 120" stroke="#bfdbfe" strokeWidth="2" strokeDasharray="4,4" className="beam-anim"/><path d="M100 150 L250 150" stroke="#3b82f6" strokeWidth="2" fill="none" strokeDasharray="6,6"/><g transform="translate(250, 120)"><rect x="0" y="0" width="80" height="60" rx="6" fill="#f1f5f9" stroke="#94a3b8" strokeWidth="2"/><text x="40" y="35" textAnchor="middle" fontSize="10" fill="#64748b" fontWeight="bold">PoE-Injektor</text><rect x="15" y="60" width="50" height="10" rx="2" fill="#cbd5e1"/><text x="40" y="80" textAnchor="middle" fontSize="8" fill="#64748b">230V</text></g><path d="M330 150 L420 150" stroke="#3b82f6" strokeWidth="2" fill="none" strokeDasharray="6,6"/><g transform="translate(420, 120)"><rect x="0" y="0" width="100" height="60" rx="8" fill="#ffffff" stroke="#94a3b8" strokeWidth="2"/><text x="50" y="80" textAnchor="middle" fontSize="10" fill="#64748b" fontWeight="bold">Router</text></g></g>); default: return null; } }; return (<div className="w-full h-[200px] bg-blue-50/30 rounded-2xl border border-blue-100 flex items-center justify-center overflow-hidden relative mb-6"><svg viewBox="0 0 500 180" width="100%" height="100%" preserveAspectRatio="xMidYMid meet">{renderContent()}</svg>{type === 'fiber' && (<div className="absolute top-2 right-2 flex gap-2 bg-white p-1 rounded-lg border border-slate-200 shadow-md"><button onClick={() => setFiberVariant('ont')} className={`px-3 py-1 text-xs font-bold rounded-md transition-colors ${fiberVariant === 'ont' ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}>ONT</button><button onClick={() => setFiberVariant('sfp')} className={`px-3 py-1 text-xs font-bold rounded-md transition-colors ${fiberVariant === 'sfp' ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}>Direkt (SFP)</button></div>)}</div>); }
        const TechModal = ({ isOpen, onClose }) => { const [selected, setSelected] = useState('dsl'); if (!isOpen) return null; const TECHS = { dsl: { id: 'dsl', label: 'DSL / VDSL (Kupfer)', Icon: ICONS.Phone, desc: 'Datenübertragung über die klassische Kupfer-Telefonleitung (TAE-Dose). Nutzt VDSL- und Supervectoring-Technologien.', speed: 'bis 250 MBit/s', ping: 'Gut (10-20ms)', pros: ['Hohe Verfügbarkeit (fast überall in Deutschland)', 'Geringe Anschlusskosten','Konstante Leistung bei kurzer Leitungslänge'], cons: ['Geschwindigkeit stark leitungsabhängig','Maximaler Upload oft begrenzt','Frequenzstörungen möglich'] }, cable: { id: 'cable', label: 'Kabel (Koax-Netz)', Icon: ICONS.Tv, desc: 'Internet über das TV-Kabelnetz (Koax-3-Loch-Dose). Nutzt DOCSIS 3.1 / 4.0 Standard.', speed: 'bis 1000 MBit/s', ping: 'Mittel (15-30ms)', pros: ['Sehr hohe Downloads möglich','Geringere Auslastung im ländlichen Raum','Keine neue Verkabelung in der Wohnung nötig'], cons: ['Shared Medium (geteilte Bandbreite im Segment)','Geringere Stabilität als Glasfaser','Upload oft asynchron (deutlich langsamer)'] }, fiber: { id: 'fiber', label: 'Glasfaser (FTTH)', Icon: ICONS.Zap, desc: 'Datenübertragung per Lichtsignal über Glasfaser bis in die Wohnung (FTTH). Zukunftssicher und nahezu störungsfrei.', speed: 'bis 1000+ MBit/s', ping: 'Exzellent (<5ms)', pros: ['Höchste Geschwindigkeiten und Stabilität', 'Symmetrische Uploads möglich', 'Zukunftssicher und störungsarm'], cons: ['Geringere Verfügbarkeit (Netzausbau nötig)','Installationsaufwand in der Wohnung'] }, mobile: { id: 'mobile', label: '5G / LTE (Mobilfunk)', Icon: ICONS.Smartphone, desc: 'Internet über das Mobilfunknetz per SIM-Karte im Router (CPE). Ideal für Standorte ohne Festnetz-Alternative.', speed: 'bis 500 MBit/s', ping: 'Variabel', pros: ['Sofort startklar (Plug & Play)', 'Flexible Standortwahl (ohne Kabelbindung)','Gute Geschwindigkeiten in 5G-Gebieten'], cons: ['Empfangs- und wetterabhängig','Datenvolumenbegrenzung möglich (je nach Tarif)'] }, hybrid: { id: 'hybrid', label: 'Hybrid (DSL + LTE/5G)', Icon: ICONS.Layers, desc: 'Kombiniert die DSL-Leitung mit dem Mobilfunksignal (LTE/5G), um Geschwindigkeit und Ausfallsicherheit zu erhöhen (Bonding).', speed: 'DSL + Mobilfunk-Boost', ping: 'Wie DSL', pros: ['Höhere Geschwindigkeit als reines DSL möglich','Verbesserte Ausfallsicherheit (Bleibt online bei DSL-Störung)','Nutzt bestehende TAE-Verkabelung'], cons: ['Spezial-Hardware (Hybrid-Router) nötig','Geschwindigkeit des Mobilfunk-Anteils variabel'] }, sat: { id: 'sat', label: 'Satellit (Starlink/etc.)', Icon: ICONS.Disc, desc: 'Breitband-Internet über LEO-Satelliten. Geeignet für sehr ländliche oder schwer zugängliche Gebiete.', speed: '50-200 MBit/s', ping: 'Mittel (ca. 40-70ms)', pros: ['Überall verfügbar (unabhängig vom Leitungsnetz)','Hohe Downloadraten im Vergleich zu altem DSL'], cons: ['Sichtverbindung zum Himmel erforderlich','Wetterabhängige Schwankungen','Höhere Latenz als Festnetz'] } }; const active = TECHS[selected]; return (<div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-md p-4 animate-in fade-in"><div className="bg-white w-full max-w-5xl h-[650px] rounded-2xl shadow-2xl overflow-hidden flex flex-col md:flex-row border border-slate-200"><div className="w-full md:w-64 bg-slate-50 border-r border-slate-200 p-4 flex flex-col gap-2 shrink-0 overflow-y-auto custom-scrollbar"><h3 className="font-black text-slate-800 text-lg mb-4 px-2">Technologie</h3>{Object.values(TECHS).map(t => (<button key={t.id} onClick={() => setSelected(t.id)} className={`w-full text-left px-4 py-3 rounded-xl transition-all flex items-center gap-3 border ${selected === t.id ? 'bg-white border-blue-500 shadow-sm ring-1 ring-blue-100' : 'border-transparent hover:bg-slate-100'}`}><div className={`p-1.5 rounded-lg ${selected===t.id ? 'bg-blue-50 text-blue-600' : 'bg-slate-200 text-slate-500'}`}><Icon d={t.Icon} size={16}/></div><span className={`text-sm ${selected===t.id ? 'font-bold text-blue-700' : 'font-medium text-slate-600'}`}>{t.label.split('(')[0].trim()}</span></button>))}<div className="mt-auto pt-4 border-t border-slate-200"><button onClick={onClose} className="w-full py-3 text-slate-400 font-bold text-xs uppercase tracking-wider hover:text-slate-600 hover:bg-slate-100 rounded-lg transition-colors">SCHLIESSEN</button></div></div><div className="flex-1 p-8 bg-white relative overflow-y-auto custom-scrollbar"><button onClick={onClose} className="absolute top-4 right-4 p-2 hover:bg-slate-50 rounded-full text-slate-400"><Icon d={ICONS.X} size={24}/></button><div className="flex items-start gap-4 mb-6"><div className="p-3 bg-blue-600 rounded-2xl text-white shadow-lg shadow-blue-200"><Icon d={active.Icon} size={32}/></div><div><h2 className="text-3xl font-black text-slate-900 mb-1">{active.label}</h2><p className="text-slate-500 leading-relaxed max-w-lg">{active.desc}</p></div></div><TechVisualizer type={selected} /><div className="grid grid-cols-2 gap-4 mb-8"><div className="p-4 bg-slate-50 rounded-2xl border border-slate-100"><div className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">MAX. GESCHWINDIGKEIT</div><div className="text-xl font-black text-blue-600">{active.speed}</div></div><div className="p-4 bg-slate-50 rounded-2xl border border-slate-100"><div className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">LATENZ / PING (REAKTIONSZEIT)</div><div className="text-xl font-black text-slate-700">{active.ping}</div></div></div><div className="grid grid-cols-2 gap-8"><div><h4 className="font-bold text-emerald-600 flex items-center gap-2 mb-3"><Icon d={ICONS.CheckCircle} size={18}/> Vorteile</h4><ul className="space-y-2">{active.pros.map((p,i) => <li key={i} className="text-sm text-slate-600 flex gap-2"><span className="text-emerald-400">•</span> {p}</li>)}</ul></div><div><h4 className="font-bold text-amber-600 flex items-center gap-2 mb-3"><Icon d={ICONS.AlertCircle} size={18}/> Nachteile</h4><ul className="space-y-2">{active.cons.map((c,i) => <li key={i} className="text-sm text-slate-600 flex gap-2"><span className="text-amber-400">•</span> {c}</li>)}</ul></div></div></div></div></div>); };
        const RoamingModal = ({ isOpen, onClose }) => { const [zone, setZone] = useState('de_eu'); if (!isOpen) return null; const Node = ({ x, y, label, icon, active }) => (<g transform={`translate(${x},${y})`} className={active ? "opacity-100" : "opacity-40"}><circle r="30" fill={active ? "#eff6ff" : "#f1f5f9"} stroke={active ? "#3b82f6" : "#cbd5e1"} strokeWidth="2" /><text x="0" y="6" textAnchor="middle" fontSize="20">{icon}</text><text x="0" y="45" textAnchor="middle" fontSize="12" fontWeight="bold" fill="#64748b">{label}</text></g>); return (<div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4 animate-in fade-in duration-200">
        <div className="bg-white w-full max-w-4xl rounded-2xl shadow-2xl overflow-hidden flex flex-col md:flex-row h-[600px] border border-slate-200 relative">
            {/* NEU: Schließen-Button oben rechts */}
            <button onClick={onClose} className="absolute top-4 right-4 z-50 p-2 hover:bg-slate-100 rounded-full text-slate-500"><Icon d={ICONS.X} size={20}/></button>
            <div className="w-full md:w-72 bg-slate-50 border-r border-slate-200 flex flex-col">
                <div className="p-6 border-b border-slate-200">
                    <h2 className="text-lg font-black text-slate-800 flex items-center gap-2"><Icon d={ICONS.Globe} size={20} className="text-blue-600"/> Roaming Check</h2>
                    <p className="text-xs text-slate-500 mt-1">Wählen Sie ein Szenario zur Analyse.</p>
                </div>
                <div className="p-4 flex flex-col gap-2 overflow-y-auto">
                    <button onClick={()=>setZone('de_eu')} className={`p-4 rounded-lg text-left border transition-all group ${zone==='de_eu' ? 'bg-white border-blue-500 shadow-md' : 'border-transparent hover:bg-slate-100'}`}><div className="flex items-center justify-between mb-1"><span className="font-bold text-slate-700 text-sm">Telefonie ins Ausland</span><span className="text-xs bg-slate-100 px-2 py-0.5 rounded text-slate-500">DE ➔ EU</span></div><div className="text-[11px] text-slate-500 leading-tight">Kostenanalyse für Anrufe von Deutschland in das EU-Ausland.</div></button><button onClick={()=>setZone('eu_roam')} className={`p-4 rounded-lg text-left border transition-all group ${zone==='eu_roam' ? 'bg-white border-blue-500 shadow-md' : 'border-transparent hover:bg-slate-100'}`}><div className="flex items-center justify-between mb-1"><span className="font-bold text-slate-700 text-sm">EU Roaming</span><span className="text-xs bg-slate-100 px-2 py-0.5 rounded text-slate-500">EU ➔ DE</span></div><div className="text-[11px] text-slate-500 leading-tight">Nutzung des Tarifs im EU-Ausland (Reise).</div></button><button onClick={()=>setZone('world')} className={`p-4 rounded-lg text-left border transition-all group ${zone==='world' ? 'bg-white border-blue-500 shadow-md' : 'border-transparent hover:bg-slate-100'}`}><div className="flex items-center justify-between mb-1"><span className="font-bold text-slate-700 text-sm">Weltreise (Zone 3)</span><span className="text-xs bg-slate-100 px-2 py-0.5 rounded text-slate-500">World</span></div><div className="text-[11px] text-slate-500 leading-tight">Nutzung außerhalb der EU.</div></button></div>
                {/* ENTFERNT: Alter Schließen-Button am unteren Rand 
                <div className="mt-auto p-4 border-t border-slate-200">
                    <button onClick={onClose} className="w-full py-2 text-slate-500 text-xs font-bold hover:text-slate-800 hover:bg-slate-100 rounded transition-colors">SCHLIESSEN</button>
                </div>
                */}
            </div><div className="flex-1 bg-slate-50 relative flex flex-col"><div className="flex-1 bg-slate-50 relative"><svg viewBox="0 0 600 300" className="w-full h-full"><pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse"><path d="M 40 0 L 0 0 0 40" fill="none" stroke="#f1f5f9" strokeWidth="1"/></pattern><rect width="600" height="300" fill="url(#grid)" /><Node x="150" y="150" label="Deutschland" icon="🇩🇪" active={true} /><Node x="450" y="100" label="EU Ausland" icon="🇪🇺" active={zone !== 'world'} /><Node x="450" y="220" label="Weltweit (Zone 3)" icon="🌏" active={zone === 'world'} />{zone === 'de_eu' && (<g><path d="M 180 150 L 420 100" fill="none" stroke="#cbd5e1" strokeWidth="2" /><path d="M 180 150 L 420 100" fill="none" stroke="#3b82f6" strokeWidth="2" strokeDasharray="10,10" className="flow-anim" /><rect x="275" y="110" width="50" height="24" rx="12" fill="#ef4444" /><text x="300" y="126" textAnchor="middle" fill="white" fontSize="12" fontWeight="bold">0,29 €</text></g>)}{zone === 'eu_roam' && (<g><path d="M 420 100 L 180 150" fill="none" stroke="#cbd5e1" strokeWidth="2" /><path d="M 420 100 L 180 150" fill="none" stroke="#22c55e" strokeWidth="2" strokeDasharray="10,10" className="flow-anim" /><circle cx="300" cy="125" r="14" fill="#22c55e" /><text x="300" y="130" textAnchor="middle" fill="white" fontSize="14">✓</text></g>)}{zone === 'world' && (<g><path d="M 420 220 L 180 150" fill="none" stroke="#cbd5e1" strokeWidth="2" /><path d="M 420 220 L 180 150" fill="none" stroke="#ef4444" strokeWidth="2" strokeDasharray="10,10" className="flow-anim" /><path d="M 300 175 L 290 195 L 310 195 Z" fill="#f59e0b" stroke="#b45309" strokeWidth="2" /><text x="300" y="192" textAnchor="middle" fill="#78350f">!</text></g>)}</svg></div><div className="h-48 border-t border-slate-200 bg-white p-6 flex flex-col justify-center"><div className="flex items-start gap-4 max-w-2xl mx-auto w-full"><div class={`w-12 h-12 shrink-0 rounded-full flex items-center justify-center text-xl ${zone === 'eu_roam' ? 'bg-emerald-100 text-emerald-600' : zone === 'de_eu' ? 'bg-blue-100 text-blue-600' : 'bg-amber-100 text-amber-600'}`}>{zone === 'eu_roam' ? <Icon d={ICONS.CheckCircle} /> : <Icon d={ICONS.AlertCircle} />}</div><div><h3 class={`font-bold text-lg mb-1 ${zone === 'eu_roam' ? 'text-emerald-800' : zone === 'de_eu' ? 'text-blue-800' : 'text-amber-800'}`}>{zone === 'de_eu' && "Status: Kostenpflichtig (International Call)"}{zone === 'eu_roam' && "Status: Roam like at Home (Inklusive)"}{zone === 'world' && "Status: Kostenrisiko (Zone 2/3)"}</h3><div class="text-sm text-slate-600 leading-relaxed">{zone === 'de_eu' && "Kosten fallen an (z.B. 0,29 €/Min)."}{zone === 'eu_roam' && "Keine Mehrkosten im EU-Ausland."}{zone === 'world' && "Hohe Kosten möglich! Option buchen!"}</div></div></div></div></div></div></div>); };
        
        // --- MODAL GRUND FÜR ÜBERSPRINGEN (SKIP REASON) ---
        const SkipReasonModal = ({ isOpen, onClose, onConfirm, reason, setReason, reasonMode, setReasonMode, drawnStrokes, setDrawnStrokes, canvasRef, startDrawing, draw, stopDrawing, MIN_LENGTH }) => {
            if (!isOpen) return null;
            
            const isPen = reasonMode === 'pen';
            
            // Validation logic
            const keyboardValid = reason.trim().length >= MIN_LENGTH;
            const penValid = drawnStrokes['skip_reason']?.length > 0;
            const isValid = isPen ? penValid : keyboardValid;

            const handleConfirm = () => {
                const reasonData = isPen ? 'HANDWRITING (Grund per Stift erfasst)' : reason;
                if (isValid) {
                    onConfirm(reasonData);
                }
            };
            
            const clearCanvas = () => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                const dpr = window.devicePixelRatio || 1;
                ctx.clearRect(0, 0, canvas.width / dpr, canvas.height / dpr);
                setDrawnStrokes(prev => ({ ...prev, ['skip_reason']: [] }));
            };
            
            // Redraw effect for the skipReasonCanvas when in pen mode (to ensure it clears when needed)
            useEffect(() => {
                if (!isOpen || !isPen || !canvasRef.current || !drawnStrokes['skip_reason']) return;
                redrawCanvas(canvasRef.current, drawnStrokes['skip_reason'], 1, 'skip_reason');
            }, [isOpen, isPen, drawnStrokes['skip_reason']]);

            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center bg-slate-900/70 backdrop-blur-sm p-4 animate-in fade-in">
                    <div className="bg-white w-full max-w-xl rounded-2xl shadow-2xl p-6 relative border border-slate-200">
                        <h3 className="text-xl font-black text-slate-800 mb-2 flex items-center gap-2">
                            <Icon d={ICONS.AlertCircle} size={24} className="text-amber-600"/> Grund für Überspringen
                        </h3>
                        
                        <p className="text-sm text-slate-600 mb-4">
                            Bitte geben Sie kurz an, warum die Situation-Analyse übersprungen wird (min. {MIN_LENGTH} Buchstaben/Stift-Eintrag).
                        </p>

                        <div className="relative w-full h-32 border border-slate-300 rounded-lg bg-slate-50 overflow-hidden">
                            <div className="absolute top-2 right-2 z-20 flex gap-1">
                                <button onClick={() => setReasonMode(p => p === 'keyboard' ? 'pen' : 'keyboard')} className="p-1 hover:bg-slate-200 rounded text-slate-400 transition-colors" title={reasonMode === 'keyboard' ? 'Stift-Eingabe' : 'Tastatur-Eingabe'}>
                                    <Icon d={reasonMode === 'keyboard' ? ICONS.Pen : ICONS.Keyboard} size={16}/>
                                </button>
                                {isPen && drawnStrokes['skip_reason']?.length > 0 && (
                                    <button onClick={clearCanvas} className="p-1 hover:bg-slate-200 rounded text-slate-400" title="Löschen"><Icon d={ICONS.Trash} size={16}/></button>
                                )}
                            </div>
                            
                            {isPen ? (
                                <canvas 
                                    ref={canvasRef} 
                                    className="absolute inset-0 w-full h-full cursor-crosshair z-10" 
                                    style={{ touchAction: 'none' }}
                                    onPointerDown={(e) => startDrawing(e, canvasRef, 'skip_reason')}
                                    onPointerMove={(e) => draw(e, canvasRef, 'skip_reason')}
                                    onPointerUp={(e) => stopDrawing(e, canvasRef)}
                                    onPointerLeave={(e) => stopDrawing(e, canvasRef)}
                                />
                            ) : (
                                <textarea
                                    value={reason}
                                    onChange={(e) => setReason(e.target.value)}
                                    placeholder="Grund hier eingeben..."
                                    className="w-full h-full p-4 text-base font-medium text-slate-700 bg-transparent resize-none focus:ring-0 focus:outline-none pr-12"
                                    autoFocus
                                    maxLength={100}
                                />
                            )}
                        </div>
                        
                        <div className="flex justify-between items-center mt-4">
                            <span className={`text-xs font-bold transition-colors ${isValid ? 'text-green-600' : 'text-red-500'}`}>
                                {isValid ? 'Anforderung erfüllt.' : `Mind. ${MIN_LENGTH} Buchstaben erforderlich.`}
                            </span>
                            <div className="flex gap-2">
                                <button onClick={onClose} className="px-4 py-2 text-slate-500 font-medium hover:bg-slate-100 rounded-lg transition-colors">Abbrechen</button>
                                <button 
                                    onClick={handleConfirm} 
                                    className={`px-6 py-2 rounded-lg font-bold shadow-md transition-all flex items-center gap-2 ${isValid ? 'bg-amber-600 text-white hover:bg-amber-700' : 'bg-slate-300 text-slate-500 cursor-not-allowed'}`} 
                                    disabled={!isValid}
                                >
                                    Bestätigen & Springen <Icon d={ICONS.ArrowRight} size={16}/>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        // --- ADMIN MODAL UPDATE ---
        const AdminModal = ({ isOpen, onClose, questions, onUpdate, oneDriveLink, onUpdateLink }) => { 
            const [localData, setLocalData] = useState(questions); 
            const [localLink, setLocalLink] = useState(oneDriveLink || '');
            const [expandedCat, setExpandedCat] = useState(null); 
            
            useEffect(() => { 
                setLocalData(questions); 
                setLocalLink(oneDriveLink || '');
            }, [questions, oneDriveLink, isOpen]); 
            
            const handleQuestionChange = (cat, index, val) => { 
                const newQs = [...(localData[cat] || [])]; 
                newQs[index] = val; 
                setLocalData(prev => ({ ...prev, [cat]: newQs.filter(q => q.trim() !== '') })); // Filter out empty strings on change
            }; 
            const handleAddQuestion = (cat) => { 
                const newQs = [...(localData[cat] || []), "Neue Frage..."]; 
                setLocalData(prev => ({ ...prev, [cat]: newQs })); 
            }; 
            
            const handleSave = () => { 
                // Filter out empty questions before saving
                const cleanedData = Object.keys(localData).reduce((acc, cat) => {
                    acc[cat] = localData[cat].filter(q => q.trim() !== '');
                    return acc;
                }, {});
                
                Object.keys(cleanedData).forEach(cat => onUpdate(cat, cleanedData[cat])); 
                if (onUpdateLink) onUpdateLink(localLink.trim());
                onClose(); 
            }; 
            
            if (!isOpen) return null; 
            
            return ( 
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4 animate-in fade-in"> 
                    <div className="bg-white w-full max-w-2xl rounded-xl shadow-2xl flex flex-col max-h-[85vh]"> 
                        <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-xl">
                            <h3 className="font-bold text-lg flex items-center gap-2 text-slate-800"><Icon d={ICONS.Lock} size={18}/> Admin: Fragen & Links</h3>
                            <button onClick={onClose} className="p-2 hover:bg-slate-200 rounded-full"><Icon d={ICONS.X} size={18}/></button>
                        </div> 
                        
                        <div className="flex-1 overflow-y-auto p-6 space-y-6 custom-scrollbar"> 
                            {/* NEW: Link Section */}
                            <div className="border border-slate-200 rounded-lg p-4 bg-white shadow-sm">
                                <h4 className="font-bold text-slate-700 mb-2 text-sm flex items-center gap-2">
                                    <Icon d={ICONS.Book} size={16} className="text-blue-500"/> Link zur Aktionsmappe (OneDrive)
                                </h4>
                                <input
                                    type="url"
                                    value={localLink}
                                    onChange={(e) => setLocalLink(e.target.value)}
                                    placeholder="https://..."
                                    className="w-full border border-slate-300 p-2 rounded text-sm focus:ring-2 focus:ring-blue-200 outline-none text-slate-600"
                                />
                                <p className="text-[10px] text-slate-400 mt-1">Dieser Link wird beim Klick auf das Buch-Icon (Angebotsseite) geöffnet.</p>
                            </div>

                            <div className="border-t border-slate-100 pt-2">
                                <h4 className="font-bold text-slate-700 mb-4 text-sm">Fragenkatalog bearbeiten</h4>
                                <div className="space-y-4">
                                    {Object.keys(localData).map(cat => ( 
                                        <div key={cat} className="border border-slate-200 rounded-lg overflow-hidden">
                                            <button onClick={() => setExpandedCat(expandedCat === cat ? null : cat)} className={`w-full p-3 text-left font-bold flex justify-between items-center ${expandedCat === cat ? 'bg-blue-50 text-blue-700' : 'bg-white text-slate-700 hover:bg-slate-50'}`}>
                                                <span>{cat === 'default' ? 'Standard Fragen' : cat}</span>
                                                <Icon d={expandedCat === cat ? ICONS.ArrowLeft : ICONS.ArrowRight} className={`transform transition-transform ${expandedCat === cat ? '-rotate-90' : 'rotate-90'}`} size={16}/>
                                            </button> 
                                            {expandedCat === cat && (
                                                <div className="p-4 bg-slate-50/50 space-y-2 border-t border-slate-100">
                                                    {localData[cat].map((q, i) => (
                                                        <div key={i} className="flex gap-2">
                                                            <input className="flex-1 border border-slate-300 p-2 rounded text-sm focus:ring-2 focus:ring-blue-200 outline-none" value={q} onChange={(e) => handleQuestionChange(cat, i, e.target.value)} />
                                                            <button onClick={() => handleQuestionChange(cat, i, '')} className="p-2 text-red-400 hover:bg-red-100 rounded" title="Frage löschen"><Icon d={ICONS.Trash} size={16}/></button>
                                                        </div>
                                                    ))}
                                                    <button onClick={() => handleAddQuestion(cat)} className="text-xs font-bold text-blue-600 hover:text-blue-800 mt-2 flex items-center gap-1"><Icon d={ICONS.Plus} size={14}/> Frage hinzufügen</button>
                                                </div>
                                            )} 
                                        </div> 
                                    ))} 
                                </div>
                            </div>
                        </div> 
                        
                        <div className="p-4 border-t border-slate-100 flex justify-end gap-2 bg-slate-50 rounded-b-xl">
                            <button onClick={onClose} className="px-4 py-2 text-slate-500 font-medium hover:bg-slate-200 rounded-lg transition-colors">Abbrechen</button>
                            <button onClick={handleSave} className="px-6 py-2 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 transition-colors">Alle Speichern</button>
                        </div> 
                    </div> 
                </div> 
            ); 
        };

        const QuestionModal = ({ isOpen, onClose, category, question, onNextQuestion }) => { if (!isOpen) return null; return (<div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/40 backdrop-blur-sm p-4"><div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6"><h3 className="text-xl font-bold mb-4">Frage zu: {category}</h3><p className="text-lg mb-6">{question}</p><div className="flex justify-end gap-2"><button onClick={onNextQuestion} className="px-4 py-2 border rounded">Nächste</button><button onClick={onClose} className="px-4 py-2 bg-blue-600 text-white rounded">OK</button></div></div></div>); };

        // --- OFFER CANVAS ---
        const redrawCanvas = (canvas, strokes, scaleFactor = 1, key = '') => { if (!canvas) return; const ctx = canvas.getContext('2d'); ctx.clearRect(0, 0, canvas.width / (window.devicePixelRatio || 1), canvas.height / (window.devicePixelRatio || 1)); ctx.save(); const isOfferCanvas = key.startsWith('offer') || key.startsWith('cost_') || key.startsWith('agent_') || key.startsWith('date_') || key.startsWith('signature'); strokes.forEach(stroke => { ctx.beginPath(); const currentCssWidth = canvas.getBoundingClientRect().width; const responsiveScaleFactor = currentCssWidth / (stroke.baseWidth || currentCssWidth); const rawStrokeWidth = stroke.width; let visualBaseWidth; if (isOfferCanvas) { visualBaseWidth = rawStrokeWidth === 2 ? 2.5 : rawStrokeWidth === 4 ? 5 : 8; } else { visualBaseWidth = rawStrokeWidth === 2 ? 2 : rawStrokeWidth === 4 ? 3 : 5; } const normalizedBaseLineWidth = (visualBaseWidth * responsiveScaleFactor); if (stroke.tool === 'eraser') { ctx.lineWidth = normalizedBaseLineWidth * 4; ctx.globalCompositeOperation = 'destination-out'; ctx.globalAlpha = 1; } else if (stroke.tool === 'highlighter') { ctx.lineWidth = normalizedBaseLineWidth * 3; ctx.strokeStyle = stroke.color; ctx.globalAlpha = stroke.opacity; ctx.globalCompositeOperation = 'destination-over'; } else { ctx.lineWidth = normalizedBaseLineWidth; ctx.strokeStyle = stroke.color; ctx.globalAlpha = stroke.opacity; ctx.globalCompositeOperation = 'source-over'; } if (stroke.points.length > 0) { const startX = stroke.points[0].x * responsiveScaleFactor; const startY = stroke.points[0].y * responsiveScaleFactor; ctx.moveTo(startX, startY); stroke.points.slice(1).forEach(point => { const lineToX = point.x * responsiveScaleFactor; const lineToY = point.y * responsiveScaleFactor; ctx.lineTo(lineToX, lineToY); }); } ctx.stroke(); }); ctx.restore(); ctx.globalCompositeOperation = 'source-over'; ctx.globalAlpha = 1; };

        const OfferCanvas = React.memo(({ canvasRef, label, icon, statusKey, status, setStatus, inputMode, startDrawing, draw, stopDrawing, textValue, handleTextChange, textStyle, textSize, drawnStrokes, setDrawnStrokes, scaleRef, triggerRedraw, image, onClearImage, imageTransform, onUpdateImageTransform }) => { const SIZE_DIFFERENCE_THRESHOLD = 5; const toggleStatus = (newStatus) => { setStatus(prev => ({ ...prev, [statusKey]: prev[statusKey] === newStatus ? 'neutral' : newStatus })); }; const isOpen = status === 'open'; const isClosed = status === 'closed'; let statusClass = 'border-slate-300'; if (isOpen) statusClass = 'border-red-500 ring-4 ring-red-100/50'; else if (isClosed) statusClass = 'border-green-500 ring-4 ring-green-100/50'; const containerClasses = `offer-canvas-container ${statusClass} flex flex-col min-h-[600px]`; const getOfferTextClasses = () => { let classes = "absolute inset-0 w-full h-full p-4 bg-transparent resize-none focus:ring-0 focus:outline-none z-30 leading-relaxed "; if (textSize === 'small') classes += "text-base "; else if (textSize === 'medium') classes += "text-lg "; else if (textSize === 'large') classes += "text-xl "; if (textStyle.bold) classes += "font-black "; else classes += "font-medium "; if (textStyle.italic) classes += "italic "; classes += inputMode === 'pen' ? 'pointer-events-none text-slate-800' : 'pointer-events-auto text-slate-800'; return classes; }; useEffect(() => { const canvas = canvasRef.current; if (!canvas || !drawnStrokes) return; const rect = canvas.getBoundingClientRect(); const currentWidth = rect.width; let baseWidth = scaleRef.current.baseWidth; if (baseWidth === 0) { scaleRef.current.baseWidth = currentWidth; baseWidth = currentWidth; } const scaleFactor = currentWidth / baseWidth; redrawCanvas(canvas, drawnStrokes, scaleFactor, statusKey); if (Math.abs(currentWidth - baseWidth) > SIZE_DIFFERENCE_THRESHOLD) { scaleRef.current.baseWidth = currentWidth; } }, [canvasRef, drawnStrokes, triggerRedraw]); useEffect(() => { const canvas = canvasRef.current; if (canvas && scaleRef.current.baseWidth === 0) { const rect = canvas.getBoundingClientRect(); scaleRef.current.baseWidth = rect.width; } }, [canvasRef]); const isPenMode = inputMode === 'pen'; const { x, y, scale, rotation } = imageTransform; 
        const interactionStateRef = useRef({ isDragging: false, isScaling: false, startX: 0, startY: 0, initialX: 0, initialY: 0, initialScale: 1.0, initialDistance: 0, initialRotation: 0, initialAngle: 0, mode: null });
        const pointerCacheRef = useRef({}); 
        const getClientCoords = (e) => { const clientX = e.clientX ?? e.touches?.[0]?.clientX; const clientY = e.clientY ?? e.touches?.[0]?.clientY; if (clientX === undefined || clientY === undefined) return null; return { clientX, clientY }; }; 
        
        const handleInteractionStart = useCallback((e) => { 
            if (!isPenMode || !image) return; 
            e.preventDefault(); 
            e.stopPropagation(); 
            const { clientX, clientY } = getClientCoords(e); 
            if (clientX === undefined || clientY === undefined) return; 
            pointerCacheRef.current[e.pointerId] = { x: clientX, y: clientY }; 
            const pointerIds = Object.keys(pointerCacheRef.current); 
            
            if (pointerIds.length === 1) { 
                interactionStateRef.current = { 
                    isDragging: true, isScaling: false, 
                    startX: clientX, startY: clientY, 
                    initialX: x, initialY: y, 
                    initialScale: scale, initialRotation: rotation, 
                    initialDistance: 0, initialAngle: 0, 
                    mode: 'drag' 
                }; 
            } else if (pointerIds.length >= 2) { 
                const [id1, id2] = pointerIds; 
                const p1 = pointerCacheRef.current[id1]; 
                const p2 = pointerCacheRef.current[id2]; 
                const initialDistance = Math.hypot(p1.x - p2.x, p1.y - p2.y);
                const initialAngle = Math.atan2(p2.y - p1.y, p2.x - p1.x); // Angle in radians
                
                interactionStateRef.current = { 
                    isDragging: false, isScaling: true, 
                    initialDistance: initialDistance, 
                    initialScale: scale, 
                    initialRotation: rotation, 
                    initialAngle: initialAngle,
                    mode: 'scale' 
                }; 
            } else { 
                interactionStateRef.current.mode = null; 
            } 
            e.target.setPointerCapture(e.pointerId); 
        }, [isPenMode, image, x, y, scale, rotation]); 
        
        const handleInteractionMove = useCallback((e) => { 
            if (!image) return; 
            const { clientX, clientY } = getClientCoords(e); 
            if (clientX === undefined || clientY === undefined) return; 
            pointerCacheRef.current[e.pointerId] = { x: clientX, y: clientY }; 
            const pointerIds = Object.keys(pointerCacheRef.current); 
            const mode = interactionStateRef.current.mode; 
            
            if (pointerIds.length === 1 && mode === 'drag') { 
                e.preventDefault(); 
                e.stopPropagation(); 
                const { startX, startY, initialX, initialY } = interactionStateRef.current; 
                const dx = clientX - startX; 
                const dy = clientY - startY; 
                onUpdateImageTransform(statusKey, { x: initialX + dx, y: initialY + dy }); 
            } else if (pointerIds.length >= 2 && mode === 'scale') { 
                e.preventDefault(); 
                e.stopPropagation(); 
                
                const { initialDistance, initialScale, initialRotation, initialAngle } = interactionStateRef.current;
                const relevantIds = Object.keys(pointerCacheRef.current).slice(0, 2);
                const p1 = pointerCacheRef.current[relevantIds[0]];
                const p2 = pointerCacheRef.current[relevantIds[1]];
                if (!p1 || !p2) return;

                // 1. SCALING
                const currentDistance = Math.hypot(p1.x - p2.x, p1.y - p2.y);
                const ratio = currentDistance / initialDistance;
                let newScale = initialScale * ratio;
                newScale = Math.min(2.5, Math.max(0.25, newScale));
                newScale = Math.round(newScale * 100) / 100;

                // 2. ROTATION (NEW)
                const currentAngle = Math.atan2(p2.y - p1.y, p2.x - p1.x);
                const angleDelta = currentAngle - initialAngle;
                const rotationDeltaDeg = angleDelta * (180 / Math.PI);
                let newRotation = (initialRotation + rotationDeltaDeg);
                newRotation = Math.round(newRotation * 10) / 10; // Keep one decimal place

                if (newScale !== scale || newRotation !== rotation) {
                    onUpdateImageTransform(statusKey, { scale: newScale, rotation: newRotation });
                }

            } 
        }, [image, onUpdateImageTransform, statusKey, scale, rotation]); 
        
        const handleInteractionEnd = useCallback((e) => { 
            e.target.releasePointerCapture(e.pointerId); 
            delete pointerCacheRef.current[e.pointerId]; 
            const pointerIds = Object.keys(pointerCacheRef.current); 
            
            if (pointerIds.length === 0) { 
                interactionStateRef.current.mode = null; 
                interactionStateRef.current.isDragging = false; 
                interactionStateRef.current.isScaling = false; 
            } else if (pointerIds.length === 1) { 
                const remainingId = pointerIds[0]; 
                const p = pointerCacheRef.current[remainingId]; 
                interactionStateRef.current = { 
                    isDragging: true, isScaling: false, 
                    startX: p.x, startY: p.y, 
                    initialX: x, initialY: y, 
                    initialScale: scale, initialRotation: rotation,
                    initialDistance: 0, initialAngle: 0,
                    mode: 'drag' 
                }; 
            } else if (pointerIds.length >= 2) { 
                const relevantIds = pointerIds.slice(0, 2); 
                const p1 = pointerCacheRef.current[relevantIds[0]]; 
                const p2 = pointerCacheRef.current[relevantIds[1]]; 
                
                // Recalculate initial state based on current state
                const currentDistance = Math.hypot(p1.x - p2.x, p1.y - p2.y);
                const currentAngle = Math.atan2(p2.y - p1.y, p2.x - p1.x);

                interactionStateRef.current = {
                    isDragging: false,
                    isScaling: true,
                    initialDistance: currentDistance,
                    initialScale: scale,
                    initialRotation: rotation,
                    initialAngle: currentAngle,
                    mode: 'scale'
                };
            } 
            e.preventDefault(); 
            e.stopPropagation(); 
        }, [x, y, scale, rotation]); 
        
        const handleImageReset = () => { onUpdateImageTransform(statusKey, { x: 0, y: 0, scale: 1.0, rotation: 0 }); }; 
        
        return (<div className={containerClasses} style={{transition: 'all 0.25s ease'}}> <div className="p-4 bg-white/90 border-b border-slate-100 relative z-10 shrink-0 flex flex-col"><div className="flex justify-between items-start"><div className="flex items-center gap-3 text-lg font-bold text-slate-800"><Icon d={icon} size={20} className="text-blue-600"/><span>{label}</span></div><div className="flex items-center gap-2">{image && (x !== 0 || y !== 0 || scale !== 1.0 || rotation !== 0) && (<button onClick={handleImageReset} className="p-1.5 rounded-full bg-slate-50 text-blue-600 hover:bg-blue-100 transition-colors" title="Position/Skalierung/Rotation zurücksetzen"><Icon d={ICONS.RefreshCw} size={14}/></button>)}{image && (<button onClick={onClearImage} className="p-1.5 rounded-full bg-red-50 text-red-600 hover:bg-red-100 transition-colors" title="Eingefügtes Bild entfernen"><Icon d={ICONS.Trash} size={14}/></button>)}</div></div><div className="flex items-center gap-2 mt-2"><span className="text-[10px] font-medium text-slate-500 mr-1 uppercase">Status:</span><button onClick={() => toggleStatus('open')} className={`px-2 py-0.5 rounded-full text-[10px] font-bold transition-all flex items-center gap-1 border ${isOpen ? 'bg-red-500 text-white shadow-lg shadow-red-200/50' : 'text-slate-500 bg-red-50 border-red-200 hover:bg-red-100'}`}>{isOpen ? <Icon d={ICONS.AlertCircle} size={10}/> : null} Offen</button><button onClick={() => toggleStatus('closed')} className={`px-2 py-0.5 rounded-full text-[10px] font-bold transition-all flex items-center gap-1 border ${isClosed ? 'bg-green-500 text-white shadow-lg shadow-green-200/50' : 'text-slate-500 bg-green-50 border-green-200 hover:bg-green-100'}`}>{isClosed ? <Icon d={ICONS.CheckCircle} size={10}/> : null} Abgeschlossen</button></div></div><div className="canvas-lines"></div>{image && (<div className="absolute inset-0 z-20" onPointerDown={isPenMode ? handleInteractionStart : undefined} onPointerMove={isPenMode ? handleInteractionMove : undefined} onPointerUp={isPenMode ? handleInteractionEnd : undefined} onPointerCancel={isPenMode ? handleInteractionEnd : undefined} onPointerLeave={isPenMode ? handleInteractionEnd : undefined} style={{ transform: `translate(${x}px, ${y}px)`, transition: 'none', cursor: isPenMode ? (interactionStateRef.current.mode === 'drag' ? 'grabbing' : interactionStateRef.current.mode === 'scale' ? 'crosshair' : 'grab') : 'default', pointerEvents: isPenMode ? 'auto' : 'none', touchAction: 'none' }}><img src={image} alt={`Eingefügtes Bild für ${label}`} className="canvas-image" style={{ transform: `scale(${scale}) rotate(${rotation}deg)`, transition: 'none', pointerEvents: 'none', opacity: 0.7 }}/></div>)}<div className="relative flex-1 w-full h-full min-h-[100px] overflow-hidden"><textarea value={textValue || ''} onChange={(e) => handleTextChange(statusKey, e.target.value)} className={getOfferTextClasses()} placeholder={inputMode === 'keyboard' ? 'Details digital eingeben...' : ''} readOnly={inputMode === 'pen'} /><canvas ref={canvasRef} onPointerDown={(e) => startDrawing(e, canvasRef, statusKey)} onPointerMove={(e) => draw(e, canvasRef, statusKey)} onPointerUp={(e) => stopDrawing(e, canvasRef)} onPointerLeave={(e) => stopDrawing(e, canvasRef)} className="w-full h-full drawing-canvas absolute inset-0" style={{pointerEvents: inputMode === 'pen' ? 'auto' : 'none', touchAction: 'none'}}/></div></div>); });
        
        const SmallInputCanvas = ({ inputMode, canvasRef, inputKey, inputValue, inputType = 'text', onChange, placeholder, drawnStrokes, setDrawnStrokes, readOnly = false, startDrawing, draw, stopDrawing }) => { const isPen = inputMode === 'pen'; useEffect(() => { const canvas = canvasRef.current; if (!canvas) return; if (isPen) { redrawCanvas(canvas, drawnStrokes[inputKey], 1, inputKey); } }, [isPen, drawnStrokes, inputKey]); const clearSmallCanvas = () => { const canvas = canvasRef.current; if (!canvas) return; const ctx = canvas.getContext('2d'); const dpr = window.devicePixelRatio || 1; ctx.clearRect(0, 0, canvas.width / dpr, canvas.height / dpr); setDrawnStrokes(prev => ({ ...prev, [inputKey]: [] })); }; return (<div className="small-canvas-wrapper h-full relative flex items-center border-none">{isPen ? (<><canvas ref={canvasRef} onPointerDown={(e) => startDrawing(e, canvasRef, inputKey)} onPointerMove={(e) => draw(e, canvasRef, inputKey)} onPointerUp={(e) => stopDrawing(e, canvasRef)} onPointerLeave={(e) => stopDrawing(e, canvasRef)} className="absolute inset-0 w-full h-full cursor-crosshair z-10" style={{ pointerEvents: 'auto', touchAction: 'none' }}/>{drawnStrokes[inputKey]?.length > 0 && (<button onClick={clearSmallCanvas} className="absolute top-1/2 right-2 -translate-y-1/2 p-0.5 hover:bg-slate-100 rounded text-slate-400 z-20" title="Löschen"><Icon d={ICONS.Trash} size={14}/></button>)}</>) : (<input type={inputType} value={inputValue} onChange={onChange} readOnly={readOnly} placeholder={placeholder} className="w-full h-full p-2 text-sm font-medium text-slate-700 bg-transparent focus:ring-1 focus:ring-blue-300 transition-colors focus:outline-none" style={{ fontSize: '15px', paddingLeft: '8px', opacity: isPen ? 0.5 : 1, pointerEvents: isPen ? 'none' : 'auto' }}/>)}</div>); };

        // --- MAIN APP ---
        function App() {
            const [view, setView] = useState('situation'); 

            // --- ZOOM WRITE MODAL (Stylus-friendly) ---
            const [zoomOpen, setZoomOpen] = useState(false);
            const [zoomLabel, setZoomLabel] = useState('');
            const [zoomType, setZoomType] = useState('text'); // 'text' | 'textarea'
            const [zoomValue, setZoomValue] = useState('');
            const zoomSaveRef = useRef(null);
            const zoomInkCanvasRef = useRef(null);
            const zoomInkIsDrawingRef = useRef(false);
            const zoomInkLastRef = useRef({x:0,y:0});
            const zoomInkDirtyRef = useRef(false);

            const zoomInputRef = useRef(null);
            const [zoomInputMode, setZoomInputMode] = useState('pen'); // 'pen' | 'keyboard'

            const openZoom = (label, type, value, onSave, preferredMode = 'pen') => {
                setZoomLabel(label || '');
                setZoomType(type || 'text');
                setZoomValue(value ?? '');
                zoomInkDirtyRef.current = false;
                zoomSaveRef.current = onSave || null;
                setZoomInputMode(preferredMode || 'pen');
                setZoomOpen(true);
                setTimeout(() => {
                    if ((preferredMode || 'pen') === 'keyboard') {
                        try { zoomInputRef.current && zoomInputRef.current.focus && zoomInputRef.current.focus(); } catch(e){}
                    }
                }, 50);
            };

            
            const initZoomInkCanvas = () => {
                const canvas = zoomInkCanvasRef.current;
                if (!canvas) return;
                const rect = canvas.getBoundingClientRect();
                const dpr = window.devicePixelRatio || 1;
                const w = Math.max(1, Math.floor(rect.width * dpr));
                const h = Math.max(1, Math.floor(rect.height * dpr));
                if (canvas.width !== w || canvas.height !== h) {
                    canvas.width = w; canvas.height = h;
                }
                const ctx = canvas.getContext('2d');
                ctx.setTransform(1,0,0,1,0,0);
                ctx.scale(dpr, dpr);
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.lineWidth = 2;
                ctx.strokeStyle = '#0f172a';
            };

            const clearZoomInk = () => {
                const canvas = zoomInkCanvasRef.current;
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                const dpr = window.devicePixelRatio || 1;
                ctx.setTransform(1,0,0,1,0,0);
                ctx.clearRect(0,0,canvas.width, canvas.height);
                ctx.scale(dpr, dpr);
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.lineWidth = 2;
                ctx.strokeStyle = '#0f172a';
            };

            const loadZoomInkFromDataUrl = (dataUrl) => {
                if (!dataUrl) { clearZoomInk(); return; }
                const img = new Image();
                img.onload = () => {
                    clearZoomInk();
                    const canvas = zoomInkCanvasRef.current;
                    if (!canvas) return;
                    const ctx = canvas.getContext('2d');
                    const rect = canvas.getBoundingClientRect();
                    // fit image into strip
                    const scale = Math.min((rect.width-32)/img.width, (rect.height-32)/img.height);
                    const w = img.width*scale;
                    const h = img.height*scale;
                    ctx.drawImage(img, (rect.width-w)/2, (rect.height-h)/2, w, h);
                };
                img.src = dataUrl;
            };

            const zoomInkPointerPos = (e) => {
                const canvas = zoomInkCanvasRef.current;
                if (!canvas) return {x:0,y:0};
                const rect = canvas.getBoundingClientRect();
                return { x: e.clientX - rect.left, y: e.clientY - rect.top };
            };

            const zoomInkStart = (e) => {
                const canvas = zoomInkCanvasRef.current;
                if (!canvas) return;
                zoomInkIsDrawingRef.current = true;
                zoomInkDirtyRef.current = true;
                try { canvas.setPointerCapture(e.pointerId); } catch(err) {}
                zoomInkLastRef.current = zoomInkPointerPos(e);
            };

            const zoomInkMove = (e) => {
                if (!zoomInkIsDrawingRef.current) return;
                zoomInkDirtyRef.current = true;
                const canvas = zoomInkCanvasRef.current;
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                const p = zoomInkPointerPos(e);
                const last = zoomInkLastRef.current;
                ctx.beginPath();
                ctx.moveTo(last.x, last.y);
                ctx.lineTo(p.x, p.y);
                ctx.stroke();
                zoomInkLastRef.current = p;
            };

            const zoomInkEnd = (e) => {
                const canvas = zoomInkCanvasRef.current;
                if (!canvas) return;
                zoomInkIsDrawingRef.current = false;
                try { canvas.releasePointerCapture(e.pointerId); } catch(err) {}
            };

            useEffect(() => {
                if (!zoomOpen) return;
                if (zoomInputMode === 'pen' && zoomType === 'ink') {
                    setTimeout(() => {
                        initZoomInkCanvas();
                        loadZoomInkFromDataUrl(zoomValue);
                    }, 50);
                }
            }, [zoomOpen, zoomInputMode, zoomType]);
const closeZoom = () => {
                setZoomOpen(false);
                zoomSaveRef.current = null;
            };

            const applyZoom = () => {
                try {
                    if (typeof zoomSaveRef.current === 'function') {
                        if (zoomInputMode === 'pen' && zoomType === 'ink') {
                            const c = zoomInkCanvasRef.current;
                            let data = zoomValue || '';
                            if (zoomInkDirtyRef.current) {
                                data = c ? c.toDataURL('image/png') : '';
                            }
                            zoomSaveRef.current(data);
                        } else {
                            zoomSaveRef.current(zoomValue);
                        }
                    }
                } finally {
                    closeZoom();
                }
            };

            const [sellerNotes, setSellerNotes] = useState('');

            const [activeCategory, setActiveCategory] = useState(null); 
            const [questionIndex, setQuestionIndex] = useState(0); 
            const [questionsData, setQuestionsData] = useState(INITIAL_QUESTIONS_DATA);
            
            // Drawing State
            const [tool, setTool] = useState('pen');
            const [color, setColor] = useState('#0044ff'); 
            const [strokeWidth, setStrokeWidth] = useState(4); 
            const [opacity, setOpacity] = useState(0.85); 
            
            const [drawnStrokes, setDrawnStrokes] = useState({ 
                main: [], email: [], provider: [], notes: [], offer1: [], offer2: [], offer3: [], 
                cost_einmalig: [], cost_monatlich1: [], cost_monatlich2: [], agent_name: [], date_field: [],
                skip_reason: [] 
            });
            const isDrawingRef = useRef(false);
            const currentStrokeRef = useRef(null); 
            
            const toolRef = useRef('pen');
            const strokeWidthRef = useRef(4);
            const opacityRef = useRef(0.85);
            const colorRef = useRef('#0044ff'); 
            
            const scaleRef1 = useRef({ baseWidth: 0, scaleFactor: 1 });
            const scaleRef2 = useRef({ baseWidth: 0, scaleFactor: 1 });
            const scaleRef3 = useRef({ baseWidth: 0, scaleFactor: 1 });
            const [redrawCounter, setRedrawCounter] = useState(0); 
            
            useEffect(() => { toolRef.current = tool; }, [tool]);
            useEffect(() => { colorRef.current = color; }, [color]);
            useEffect(() => { strokeWidthRef.current = strokeWidth; }, [strokeWidth]);
            useEffect(() => { opacityRef.current = opacity; }, [opacity]);

            const [isWritingEnabled, setIsWritingEnabled] = useState(true); 
            const [inputMode, setInputMode] = useState('pen'); 
            const [showColorPicker, setShowColorPicker] = useState(false);
            const [showAdmin, setShowAdmin] = useState(false);
            const dprRef = useRef(window.devicePixelRatio || 1); 
            const [textSize, setTextSize] = useState('medium'); 
            const [textStyle, setTextStyle] = useState({ bold: false, italic: false });
            const [textData, setTextData] = useState({ 
                AgentName: 'Max Mustermann', 
                DateValue: new Date().toLocaleDateString('de-DE', { year: 'numeric', month: '2-digit', day: '2-digit' }), 
                offer1: '', 
                offer2: '', 
                offer3: '' 
            }); 
            const [emailText, setEmailText] = useState('');
            
            const [emailInkUrl, setEmailInkUrl] = useState('');
            const [notesInkUrl, setNotesInkUrl] = useState('');
const [emailMode, setEmailMode] = useState('keyboard'); 
            const [notesMode, setNotesMode] = useState('keyboard');

            const [showWlanModal, setShowWlanModal] = useState(false);
            const [showSpeedModal, setShowSpeedModal] = useState(false);
            const [showTechModal, setShowTechModal] = useState(false);

            // Empfehlung im Alltag: IMMER frisch pro Reload (keine Cookie/localStorage Altwerte)
            const [wlanPrintRec, setWlanPrintRec] = useState('');
            const [speedPrintRec, setSpeedPrintRec] = useState('');

            const [showRoamingModal, setShowRoamingModal] = useState(false);
            const [showSignatureModal, setShowSignatureModal] = useState(false);
            
            // NEU: REFERRAL MODAL STATE
            const [showReferralModal, setShowReferralModal] = useState(false);
            
            // NEUE STATES FÜR SKIP MODAL
            const [showSkipReasonModal, setShowSkipReasonModal] = useState(false); 
            const [skipReason, setSkipReason] = useState(''); 
            const [skipReasonMode, setSkipReasonMode] = useState('keyboard'); 
            const skipReasonCanvasRef = useRef(null); 
            const MIN_REASON_LENGTH = 5; 

            const [customerType, setCustomerType] = useState("");
            const [segment, setSegment] = useState("");
            const [providerSelect, setProviderSelect] = useState("");
            const [customProvider, setCustomProvider] = useState("");
            const [isCustomProvider, setIsCustomProvider] = useState(false); 
            const [providerMode, setProviderMode] = useState('keyboard'); 
            const techSituation = providerSelect === 'Sonstiges' ? customProvider : providerSelect;
            
            const [costState, setCostState] = useState({ mobile: '', landline: '', tv: '' });
            const parseCost = (val) => { if (!val) return 0; return parseFloat(val.replace(',', '.')) || 0; };
            const totalCost = parseCost(costState.mobile) + parseCost(costState.landline) + parseCost(costState.tv);
            
            const initialOfferData = { einmalig: 0, monatlich1: 0, monatlich2: 0, einmaligRaw: '0', monatlich1Raw: '0', monatlich2Raw: '0' };
            const [offerData, setOfferData] = useState(initialOfferData);
            const [canvasStatus, setCanvasStatus] = useState({ offer1: 'neutral', offer2: 'neutral', offer3: 'neutral' });
            
            const [customerSignature, setCustomerSignature] = useState(null); 
            
            // AKTUALISIERTER STATE: Jetzt mit Rotation
            const [imageTransform, setImageTransform] = useState({ 
                offer1: { x: 0, y: 0, scale: 1.0, rotation: 0 }, 
                offer2: { x: 0, y: 0, scale: 1.0, rotation: 0 }, 
                offer3: { x: 0, y: 0, scale: 1.0, rotation: 0 } 
            });
            const handleUpdateImageTransform = useCallback((key, updates) => { setImageTransform(prev => ({ ...prev, [key]: { ...prev[key], ...updates } })); }, []);
            
            const canvasRef = useRef(null); 
            const emailCanvasRef = useRef(null);
            const providerCanvasRef = useRef(null); 
            const notesCanvasRef = useRef(null); 
            const offerCanvasRef1 = useRef(null);
            const offerCanvasRef2 = useRef(null);
            const offerCanvasRef3 = useRef(null);
            const offerCost1Ref = useRef(null);
            const offerCost2Ref = useRef(null);
            const offerCost3Ref = useRef(null);
            const offerAgentRef = useRef(null);
            const offerDateRef = useRef(null);
            const fileInputRef = useRef(null); 

            const [displayLanguage, setDisplayLanguage] = useState('de');
            const [translatedText, setTranslatedText] = useState({});
            const [staticTranslations, setStaticTranslations] = useState({}); 
            const [showLanguageDropdown, setShowLanguageDropdown] = useState(false);
            const [oneDriveLink, setOneDriveLink] = useState('https://onedrive.live.com/action-map-placeholder'); 
            const [isDrawing, setIsDrawing] = useState(false);
            const [toastMessage, setToastMessage] = useState(null); 
            const toastTimerRef = useRef(null);
            const [canvasImages, setCanvasImages] = useState({ offer1: null, offer2: null, offer3: null });
            const [isImageSelectModalOpen, setIsImageSelectModalOpen] = useState(false);
            const [currentImagePayload, setCurrentImagePayload] = useState(null);
            
            const getDisplayText = useCallback((key) => { 
                const defaultText = textData[key] || ''; 
                if (displayLanguage === 'de') return defaultText; 
                
                // Prioritize user-entered text translations if available
                const translation = translatedText[displayLanguage]?.[key]; 
                
                // Fallback to mock translation if user hasn't typed anything yet or specific translation missing
                if (!translation && MOCK_TRANSLATIONS[displayLanguage]?.[key]) {
                    return MOCK_TRANSLATIONS[displayLanguage][key];
                }

                return translation || defaultText; 
            }, [textData, translatedText, displayLanguage]);
            
            const getStaticLabel = useCallback((key) => { 
                if (displayLanguage === 'de') return STATIC_LABELS[key] || key; 
                
                // Priority: Local Mock Static Label -> User Static Translation -> Default German
                return staticTranslations[displayLanguage]?.[key] 
                    || MOCK_TRANSLATIONS[displayLanguage]?.[key] 
                    || STATIC_LABELS[key] 
                    || key; 
            }, [staticTranslations, displayLanguage]);

            const triggerToast = (message) => { clearTimeout(toastTimerRef.current); setToastMessage(message); toastTimerRef.current = setTimeout(() => setToastMessage(null), 3000); };
            const openOneDriveLink = () => { if (oneDriveLink && oneDriveLink.startsWith('http')) { window.open(oneDriveLink, '_blank'); triggerToast('Aktionsmappe geöffnet.'); } else { triggerToast('WICHTIG: Kein gültiger OneDrive Link hinterlegt. Bitte pflegen Sie den Link in den Einstellungen.'); } };
            const handleFileSelect = (event) => { const file = event.target.files?.[0]; event.target.value = null; setRedrawCounter(r => r + 1); if (!file) { triggerToast('Datei-Auswahl abgebrochen.'); return; } if (!file.type.startsWith('image/') && !file.type.includes('pdf')) { triggerToast(`Datei "${file.name}" ausgewählt. Nur Bilder werden visuell platziert.`); return; } const reader = new FileReader(); reader.onload = (e) => { const imageDataUrl = e.target.result; setCurrentImagePayload({ url: imageDataUrl, name: file.name }); setIsImageSelectModalOpen(true); }; reader.readAsDataURL(file); };
            const handleFileAdd = () => { fileInputRef.current?.click(); };
            const handleImagePlacement = (targetCanvasKey) => { if (currentImagePayload) { setCanvasImages(prev => ({ ...prev, [targetCanvasKey]: currentImagePayload.url })); setImageTransform(prev => ({ ...prev, [targetCanvasKey]: { x: 0, y: 0, scale: 1.0, rotation: 0 } })); 
                triggerToast(`Bild "${currentImagePayload.name}" zu ${targetCanvasKey.toUpperCase()} hinzugefügt.`); } setIsImageSelectModalOpen(false); setCurrentImagePayload(null); };
            const handleClearImage = (key) => { setCanvasImages(prev => ({ ...prev, [key]: null })); setImageTransform(prev => ({ ...prev, [key]: { x: 0, y: 0, scale: 1.0, rotation: 0 } })); triggerToast(`Bild von ${key.toUpperCase()} entfernt.`); };
            
            // FIX: Print function logic cleanup
            const handlePrint = useCallback(() => {
                window.print();
            }, []);


            const handlePdfShare = useCallback(async () => {
                // Web Share API + PDF: Mobile teilt direkt, Desktop lädt herunter.
                const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent || '');
                const canShareFiles = !!(navigator.share && navigator.canShare);
                const jsPDF = (window.jspdf && window.jspdf.jsPDF) ? window.jspdf.jsPDF : null;

                if (!jsPDF || typeof html2canvas === 'undefined') {
                    triggerToast('PDF-Teilen nicht verfügbar – nutze Drucken.');
                    window.print();
                    return;
                }

                // helper: create offscreen wrapper with clones
                const makeWrapper = (label) => {
                    const wrap = document.createElement('div');
                    wrap.setAttribute('data-export', label);
                    wrap.style.position = 'fixed';
                    wrap.style.left = '-100000px';
                    wrap.style.top = '0';
                    wrap.style.width = '100vw';
                    wrap.style.background = '#ffffff';
                    wrap.style.padding = '16px 16px 24px 16px';
                    wrap.style.boxSizing = 'border-box';
                    wrap.style.zIndex = '999999';
                    document.body.appendChild(wrap);
                    return wrap;
                };

                const cleanup = (wraps) => {
                    wraps.forEach(w => { try { w.remove(); } catch(e){} });
                };

                // Enter export mode (matches your print look, hides UI)
                document.documentElement.classList.add('export-mode','jpeg-capture-mode');
                await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));

                const wraps = [];
                try {
                    // -------- PAGE 1 (Header + aktuelle Situation) --------
                    const header = document.querySelector('header');
                    const situation = document.querySelector('.situation-view-wrapper');

                    if (!header || !situation) {
                        throw new Error('page1 elements missing');
                    }

                    const w1 = makeWrapper('page1');
                    wraps.push(w1);
                    w1.appendChild(header.cloneNode(true));
                    w1.appendChild(situation.cloneNode(true));

                    // Ensure full width and no clipping inside wrapper
                    w1.querySelectorAll('*').forEach(n => {
                        try {
                            const s = n.style;
                            if (!s) return;
                            if (s.transform) s.transform = 'none';
                            if (s.zoom) s.zoom = '1';
                            if (s.overflow && s.overflow !== 'visible') s.overflow = 'visible';
                        } catch(e){}
                    });

                    const canvas1 = await html2canvas(w1, {
                        backgroundColor: '#ffffff',
                        scale: 2.5,
                        useCORS: true,
                        allowTaint: true,
                        logging: false,
                        scrollX: 0,
                        scrollY: 0,
                        windowWidth: w1.scrollWidth,
                        windowHeight: w1.scrollHeight
                    });

                    // -------- PAGE 2 (Offer) --------
                    const offer = document.querySelector('.print-offer-view') || document.querySelector('.print-page-2');
                    if (!offer) {
                        throw new Error('page2 elements missing');
                    }
                    const w2 = makeWrapper('page2');
                    wraps.push(w2);
                    w2.appendChild(offer.cloneNode(true));
                    w2.querySelectorAll('*').forEach(n => {
                        try {
                            const s = n.style;
                            if (!s) return;
                            if (s.transform) s.transform = 'none';
                            if (s.zoom) s.zoom = '1';
                            if (s.overflow && s.overflow !== 'visible') s.overflow = 'visible';
                        } catch(e){}
                    });

                    const canvas2 = await html2canvas(w2, {
                        backgroundColor: '#ffffff',
                        scale: 2.5,
                        useCORS: true,
                        allowTaint: true,
                        logging: false,
                        scrollX: 0,
                        scrollY: 0,
                        windowWidth: w2.scrollWidth,
                        windowHeight: w2.scrollHeight
                    });

                    // Build PDF (A4 Landscape, 2 pages)
                    const pdf = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });

                    const addCanvas = (c, addPage) => {
                        const imgData = c.toDataURL('image/jpeg', 0.98);
                        const pageW = pdf.internal.pageSize.getWidth();
                        const pageH = pdf.internal.pageSize.getHeight();
                        const ratio = c.width / c.height;
                        let w = pageW;
                        let h = w / ratio;
                        if (h > pageH) {
                            h = pageH;
                            w = h * ratio;
                        }
                        const x = (pageW - w) / 2;
                        const y = (pageH - h) / 2;
                        if (addPage) pdf.addPage();
                        pdf.addImage(imgData, 'JPEG', x, y, w, h);
                    };

                    addCanvas(canvas1, false);
                    addCanvas(canvas2, true);

                    const pdfBlob = pdf.output('blob');
                    const file = new File([pdfBlob], 'Angebot.pdf', { type: 'application/pdf' });

                    // Share on mobile if possible
                    if (isMobile && canShareFiles && navigator.canShare({ files: [file] })) {
                        try {
                            await navigator.share({
                                title: 'Ihr persönliches Angebot',
                                text: 'Ihr persönliches Angebot als PDF',
                                files: [file]
                            });
                            triggerToast('PDF geteilt.');
                            return;
                        } catch (e) {
                            // cancelled -> fallback download
                        }
                    }

                    // Fallback: download
                    try {
                        const url = URL.createObjectURL(pdfBlob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'Angebot.pdf';
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                        setTimeout(() => URL.revokeObjectURL(url), 5000);
                    } catch(e){}

                    if (!isMobile) {
                        triggerToast('PDF gespeichert – jetzt in WhatsApp/Outlook anhängen.');
                    } else {
                        triggerToast('PDF gespeichert.');
                    }
                } catch (e) {
                    triggerToast('PDF konnte nicht erstellt werden.');
                    try { window.print(); } catch(_) {}
                } finally {
                    document.documentElement.classList.remove('export-mode','jpeg-capture-mode');
                    cleanup(wraps);
                }
            }, [triggerToast]);



            const handleQuickShare = useCallback(async () => {
                const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent || '');
                const canShareFiles = !!(navigator.share && navigator.canShare);

                // Target: offer page (stable for WhatsApp). If not found, fallback to full app.
                const target = document.querySelector('.print-page-2') || document.querySelector('.print-offer-view') || document.querySelector('#root') || document.body;

                // Enter capture mode to mimic print look (placeholders off, colors exact)
                document.documentElement.classList.add('export-mode','jpeg-capture-mode');

                // Wait for layout to settle
                await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));

                const safeUnlock = (doc) => {
                    try {
                        doc.querySelectorAll('*').forEach(n => {
                            const s = n.style;
                            if (!s) return;
                            // prevent clipping inside clones
                            if (s.overflow && s.overflow !== 'visible') s.overflow = 'visible';
                            if (s.overflowX && s.overflowX !== 'visible') s.overflowX = 'visible';
                            if (s.overflowY && s.overflowY !== 'visible') s.overflowY = 'visible';
                        });
                    } catch(e){}
                };

                let canvas;
                try {
                    canvas = await html2canvas(target, {
                        backgroundColor: '#f0f6ff',
                        scale: Math.max(2, window.devicePixelRatio || 2),
                        useCORS: true,
                        allowTaint: true,
                        logging: false,
                        scrollX: 0,
                        scrollY: -window.scrollY,
                        windowWidth: target.scrollWidth || target.clientWidth || window.innerWidth,
                        windowHeight: target.scrollHeight || target.clientHeight || window.innerHeight,
                        onclone: (clonedDoc) => {
                            try { clonedDoc.documentElement.classList.add('export-mode','jpeg-capture-mode'); } catch(e){}
                            safeUnlock(clonedDoc);
                        }
                    });
                } catch (e) {
                    document.documentElement.classList.remove('export-mode','jpeg-capture-mode');
                    triggerToast('Teilen fehlgeschlagen (Screenshot).');
                    return;
                } finally {
                    document.documentElement.classList.remove('export-mode','jpeg-capture-mode');
                }

                const file = await new Promise((resolve) => {
                    try {
                        canvas.toBlob((blob) => {
                            if (!blob || blob.size === 0) return resolve(null);
                            resolve(new File([blob], 'Angebot_WhatsApp.jpg', { type: 'image/jpeg' }));
                        }, 'image/jpeg', 0.98);
                    } catch(e) { resolve(null); }
                });

                if (!file) { triggerToast('JPEG konnte nicht erstellt werden.'); return; }

                // Mobile: try native share with file. Desktop: download + hint.
                if (isMobile && canShareFiles && navigator.canShare({ files: [file] })) {
                    try {
                        await navigator.share({ title: 'Ihr persönliches Angebot', files: [file] });
                        triggerToast('Angebot geteilt.');
                        return;
                    } catch (e) {
                        // user cancelled or share failed -> fallback download
                    }
                }

                // Fallback: download file
                try {
                    const url = URL.createObjectURL(file);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = file.name;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    setTimeout(() => URL.revokeObjectURL(url), 5000);
                } catch(e){}

                if (!isMobile) {
                    showDesktopShareHint();
                } else {
                    triggerToast('JPEG gespeichert – jetzt in WhatsApp/Outlook anhängen.');
                }
            }, [triggerToast]);

            // NEU: Print-like JPEG Export (2 Seiten) – identisch zum Drucklayout, ohne Drucken
            const handleQuickSharePrintLike = useCallback(async () => {
  const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent || '');
  const canShareFiles = !!(navigator.share && navigator.canShare);

  const appFrame = document.querySelector('#root > div') || document.querySelector('#root') || document.body;
  const page2El = document.querySelector('.print-offer-view') || appFrame;
  const page1El = document.querySelector('.situation-view-wrapper') || appFrame;

  const settle = () => new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));

  const makeFileFromCanvas = (canvas, name) => new Promise((resolve) => {
    try {
      canvas.toBlob((blob) => {
        if (!blob || blob.size === 0) return resolve(null);
        resolve(new File([blob], name, { type: 'image/jpeg' }));
      }, 'image/jpeg', 0.98);
    } catch (e) { resolve(null); }
  });

  const downloadFile = async (file) => {
    try {
      const url = URL.createObjectURL(file);
      const a = document.createElement('a');
      a.href = url;
      a.download = file.name;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 5000);
    } catch(e){}
  };

  const hideModals = (doc) => {
    try {
      doc.querySelectorAll('.fixed.inset-0.z-50, .no-print, .footer-bar, .toast, .toast-message, [class*="toast"], [class*="Toast"]').forEach(n => {
        n.style.display = 'none';
        n.style.visibility = 'hidden';
        n.style.opacity = '0';
      });
    } catch(e){}
  };

  const safeUnlock = (doc) => {
    try {
      doc.querySelectorAll('*').forEach(n => {
        const s = n.style;
        if (!s) return;
        if (s.overflow && s.overflow !== 'visible') s.overflow = 'visible';
        if (s.overflowX && s.overflowX !== 'visible') s.overflowX = 'visible';
        if (s.overflowY && s.overflowY !== 'visible') s.overflowY = 'visible';
      });
    } catch(e){}
  };

  const captureToFile = async ({ mode, target, filename }) => {
    // mode: 'page1' | 'page2'
    document.documentElement.classList.add('export-mode', 'jpeg-capture-mode');
    // Ensure we render from the very top (avoid half-cropped exports)
    try { window.scrollTo(0, 0); } catch(e){}
    await settle();

    // --- PAGE 1: capture header + situation together (no clipping) ---
    let __restore = [];
    const __setStyle = (el, prop, val) => {
      if (!el) return;
      __restore.push(() => { try { el.style[prop] = val; } catch(e){} });
    };
    let __captureTarget = target;
    let __crop = null;
    if (mode === 'page1') {
      const headerEl = document.querySelector('header');
      const situationEl = document.querySelector('.situation-view-wrapper');
      const offerEl = document.querySelector('.print-offer-view');

      // Temporarily hide offer so it can't extend the capture height
      if (offerEl) { __setStyle(offerEl, 'display', offerEl.style.display); offerEl.style.display = 'none'; }

      // Ensure page1 parts are visible
      if (headerEl) { __setStyle(headerEl, 'display', headerEl.style.display); headerEl.style.display = 'flex'; }
      if (situationEl) {
        __setStyle(situationEl, 'display', situationEl.style.display);
        __setStyle(situationEl, 'visibility', situationEl.style.visibility);
        __setStyle(situationEl, 'overflow', situationEl.style.overflow);
        situationEl.style.display = 'flex';
        situationEl.style.visibility = 'visible';
        situationEl.style.overflow = 'visible';
      }

      const vw = document.documentElement.clientWidth || window.innerWidth;
      const hRect = headerEl ? headerEl.getBoundingClientRect() : { top: 0, height: 0 };
      const sRect = situationEl ? situationEl.getBoundingClientRect() : { top: 0, height: window.innerHeight };

      const top = Math.max(0, Math.min(hRect.top, sRect.top));
      const bottom = Math.max(hRect.top + (hRect.height||0), sRect.top + (sRect.height||0));

      const padTop = 24;     // "nach oben ziehen" -> etwas Luft
      const padBottom = 24;  // "nach unten ziehen" -> etwas Luft

      __crop = { x: 0, y: Math.max(0, top - padTop), width: vw, height: Math.max(1, (bottom - top) + padTop + padBottom) };
      __captureTarget = document.body; // crop from full body
    }


    let canvas;
    try {
      const scale = Math.max(3, (window.devicePixelRatio || 2)); // high DPI, but still stable
      canvas = await html2canvas(__captureTarget, {
        backgroundColor: '#f0f6ff',
        scale,
        useCORS: true,
        allowTaint: true,
        logging: false,
        scrollX: 0,
        scrollY: 0,
        windowWidth: (__crop ? __crop.width : (target.scrollWidth || target.clientWidth || window.innerWidth)),
        windowHeight: (__crop ? __crop.height : (target.scrollHeight || target.clientHeight || window.innerHeight)),
        x: (__crop ? __crop.x : undefined),
        y: (__crop ? __crop.y : undefined),
        width: (__crop ? __crop.width : undefined),
        height: (__crop ? __crop.height : undefined),
        onclone: (clonedDoc) => {
          try { clonedDoc.documentElement.classList.add('export-mode', 'jpeg-capture-mode'); } catch(e){}
          hideModals(clonedDoc);

          const situation = clonedDoc.querySelector('.situation-view-wrapper');
          const offer = clonedDoc.querySelector('.print-offer-view');
          const header = clonedDoc.querySelector('header');
          const offerHeader = clonedDoc.querySelector('.print-only-offer-header');

          // Make sure the correct "page" is the only visible one in the clone
          if (mode === 'page1') {
            if (header) header.style.display = 'flex';
            if (situation) { situation.style.display = 'flex'; situation.style.visibility = 'visible'; }
            if (offer) offer.style.display = 'none';
            try {
              if (situation) {
                situation.style.zoom = '1';
                situation.style.transform = 'none';
                situation.style.width = '100vw';
                situation.style.maxWidth = '100vw';
                situation.style.margin = '0';
              }
            } catch(e) {}

          } else {
            if (header) header.style.display = 'none';
            if (situation) situation.style.display = 'none';
            if (offer) { offer.style.display = 'flex'; offer.style.visibility = 'visible'; offer.style.overflow = 'visible'; }
            if (offerHeader) { offerHeader.style.display = 'flex'; offerHeader.style.visibility = 'visible'; }
          }

          safeUnlock(clonedDoc);
        }
      });
    } catch (e) {
      triggerToast('JPEG Export fehlgeschlagen.');
      canvas = null;
    } finally {
      try { __restore.forEach(fn => fn()); } catch(e){}
      document.documentElement.classList.remove('export-mode', 'jpeg-capture-mode');
    }

    if (!canvas) return null;
    return await makeFileFromCanvas(canvas, filename);
  };

  
  // --- View switching for correct Page-1 capture ---
  const clickButtonBy = (matchFn) => {
    const btn = Array.from(document.querySelectorAll('button')).find(matchFn);
    if (btn && !btn.disabled) { try { btn.click(); return true; } catch(e){} }
    return false;
  };

  const goToSituationView = async () => {
    // If we are currently in offer view, there is a "Zurück" button there
    const ok = clickButtonBy(b => (b.title || '').toLowerCase().includes('zurück') || (b.textContent || '').trim().toLowerCase() === 'zurück');
    if (ok) {
      try { window.scrollTo(0, 0); } catch(e){}
      await settle();
      await settle(); // extra frame for heavy layouts
    }
  };

  const goToOfferView = async () => {
    // In situation view, there is typically a "Zum Angebot" button
    const ok = clickButtonBy(b => ((b.textContent || '').trim().toLowerCase().includes('zum angebot')));
    if (ok) {
      try { window.scrollTo(0, 0); } catch(e){}
      await settle();
      await settle();
    }
  };
// Seite 1: Header + Situation (ohne Angebot)
  await goToSituationView();
  const file1 = await captureToFile({ mode: 'page1', target: page1El, filename: 'Angebot_Seite1.jpg' });
  if (!file1) { triggerToast('Seite 1 konnte nicht erstellt werden.'); return; }

  // Seite 2: Nur Angebot (damit es NICHT abgeschnitten wird)
  await goToOfferView();
  const file2 = await captureToFile({ mode: 'page2', target: page2El, filename: 'Angebot_Seite2.jpg' });
  if (!file2) { triggerToast('Seite 2 konnte nicht erstellt werden.'); return; }

  // Mobile: native share (2 Dateien), falls möglich
  if (isMobile && canShareFiles && navigator.canShare({ files: [file1, file2] })) {
    try {
      await navigator.share({ title: 'Ihr persönliches Angebot', files: [file1, file2] });
      triggerToast('Angebot geteilt.');
      return;
    } catch (e) {
      // user cancelled or share failed -> fallback download
    }
  }

  // Fallback: download both files (desktop + mobile fallback)
  await downloadFile(file1);
  await downloadFile(file2);

  if (!isMobile) {
    showDesktopShareHint();
  } else {
    triggerToast('JPEG gespeichert – jetzt in WhatsApp/Outlook anhängen.');
  }
}, [triggerToast]);



            // --- Geänderte Logik: Abschluss-Button verhalten ---
            const handleFinishOffer = () => { 
                if (customerSignature) {
                    // Wenn bereits unterschrieben, öffne das Referral Modal (als Zwischenschritt zum Druck)
                    setShowReferralModal(true);
                } else {
                    // Wenn noch nicht unterschrieben, öffne Signatur-Modal
                    setShowSignatureModal(true); 
                }
            };
            
            // --- Geänderte Logik: Nach Unterschrift -> Referral Modal -> Druck ---
            const handleSignatureSave = (dataUrl) => {
                if (dataUrl === 'PAPER_SIGNATURE') {
                    setCustomerSignature('PAPER_SIGNATURE'); 
                    /* toast disabled (signature) */
                } else {
                    setCustomerSignature(dataUrl);
                    /* toast disabled (signature) */
                }
                
                // Schließe Signatur Modal
                setShowSignatureModal(false);
                
                // Öffne AUTOMATISCH das Referral Modal als nächsten Schritt
                // Dies löst das Problem des Users, dass kein weiteres Popup kam
                setTimeout(() => setShowReferralModal(true), 300);
            };
            
            const handleSkipToOffer = (reasonData) => {
                setSkipReason(reasonData);
                setShowSkipReasonModal(false);
                setView('offer');
                triggerToast(`Situation übersprungen. Grund: ${reasonData.substring(0, 30)}...`);
            };

            const handleClearAll = () => {
                // Clear all strokes
                setDrawnStrokes({
                    main: [], email: [], provider: [], notes: [], offer1: [], offer2: [], offer3: [],
                    cost_einmalig: [], cost_monatlich1: [], cost_monatlich2: [], agent_name: [], date_field: [],
                    skip_reason: [] 
                });
                // Clear text data
                setTextData({
                    AgentName: 'Max Mustermann',
                    DateValue: new Date().toLocaleDateString('de-DE', { year: 'numeric', month: '2-digit', day: '2-digit' }),
                    offer1: '', offer2: '', offer3: '',
                    Kundenname: '', Rufnummer: '', Anbieter: '', Hardware: '', Nutzung: '', Haushalt: '', 'Weitere Produkte': '', Fernsehen: '', WiFi: '', Gesamtkosten: ''
                });
                // Clear state selections
                setCustomerType("");
                setSegment("");
                setProviderSelect("");
                setCustomProvider("");
                setIsCustomProvider(false);
                setEmailText('');
                
                // NEU: Clear skip reason state
                setSkipReason('');
                setSkipReasonMode('keyboard');
                
                // Clear cost data
                setCostState({ mobile: '', landline: '', tv: '' });
                // Clear offer data
                setOfferData(initialOfferData);
                // Clear canvas status
                setCanvasStatus({ offer1: 'neutral', offer2: 'neutral', offer3: 'neutral' });
                // Clear signature
                setCustomerSignature(null);
                // Clear images
                setCanvasImages({ offer1: null, offer2: null, offer3: null });
                // Reset image transforms (now includes rotation)
                setImageTransform({ offer1: { x: 0, y: 0, scale: 1.0, rotation: 0 }, offer2: { x: 0, y: 0, scale: 1.0, rotation: 0 }, offer3: { x: 0, y: 0, scale: 1.0, rotation: 0 } });
                // Trigger redraw to clear canvases visually
                setRedrawCounter(r => r + 1);
                triggerToast('Alle Daten gelöscht und Ansicht zurückgesetzt.');
            };

            const Toast = ({ message }) => { if (!message) return null; return (<div className="fixed bottom-4 left-1/2 -translate-x-1/2 z-[100] bg-slate-900 text-white px-4 py-2 rounded-xl shadow-lg border border-slate-700 animate-in fade-in duration-300"><div className="flex items-center gap-2"><Icon d={ICONS.Clipboard} size={16} className="text-green-400"/><span className="text-sm font-medium">{message}</span></div></div>); };

            useEffect(() => { const handleBeforeUnload = (e) => { e.preventDefault(); e.returnValue = ''; return ''; }; window.addEventListener('beforeunload', handleBeforeUnload); return () => window.removeEventListener('beforeunload', handleBeforeUnload); }, []);
            const handleCategoryClick = (cat) => { setActiveCategory(cat); setQuestionIndex(0); };
            const handleNextQuestion = () => setQuestionIndex((prev) => (prev + 1) % (questionsData[activeCategory || 'default'].length));
            const getCurrentQuestion = () => questionsData[activeCategory || 'default'][questionIndex];
            
            const handleTextChange = (key, val) => { 
                setTextData(prev => ({ ...prev, [key]: val })); 
                if (displayLanguage !== 'de') { 
                    setTranslatedText(prev => ({ 
                        ...prev, 
                        [displayLanguage]: { ...prev[displayLanguage], [key]: val } 
                    })); 
                } 
            };
            
            const handleCostChange = (key, e) => { const val = e.target.value; setCostState(prev => ({ ...prev, [key]: val })); };
            const handleUpdateQuestions = (cat, newQs) => { setQuestionsData(prev => ({...prev, [cat]: newQs})); };
            const isFormValid = customerType !== "" && segment !== "" && techSituation !== "";
            const isMainInputReadOnly = inputMode === 'pen';
            const getInputClasses = () => { let classes = "w-full h-full bg-transparent border-none focus:ring-0 px-4 placeholder-blue-50/0 group-hover:placeholder-blue-100/50 transition-all "; if (textSize === 'small') classes += "text-sm "; else if (textSize === 'medium') classes += "text-base "; else if (textSize === 'large') classes += "text-lg "; if (textStyle.bold) classes += "font-black "; else classes += "font-medium "; if (textStyle.italic) classes += "italic "; return classes; };
            const clearCanvas = (ref, key) => { const canvas = ref.current; if (!canvas) return; const ctx = canvas.getContext('2d'); const dpr = window.devicePixelRatio || 1; ctx.clearRect(0, 0, canvas.width / dpr, canvas.height / dpr); setDrawnStrokes(prev => ({ ...prev, [key]: [] })); setRedrawCounter(r => r + 1); };

            useEffect(() => { const canvasMap = [ { ref: canvasRef, key: 'main' }, { ref: emailCanvasRef, key: 'email', mode: emailMode }, { ref: providerCanvasRef, key: 'provider', mode: providerMode, condition: isCustomProvider }, { ref: notesCanvasRef, key: 'notes', mode: notesMode }, { ref: skipReasonCanvasRef, key: 'skip_reason', mode: skipReasonMode, condition: true } ]; const offerCanvasMap = [ { ref: offerCanvasRef1, key: 'offer1', scaleRef: scaleRef1 }, { ref: offerCanvasRef2, key: 'offer2', scaleRef: scaleRef2 }, { ref: offerCanvasRef3, key: 'offer3', scaleRef: scaleRef3 }, { ref: offerCost1Ref, key: 'cost_einmalig', mode: inputMode, condition: true }, { ref: offerCost2Ref, key: 'cost_monatlich1', mode: inputMode, condition: true }, { ref: offerCost3Ref, key: 'cost_monatlich2', mode: inputMode, condition: true }, { ref: offerAgentRef, key: 'agent_name', mode: inputMode, condition: true }, { ref: offerDateRef, key: 'date_field', mode: inputMode, condition: true } ]; const resizeCanvas = (ref, key) => { const canvas = ref.current; if (!canvas || !key) return; const rect = canvas.getBoundingClientRect(); const dpr = window.devicePixelRatio || 1; dprRef.current = dpr; const oldWidth = canvas.width; const oldHeight = canvas.height; const newWidth = rect.width * dpr; const newHeight = rect.height * dpr; if (oldWidth !== newWidth || oldHeight !== newHeight) { const tempCanvas = document.createElement('canvas'); tempCanvas.width = oldWidth; tempCanvas.height = oldHeight; const tempCtx = tempCanvas.getContext('2d'); if (oldWidth > 0 && oldHeight > 0) { tempCtx.drawImage(canvas, 0, 0); } canvas.width = newWidth; canvas.height = newHeight; const ctx = canvas.getContext('2d'); ctx.scale(dpr, dpr); ctx.lineCap = 'round'; ctx.lineJoin = 'round'; if (key !== 'main' && !key.startsWith('offer') && !key.startsWith('cost_') && !key.startsWith('agent_') && !key.startsWith('date_')) { } } }; const resizeAll = () => { canvasMap.forEach(map => { const shouldResize = map.key === 'main' || map.mode === 'pen' && (map.condition === undefined || map.condition); if (shouldResize) { resizeCanvas(map.ref, map.key); } }); if (view === 'offer') { offerCanvasMap.forEach(({ ref, key }) => { resizeCanvas(ref, key); }); } setRedrawCounter(r => r + 1); }; resizeAll(); window.addEventListener('resize', resizeAll);
            // --- PRINT FIX: ensure pen strokes on page 1 are rendered into the canvas before printing ---
            const __beforePrint = () => {
                try { resizeAll(); } catch(e) {}
                try {
                    // redraw all known canvases from stored strokes
                    canvasMap.forEach(map => {
                        const c = map.ref && map.ref.current;
                        const strokes = (drawnStrokes && drawnStrokes[map.key]) || [];
                        if (c && strokes && strokes.length) {
                            redrawCanvas(c, strokes, 1, map.key || '');
                        }
                    });
                } catch(e) {}
                try {
                    // also redraw offer canvases (safe no-op if not present)
                    offerCanvasMap && offerCanvasMap.forEach(({ ref, key }) => {
                        const c = ref && ref.current;
                        const strokes = (drawnStrokes && drawnStrokes[key]) || [];
                        if (c && strokes && strokes.length) {
                            redrawCanvas(c, strokes, 1, key || '');
                        }
                    });
                } catch(e) {}
            };
            window.addEventListener('beforeprint', __beforePrint);
            // Some browsers need an immediate redraw after the print dialog opens
            window.addEventListener('afterprint', __beforePrint);
            return () => {
                window.removeEventListener('resize', resizeAll);
                window.removeEventListener('beforeprint', __beforePrint);
                window.removeEventListener('afterprint', __beforePrint);
            }; }, [emailMode, providerMode, isCustomProvider, notesMode, skipReasonMode, view, inputMode]); 
            useEffect(() => { const canvas = canvasRef.current; if (canvas && drawnStrokes.main.length > 0) { redrawCanvas(canvas, drawnStrokes.main, 1, 'main'); } }, [drawnStrokes.main, redrawCounter]); 

            const getRelativeCoords = (e, canvas) => { const rect = canvas.getBoundingClientRect(); const clientX = e.clientX ?? e.touches?.[0]?.clientX; const clientY = e.clientY ?? e.touches?.[0]?.clientY; if (clientX === undefined || clientY === undefined) return null; const cssX = clientX - rect.left; const cssY = clientY - rect.top; return { x: cssX, y: cssY }; };
            const startDrawing = useCallback((e, ref, key) => { e.preventDefault(); const canvas = ref?.current; if(!canvas) return; const pointerType = e.pointerType; const isPenInput = pointerType === 'pen'; const isMainCanvasPenActive = ref === canvasRef && inputMode === 'pen'; const isSmallCanvasPenActive = (ref === emailCanvasRef && emailMode === 'pen') || (ref === providerCanvasRef && providerMode === 'pen') || (ref === notesCanvasRef && notesMode === 'pen') || (ref === skipReasonCanvasRef && skipReasonMode === 'pen'); 
            const isOfferCanvasActive = (ref === offerCanvasRef1 || ref === offerCanvasRef2 || ref === offerCanvasRef3) && inputMode === 'pen'; const isOfferInputActive = (ref === offerCost1Ref || ref === offerCost2Ref || ref === offerCost3Ref || ref === offerAgentRef || ref === offerDateRef) && inputMode === 'pen'; if (!isPenInput || (!isMainCanvasPenActive && !isSmallCanvasPenActive && !isOfferCanvasActive && !isOfferInputActive)) { return; } const { x: cssX, y: cssY } = getRelativeCoords(e, canvas) || {}; if (cssX === undefined || cssY === undefined || cssX === null || cssY === null) return; const ctx = canvas.getContext('2d'); const currentTool = toolRef.current; const currentStrokeWidth = strokeWidthRef.current; const currentColor = colorRef.current; const currentOpacity = opacityRef.current; const strokeBaseWidth = canvas.getBoundingClientRect().width; const zoomLevel = 1.0; const x = cssX / zoomLevel; const y = cssY / zoomLevel; const newStroke = { tool: currentTool, color: currentColor, width: currentStrokeWidth, opacity: currentOpacity, points: [{ x, y }], baseWidth: strokeBaseWidth }; ctx.save(); const isOfferType = key.startsWith('offer'); const rawStrokeW = currentStrokeWidth; let visualBaseW; if (isOfferType) { visualBaseW = rawStrokeW === 2 ? 2.5 : rawStrokeW === 4 ? 5 : 8; } else { visualBaseW = rawStrokeW === 2 ? 2 : rawStrokeW === 4 ? 3 : 5; } const finalLineWidth = visualBaseW / zoomLevel; if (currentTool === 'eraser') { ctx.lineWidth = finalLineWidth * 4; ctx.globalCompositeOperation = 'destination-out'; ctx.globalAlpha = 1; } else if (currentTool === 'highlighter') { ctx.lineWidth = finalLineWidth * 3; ctx.strokeStyle = currentColor; ctx.globalAlpha = currentOpacity; ctx.globalCompositeOperation = 'destination-over'; } else { ctx.lineWidth = finalLineWidth; ctx.strokeStyle = currentColor; ctx.globalAlpha = currentOpacity; ctx.globalCompositeOperation = 'source-over'; } ctx.beginPath(); ctx.moveTo(x, y); currentStrokeRef.current = newStroke; isDrawingRef.current = true; }, [inputMode, emailMode, providerMode, notesMode, skipReasonMode, strokeWidth, color, opacity]); 
            const draw = useCallback((e, ref, key) => { if (!isDrawingRef.current || !currentStrokeRef.current) return; e.preventDefault(); const canvas = ref.current; if(!canvas) return; const { x: cssX, y: cssY } = getRelativeCoords(e, canvas) || {}; if (cssX === undefined || cssY === undefined || cssX === null || cssY === null) return; const zoomLevel = 1.0; const x = cssX / zoomLevel; const y = cssY / zoomLevel; const ctx = canvas.getContext('2d'); currentStrokeRef.current.points.push({ x, y }); ctx.save(); ctx.lineTo(x, y); ctx.stroke(); ctx.restore(); }, []); 
            const stopDrawing = useCallback((e, ref) => { if (!isDrawingRef.current) return; const canvas = ref.current; if (!canvas) return; isDrawingRef.current = false; const finishedStroke = currentStrokeRef.current; currentStrokeRef.current = null; if (finishedStroke && finishedStroke.points.length > 1) { let key = null; if (ref === canvasRef) key = 'main'; else if (ref === emailCanvasRef) key = 'email'; else if (ref === providerCanvasRef) key = 'provider'; else if (ref === notesCanvasRef) key = 'notes'; else if (ref === offerCanvasRef1) key = 'offer1'; else if (ref === offerCanvasRef2) key = 'offer2'; else if (ref === offerCanvasRef3) key = 'offer3'; else if (ref === offerCost1Ref) key = 'cost_einmalig'; else if (ref === offerCost2Ref) key = 'cost_monatlich1'; else if (ref === offerCost3Ref) key = 'cost_monatlich2'; else if (ref === offerAgentRef) key = 'agent_name'; else if (ref === offerDateRef) key = 'date_field'; else if (ref === skipReasonCanvasRef) key = 'skip_reason'; 
                if (key) { setDrawnStrokes(prev => ({ ...prev, [key]: [...(prev[key] || []), finishedStroke] })); if (key.startsWith('offer')) { setRedrawCounter(r => r + 1); } } } const ctx = canvas.getContext('2d'); ctx.restore(); }, [setDrawnStrokes]);

            const CostBar = ({ val, total, colorClass }) => { const pct = total > 0 ? (val / total) * 100 : 0; return (<div className="h-1.5 w-full bg-slate-100 rounded-full mt-1 overflow-hidden"><div className={`h-full ${colorClass} transition-all duration-500`} style={{ width: `${pct}%` }}></div></div>); };
            const toggleTech = (val) => setShowTechModal(val);
            const penTools = [{ id: 'pen', Icon: ICONS.Pen, c: 'bg-blue-100 text-blue-600', title: 'Stift' }, { id: 'highlighter', Icon: ICONS.Highlighter, c: 'bg-yellow-100 text-yellow-600', title: 'Textmarker' }, { id: 'eraser', Icon: ICONS.EraserLine, c: 'bg-slate-100 text-slate-600', title: 'Radierer' }];
            const handleOfferCostChange = (key, value) => { const cleanValue = value.replace(',', '.'); let val = parseFloat(cleanValue); const rawKey = `${key}Raw`; setOfferData(prev => ({ ...prev, [rawKey]: value, [key]: isNaN(val) || value.trim() === '' ? 0 : val })); };
            const getOfferCanvasRef = (key) => { if (key === 'offer1') return offerCanvasRef1; if (key === 'offer2') return offerCanvasRef2; if (key === 'offer3') return offerCanvasRef3; return null; };
            const renderOfferInput = (key, labelKey, type = 'text') => { let ref, rawValue, strokesKey; const label = getStaticLabel(labelKey); if (key === 'einmalig' || key === 'monatlich1' || key === 'monatlich2') { ref = (key === 'einmalig' ? offerCost1Ref : key === 'monatlich1' ? offerCost2Ref : offerCost3Ref); rawValue = offerData[`${key}Raw`] ?? '0'; strokesKey = `cost_${key}`; } else if (key === 'agent') { ref = offerAgentRef; rawValue = getDisplayText('AgentName'); strokesKey = 'agent_name'; } else if (key === 'datum') { ref = offerDateRef; rawValue = getDisplayText('DateValue'); strokesKey = 'date_field'; } const isCostField = key.startsWith('monatlich') || key === 'einmalig'; const handleChange = (e) => { if (isCostField) { handleOfferCostChange(key, e.target.value); } else if (key === 'agent') { handleTextChange('AgentName', e.target.value); } else if (key === 'datum') { handleTextChange('DateValue', e.target.value); } }; const inputHeightClass = 'h-12'; return (<div className="flex flex-col"><label className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">{label}</label><div className={`relative ${inputHeightClass} ${isCostField ? 'bg-slate-50' : 'bg-white'} border border-slate-300 rounded-lg`}>{inputMode === 'pen' ? (<SmallInputCanvas inputMode={inputMode} canvasRef={ref} inputKey={strokesKey} drawnStrokes={drawnStrokes} setDrawnStrokes={setDrawnStrokes} startDrawing={startDrawing} draw={draw} stopDrawing={stopDrawing}/>) : (<input type={type} value={rawValue} onChange={handleChange} placeholder={label.split(' ')[0]} className={`w-full h-full p-3 text-base font-medium focus:ring-1 focus:ring-blue-300 transition-colors focus:outline-none ${isCostField ? 'text-xl font-black text-slate-800 bg-transparent' : 'text-slate-700 bg-transparent'}`}/>)}</div></div>); };
            
            // LOKALE (MOCK) ÜBERSETZUNGSLOGIK
            const handleLocalTranslation = useCallback((targetCode) => {
                if (targetCode === 'de') return;
                
                const mockData = MOCK_TRANSLATIONS[targetCode];

                if (mockData) {
                    const newTranslatedText = {};
                    const newStaticTranslations = {};
                    
                    // 1. Statische Labels aus MOCK-Daten laden
                    Object.keys(STATIC_LABELS).forEach(key => {
                        if (mockData[key]) {
                             newStaticTranslations[key] = mockData[key];
                        }
                    });

                    // 2. Textfelder aus MOCK-Daten laden (als initialer übersetzter Text)
                    Object.keys(textData).forEach(key => {
                        if (mockData[key]) {
                            newTranslatedText[key] = mockData[key];
                        }
                    });

                    // 3. States aktualisieren
                    setTranslatedText(prev => ({ 
                        ...prev, 
                        [targetCode]: { 
                            ...(prev[targetCode] || {}), 
                            ...newTranslatedText 
                        } 
                    }));
                    
                    setStaticTranslations(prev => ({ 
                        ...prev, 
                        [targetCode]: { 
                            ...(prev[targetCode] || {}), 
                            ...newStaticTranslations 
                        } 
                    }));

                    // 4. Update dynamic data for instant display (like AgentName/Date)
                    if (mockData.AgentName) handleTextChange('AgentName', mockData.AgentName);
                    if (mockData.DateValue) handleTextChange('DateValue', mockData.DateValue);


                    triggerToast(`Lokale (Mock) Übersetzung geladen: ${targetCode.toUpperCase()}.`);
                } else {
                    triggerToast(`Für ${targetCode.toUpperCase()} ist keine lokale Mock-Übersetzung verfügbar. Standard-Deutsch wird verwendet.`);
                }
                
            }, [triggerToast, textData, handleTextChange]); 

            // Trigger local translation on language change
            useEffect(() => { 
                if (displayLanguage !== 'de') {
                    if (!staticTranslations[displayLanguage] || !translatedText[displayLanguage]) {
                        handleLocalTranslation(displayLanguage);
                    }
                }
            }, [displayLanguage, handleLocalTranslation, translatedText, staticTranslations]);

            return (
                <div className="w-full h-full bg-[#f0f6ff] font-sans text-slate-800 flex flex-col overflow-hidden text-sm">
                    <Toast message={toastMessage} />
                    <WlanModal isOpen={showWlanModal} onClose={() => setShowWlanModal(false)} triggerToast={triggerToast} onCopyRecommendation={(t)=>{setWlanPrintRec(t);}} />
                    <SpeedModal isOpen={showSpeedModal} onClose={() => setShowSpeedModal(false)} triggerToast={triggerToast} onCopyRecommendation={(t)=>{setSpeedPrintRec(t);}} />
                    <TechModal isOpen={showTechModal} onClose={() => toggleTech(false)} />
                    <RoamingModal isOpen={showRoamingModal} onClose={() => setShowRoamingModal(false)} />
                    <QuestionModal isOpen={!!activeCategory && !showAdmin} onClose={() => setActiveCategory(null)} category={activeCategory} question={getCurrentQuestion()} onNextQuestion={handleNextQuestion} />
                    
                    {/* NEU: Referral Modal */}
                    <ReferralModal isOpen={showReferralModal} onClose={() => setShowReferralModal(false)} onPrint={handlePrint} onPdfShare={handlePdfShare} onJpegShare={handleQuickSharePrintLike} />

                    <SkipReasonModal
                        isOpen={showSkipReasonModal}
                        onClose={() => setShowSkipReasonModal(false)}
                        onConfirm={handleSkipToOffer}
                        reason={skipReason}
                        setReason={setSkipReason}
                        reasonMode={skipReasonMode}
                        setReasonMode={setSkipReasonMode}
                        drawnStrokes={drawnStrokes}
                        setDrawnStrokes={setDrawnStrokes}
                        canvasRef={skipReasonCanvasRef}
                        startDrawing={startDrawing}
                        draw={draw}
                        stopDrawing={stopDrawing}
                        MIN_LENGTH={MIN_REASON_LENGTH}
                    />
                    
                    <AdminModal 
                        isOpen={showAdmin} 
                        onClose={()=>setShowAdmin(false)} 
                        questions={questionsData} 
                        onUpdate={handleUpdateQuestions}
                        oneDriveLink={oneDriveLink}
                        onUpdateLink={setOneDriveLink}
                    />
                    
                    <ImagePlacementModal isOpen={isImageSelectModalOpen} onClose={() => setIsImageSelectModalOpen(false)} onPlace={handleImagePlacement} imageName={currentImagePayload?.name || 'Datei'} />
                    <SignatureModal isOpen={showSignatureModal} onClose={() => setShowSignatureModal(false)} onSign={handleSignatureSave} />
                    {/* ReferralModal wurde entfernt */}

                    <header className="bg-white px-4 py-2 border-b border-slate-200 flex items-center gap-3 shrink-0 shadow-sm z-30 relative h-16 w-full"><button onClick={() => setShowAdmin(true)} className="p-2 text-slate-400 hover:text-blue-600 rounded-full hover:bg-blue-50 transition-colors" title="Fragen & Links bearbeiten (Admin)"><Icon d={ICONS.Lock} size={18}/></button><h1 className="text-3xl font-black text-[#0b1e42] tracking-tighter truncate">{view === 'situation' ? 'Ihre Aktuelle Situation' : 'Ihr Persönliches Angebot'}</h1><span className="bg-blue-600 text-white px-2 py-0.5 rounded-full text-[10px] font-bold border border-blue-700 leading-tight self-start mt-2">{view === 'situation' ? 'Analyse' : 'Angebot'}</span></header>

                    <div className={`flex-1 w-full overflow-hidden relative ${view === 'situation' ? 'flex' : 'hidden'} situation-view-wrapper`}>
                        <div className="flex-1 flex items-stretch p-4 gap-0 overflow-hidden w-full">
                            <div className="flex-1 flex bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden relative isolate flex flex-col h-full w-full">
                                <div className="flex-1 relative w-full h-full flex flex-col">
                                    <div className="flex-1 flex flex-col h-full w-full">
                                           {SITUATION_ITEMS.map((item) => (<div key={item.id} className="flex w-full flex-1 min-h-0 relative gap-0 mb-0 border-b border-slate-200 last:border-b-0"><div className={`w-[30%] shrink-0 flex items-center px-4 gap-4 transition-colors border-r border-slate-200 ${activeCategory === item.id ? 'bg-blue-50 text-blue-800' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}><button onClick={(e) => { e.stopPropagation(); setActiveCategory(item.id); setQuestionIndex(0); }} className="w-10 h-10 shrink-0 flex items-center justify-center rounded-full hover:bg-blue-100 text-blue-600 relative z-30" title="Fragen öffnen"><Icon d={item.icon} size={32} /></button><span className="text-xl md:text-2xl font-black truncate tracking-tight select-none pointer-events-none">{getStaticLabel(`${item.id}_Label`)}</span></div><div className="flex-1 bg-white relative group flex items-center w-[70%]"><input type="text" value={getDisplayText(item.id)} onChange={(e) => handleTextChange(item.id, e.target.value)} className={`${getInputClasses()} ${isMainInputReadOnly ? 'text-slate-700/0' : 'text-slate-700 relative z-30'}`} placeholder={isMainInputReadOnly ? "Skizze aktiv..." : "Eingabe..."} readOnly={isMainInputReadOnly}/></div></div>))}
                                    </div>
                                    <div className="absolute inset-0 z-20" style={{ pointerEvents: (isWritingEnabled && inputMode === 'pen') ? 'auto' : 'none', left: '30%', width: '70%' }}><canvas ref={canvasRef} onPointerDown={(e) => startDrawing(e, canvasRef, 'main')} onPointerMove={(e) => draw(e, canvasRef, 'main')} onPointerUp={(e) => stopDrawing(e, canvasRef)} onPointerLeave={(e) => stopDrawing(e, canvasRef)} className="w-full h-full canvas-layer" /></div>
                                </div>
                            </div>
                        </div>

                        <aside className="w-[300px] bg-[#f0f6ff] p-3 shrink-0 hidden lg:flex flex-col border-l border-slate-200 z-10 h-full overflow-hidden">
                            <div className="flex-1 flex flex-col min-h-0 gap-2 overflow-y-auto custom-scrollbar">
                                <SectionCard title="Stammdaten" className="shrink-0 flex flex-col"><div className="grid grid-cols-2 gap-2 mb-2 shrink-0"><div className="relative h-8"><select value={customerType} onChange={(e) => setCustomerType(e.target.value)} className={`w-full h-full bg-slate-50 border rounded-lg pl-2 pr-6 text-[10px] font-medium text-slate-700 focus:ring-1 outline-none border-l-4 ${customerType === "" ? "border-l-red-500" : "border-l-green-500"}`}><option value="" disabled hidden>Kundentyp *</option><option value="Neukunde">Neukunde</option><option value="Bestandskunde">Bestandskunde</option></select></div><div className="relative h-8"><select value={segment} onChange={(e) => setSegment(e.target.value)} className={`w-full h-full bg-slate-50 border rounded-lg pl-2 pr-6 text-[10px] font-medium text-slate-700 focus:ring-1 outline-none border-l-4 ${segment === "" ? "border-l-red-500" : "border-l-green-500"}`}><option value="" disabled hidden>Segment *</option><option value="Privatkunde">Privatkunde</option><option value="Geschäftskunden">Geschäftskunden</option><option value="Vertragsverlängerung">Vertragsverlängerung</option><option value="Junge Leute">Junge Leute</option><option value="Bestes Alter">Bestes Alter</option></select></div></div><div className="relative w-full h-8 border border-slate-200 rounded-md bg-white overflow-hidden group flex items-center shrink-0"><div className="absolute right-1 top-1/2 -translate-y-1/2 z-30 flex items-center gap-1">
  <button type="button" onClick={() => openZoom('E-Mail Adresse','ink', emailInkUrl || '', (d)=>{ setEmailInkUrl(d); setEmailText(''); }, 'pen')} className="w-7 h-7 rounded-md bg-white border border-slate-200 flex items-center justify-center" title="Mit Stift schreiben"><Icon d={ICONS.Pen} size={14} /></button>
  <button type="button" onClick={() => { setEmailText(''); setEmailInkUrl(''); }} className="w-7 h-7 rounded-md bg-white border border-slate-200 flex items-center justify-center" title="Löschen"><Icon d={ICONS.Trash} size={12}/></button>
</div><div className="relative w-full h-full">
  {" "}
  {emailInkUrl && !emailText && (
    <img src={emailInkUrl} alt="Handschrift E-Mail" className="absolute inset-0 w-full h-full object-contain pointer-events-none px-2 pr-16" />
  )}
  <input type="text" value={emailText} onChange={(e) => { const v = e.target.value; setEmailText(v); if (v) setEmailInkUrl(''); }} placeholder="E-Mail Adresse" className={`w-full h-full px-3 text-[10px] focus:outline-none bg-transparent pr-16 ${emailInkUrl && !emailText ? "ink-hide" : ""}`}  style={emailInkUrl && !emailText ? { color: "transparent", caretColor: "transparent" } : undefined} />
</div>
</div></SectionCard>
                                <SectionCard title="Technische Situation" className="shrink-0 flex flex-col"><div className="relative mb-2 w-full h-8 shrink-0">{!isCustomProvider ? (<select value={providerSelect} onChange={(e) => { if (e.target.value === 'Sonstiges') { setIsCustomProvider(true); setProviderSelect('Sonstiges'); } else { setProviderSelect(e.target.value); setIsCustomProvider(false); } }} className={`w-full h-full bg-slate-50 border rounded-md pl-2 pr-6 text-[10px] font-medium text-slate-700 focus:ring-1 outline-none border-l-4 ${providerSelect === "" ? "border-l-red-500" : "border-l-green-500"}`}><option value="" disabled hidden>Derzeitiger DSL-Anbieter *</option><option value="Telekom">Telekom</option><option value="1&1">1&1</option><option value="Vodafone">Vodafone</option><option value="O2">O2</option><option value="Sonstiges">Sonstiges / Eingabe</option></select>) : (<div className="relative w-full h-full border border-slate-200 rounded-md bg-white overflow-hidden group flex items-center border-l-4 border-l-green-500"><div className="absolute right-1 top-1/2 -translate-y-1/2 z-30 flex items-center gap-1"><button type="button" onClick={() => setProviderMode(prev => prev === 'keyboard' ? 'pen' : 'keyboard')} className="w-7 h-7 rounded-md bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 flex items-center justify-center" title={providerMode === 'keyboard' ? 'Mit Stift schreiben' : 'Zur Tastatur'}>{providerMode === 'keyboard' ? <Icon d={ICONS.Pen} size={14}/> : <Icon d={ICONS.Keyboard} size={14}/>}</button>{providerMode === 'keyboard' && (<button type="button" onClick={() => openZoom('Anbieter','text', customProvider, setCustomProvider)} className="w-7 h-7 rounded-md bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 flex items-center justify-center" title="Groß schreiben"><Icon d={ICONS.Maximize} size={14} /></button>)}<button type="button" onClick={() => { setIsCustomProvider(false); setProviderSelect(''); setCustomProvider(''); }} className="w-7 h-7 rounded-md bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 flex items-center justify-center" title="Zurück zur Liste"><Icon d={ICONS.List} size={14}/></button></div>{providerMode === 'keyboard' ? (<div className="relative w-full h-full">
                                <input type="text" value={customProvider} onChange={(e) => setCustomProvider(e.target.value)} placeholder="Anbieter..." className="w-full h-full px-3 text-[10px] focus:outline-none bg-transparent pr-28" autoFocus />
</div>) : (<><canvas ref={providerCanvasRef} className="absolute inset-0 w-full h-full cursor-crosshair" onPointerDown={(e) => startDrawing(e, providerCanvasRef, 'provider')} onPointerMove={(e) => draw(e, providerCanvasRef, 'provider')} onPointerUp={(e) => stopDrawing(e, providerCanvasRef)} onPointerLeave={(e) => stopDrawing(e, providerCanvasRef)} /><button onClick={() => clearCanvas(providerCanvasRef, 'provider')} className="absolute top-1/2 right-1 -translate-y-1/2 p-1 hover:bg-slate-100 rounded text-slate-400 z-30" title="Löschen"><Icon d={ICONS.Trash} size={10}/></button></>)}</div>)}</div><button onClick={() => setShowWlanModal(true)} className="w-full h-8 bg-slate-100 text-left px-3 rounded-md text-[10px] font-bold text-slate-700 flex items-center gap-2 border border-slate-200 hover:bg-slate-200 transition-colors shrink-0"><Icon d={ICONS.Wifi} size={14} className="text-slate-500" /> WLAN-Planer öffnen</button>{wlanPrintRec&&<div className="print-reco">{wlanPrintRec}</div>}</SectionCard>
                                <SectionCard title="Technologie & Speed" className="shrink-0 flex flex-col"><div className="space-y-1 flex flex-col justify-center h-full"><button onClick={() => setShowTechModal(true)} className="w-full h-8 bg-slate-100 text-left px-3 rounded-md text-[10px] font-bold text-slate-700 flex items-center gap-2 border border-slate-200 hover:bg-slate-200 transition-colors"><Icon d={ICONS.Zap} size={14} className="text-slate-500" /> Technologie-Check</button><button onClick={() => setShowSpeedModal(true)} className="w-full h-8 bg-slate-100 text-left px-3 rounded-md text-[10px] font-bold text-slate-700 flex items-center gap-2 border border-slate-200 hover:bg-slate-200 transition-colors"><Icon d={ICONS.Gauge} size={14} className="text-slate-500" /> Speed-Rechner</button>{speedPrintRec&&<div className="print-reco">{speedPrintRec}</div>}</div></SectionCard>
                                <SectionCard title="Roaming" className="shrink-0 flex flex-col"><div className="flex-1 flex items-center"><button onClick={() => setShowRoamingModal(true)} className="w-full h-8 bg-slate-100 text-left px-3 rounded-md text-[10px] font-bold text-slate-700 flex items-center gap-2 border border-slate-200 hover:bg-slate-200 transition-colors"><Icon d={ICONS.Globe} size={14} className="text-slate-500" /> Roaming Check</button></div></SectionCard>
                                <SectionCard title="Kosten (Ist)" className="shrink-0 flex flex-col"><div className="flex flex-col justify-center h-full gap-1"><div className="grid grid-cols-2 gap-2"><div><input className="w-full h-7 border border-slate-200 rounded px-2 text-[10px] focus:ring-1 relative z-10 bg-transparent" placeholder="Mobil €" value={costState.mobile} onChange={(e) => handleCostChange('mobile', e)} /><CostBar val={parseCost(costState.mobile)} total={totalCost} colorClass="bg-blue-500" /></div><div><input className="w-full h-7 border border-slate-200 rounded px-2 text-[10px] focus:ring-1 relative z-10 bg-transparent" placeholder="Festnetz €" value={costState.landline} onChange={(e) => handleCostChange('landline', e)} /><CostBar val={parseCost(costState.landline)} total={totalCost} colorClass="bg-cyan-500" /></div></div><div><input className="w-full h-7 border border-slate-200 rounded px-2 text-[10px] focus:ring-1 relative z-10 bg-transparent" placeholder="TV €" value={costState.tv} onChange={(e) => handleCostChange('tv', e)} /><CostBar val={parseCost(costState.tv)} total={totalCost} colorClass="bg-purple-500" /></div></div><div className="bg-slate-100 rounded-md px-2 h-7 flex items-center justify-end text-[11px] font-bold text-slate-700 border border-slate-200 mt-1 shrink-0">{totalCost.toFixed(2)} €}</div></SectionCard>
                                <SectionCard title="Notizblock" className="flex-1 min-h-0 flex flex-col relative no-print">
  <div className="absolute top-0 right-0 z-30 p-2 flex items-center gap-1">
    <button type="button"
      onClick={() => openZoom('Notiz (Nur für Verkäufer)','ink', notesInkUrl, (d)=>{ setNotesInkUrl(d); setSellerNotes(''); }, 'pen')}
      className="w-9 h-9 rounded-xl bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 flex items-center justify-center shadow-sm"
      title="Mit Stift schreiben">
      <Icon d={ICONS.Pen} size={18}/>
    </button>
    <button type="button"
      onClick={() => { setNotesInkUrl(''); }}
      className="w-9 h-9 rounded-xl bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 flex items-center justify-center shadow-sm"
      title="Handschrift löschen">
      <Icon d={ICONS.Trash} size={18}/>
    </button>
  </div>

  <div className="relative w-full h-full">
    {notesInkUrl && !sellerNotes && (
      <img src={notesInkUrl} alt="Handschrift Notiz" className="absolute inset-0 w-full h-full object-contain pointer-events-none p-2" />
    )}

    <textarea
      className={`w-full h-full bg-transparent border border-amber-200 rounded-md p-2 text-sm text-slate-600 resize-none focus:ring-0 flex-1 relative z-10 ${notesInkUrl && !sellerNotes ? "ink-hide" : ""}`}
      style={notesInkUrl && !sellerNotes ? { color: "transparent", caretColor: "transparent" } : undefined}
      placeholder="Nur für Verkäufer..."
      value={sellerNotes}
      onChange={(e)=>{ const v=e.target.value; setSellerNotes(v); if(v) setNotesInkUrl(''); }}
    />
  </div>
</SectionCard>
                            </div>
                        </aside>
                    </div>

                    {/* Angepasste Offer View für Druck */}
                    <div className={`flex-1 w-full relative bg-[#f0f6ff] ${view === 'offer' ? 'flex overflow-y-auto' : 'hidden'} print-offer-view`}>
                        
                        {/* Druck: zusätzlicher Header für Seite 2 (weil der Haupt-Header auf Seite 1 bleibt) */}
                        <div className="print-only-offer-header bg-white px-4 py-2 border-b border-slate-200 items-center gap-3 shrink-0 shadow-sm z-30 relative h-16 w-full">
                            <h1 className="text-3xl font-black text-[#0b1e42] tracking-tighter truncate">Ihr Persönliches Angebot</h1>
                            <span className="bg-blue-600 text-white px-2 py-0.5 rounded-full text-[10px] font-bold border border-blue-700 leading-tight self-start mt-2">v16.7 Angebot</span>
                        </div>
<div className="w-full flex-1 flex flex-col space-y-6 min-h-0 p-4 md:p-8">
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 w-full offer-print-grid"> 
                                {[{ key: 'offer1', icon: ICONS.Smartphone, labelKey: 'Offer1Title', ref: offerCanvasRef1, scaleRef: scaleRef1 }, { key: 'offer2', icon: ICONS.Users, labelKey: 'Offer2Title', ref: offerCanvasRef2, scaleRef: scaleRef2 }, { key: 'offer3', icon: ICONS.Router, labelKey: 'Offer3Title', ref: offerCanvasRef3, scaleRef: scaleRef3 }].map(({ key, icon, labelKey, ref, scaleRef }) => (<OfferCanvas key={key} canvasRef={ref} icon={icon} label={getStaticLabel(labelKey)} statusKey={key} status={canvasStatus[key]} setStatus={setCanvasStatus} inputMode={inputMode} startDrawing={startDrawing} draw={draw} stopDrawing={stopDrawing} textValue={getDisplayText(key)} handleTextChange={handleTextChange} textStyle={textStyle} textSize={textSize} imageTransform={imageTransform[key]} onUpdateImageTransform={handleUpdateImageTransform} drawnStrokes={drawnStrokes[key]} setDrawnStrokes={(newStrokes) => setDrawnStrokes(prev => ({ ...prev, [key]: newStrokes }))} scaleRef={scaleRef} triggerRedraw={redrawCounter} image={canvasImages[key]} onClearImage={() => handleClearImage(key)}/>))}
                            </div>

                            <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-xl shrink-0 print-page-2">
                                        <h3 className="text-lg font-black text-slate-800 mb-4 flex items-center gap-2"><Icon d={ICONS.Calculator} size={20} className="text-blue-600"/> {getStaticLabel('CostHeader')}</h3>
                                        <div className="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6">{renderOfferInput('einmalig', 'CostEinmalig', 'text')}{renderOfferInput('monatlich1', 'CostMonatlich1', 'text')}{renderOfferInput('monatlich2', 'CostMonatlich2', 'text')}</div>
                                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
{renderOfferInput('agent', 'AgentLabel', 'text')}
{renderOfferInput('datum', 'DateLabel', 'text')}
<div className="col-span-2">
  <div className="grid grid-cols-5 gap-3 items-end">
    {/* Shop-Stempel (kleiner links) */}
    <div className="col-span-2">
      <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Shop-Stempel</label>
      <div className="h-12 bg-slate-50 border border-slate-300 rounded-lg flex items-center justify-between px-3 gap-3 stamp-box">
        <div className="text-xs font-bold text-slate-700 leading-tight stamp-text">o2 Shop Crailsheim</div>
        <img
          src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAABQCAIAAAABc2X6AAACaUlEQVR42u2bzW7EMAiE46rv/8rbw0qrKKHDB04PFZNL1fVP3B0YYEzX6/U6Jj1fx7Dn+/1jrVVaJuzislVqQeGrP6vuo2KInHkcwlNNetMCzx/qHcRMsbA3FB54PMKESPTMkLQ+H943IST0HuJMKQ5shFtPCv4FxvN8YhHvX1OczdJ/hnCI3gWr32ZeEKumE0bYfzAx6R1i0DaZhpZwQnoefuDxCO9zRhiBLtuGQ+dfxSabJDcV4Ud0D14MpM4vUtFNonFYGmLSIXMQ673bFd9K8BOJVfyQRrjyjab1bS/f0AvTOkkU1ZejWtMqOh7EShS92mnTxKNaP7t4aDneubKtCuuaDu7Y6vkpdTvxcFiqTtBhrPSWdvktdh6H8CJMAxMPAQuRaSHgOhVNmdWJB7ubCsMMjxOpTMuF+/R10xOPqaQl6IG3MAjme7APQm+Vutj4sLQviBIFg6fuInuBtuN6GEegRxxbVD/cb9NsxD7cqodTR+ppTuHrhAVptK142KRhJqAjRE+yIdaeNrKFlXY4YWhYWr2rDXIJvB+3ju1mXPvwL/3SPKGDrYQcfFFv91LX6T7saqkYNmASJnKm6v1wtbCbnmktLrvuK7I6+FWrJfgY4UzxaHfHp2p71Yc5zoI+xqeW5fWZ8J2uImIFl/tTq3TiMTOX5lx/N6Fqdyyvb0lsc1iqJB7ke4VXMz0NvUFaKdSWaVsyAhRrj+5Vzl18LfntaB+2Se/TYMR/jzS1kMIu7dwzwk9D3UsnyBDsZXI3bZHWH1EkYIQj9Xm1tdHNpUWsdtQm8t+VqeJRVc6ceFjiMcL/+/kB7cb0wxyu1esAAAAASUVORK5CYII="
          alt="QR Code o2 Shop Crailsheim"
          className="h-10 w-10 shrink-0 object-contain stamp-qr"
        />
      </div>
    </div>

    {/* Kunden-Unterschrift (groß rechts) */}
    <div className="col-span-3">
      <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Unterschrift Kunde</label>
      {customerSignature ? (
        customerSignature === 'PAPER_SIGNATURE' ? (
          <div className="h-12 bg-white border-b-2 border-slate-400 flex items-center justify-end pr-2 text-xs font-black text-slate-700 paper-signature-box">
            Papier unterschrieben ✅
          </div>
        ) : (
          <div className="p-1 h-12 bg-white border-b-2 border-slate-400 flex items-end justify-end signature-box">
            <img src={customerSignature} alt="Kundenunterschrift" className="h-full w-full object-contain object-right-bottom signature-img" />
          </div>
        )
      ) : (
        <div className="h-12 bg-slate-50 border border-slate-300 rounded-lg text-center text-sm text-slate-400 font-medium flex items-center justify-center w-full signature-placeholder">
          Feld für Unterschrift Kunde
        </div>
      )}
    </div>
  </div>
</div>
</div>
                                        
                                        <div className="mt-4 pt-4 border-t border-slate-100"><p className="text-[10px] text-slate-400 leading-tight">**Datenschutzerklärung (Platzhalter):** Mit Ihrer Unterschrift bestätigen Sie die Richtigkeit der angegebenen Kosten und nehmen die Vertragsdetails sowie die beigefügte Datenschutzerklärung zur Kenntnis. Sie stimmen der elektronischen Speicherung Ihrer Daten zum Zwecke der Vertragsabwicklung zu. Widerrufsbelehrung liegt bei.</p></div>
                                    </div>
                        </div>
                    </div>

                    <div className="h-14 bg-[#f0f6ff] border-t border-slate-200 flex items-center px-4 shrink-0 z-40 justify-between shadow-sm relative w-full footer-bar">
                        {view === 'situation' ? (<><div className="flex items-center gap-3"><div className="flex gap-1 bg-white p-0.5 rounded-lg border border-slate-200 shadow-sm"><button onClick={() => setInputMode('pen')} className={`p-2 rounded-md transition-colors ${inputMode === 'pen' ? 'bg-blue-100 text-blue-600' : 'text-slate-400 hover:bg-slate-50'}`} title="Stift-Modus (Stylus Only)"><Icon d={ICONS.Pen} size={16} /></button><button onClick={() => setInputMode('keyboard')} className={`p-2 rounded-md transition-colors ${inputMode === 'keyboard' ? 'bg-blue-100 text-blue-600' : 'text-slate-400 hover:bg-slate-50'}`} title="Tastatur-Modus"><Icon d={ICONS.Keyboard} size={16} /></button></div>{inputMode === 'pen' && (<div className="flex gap-1 bg-white p-0.5 rounded-lg border border-slate-200 shadow-sm animate-in items-center relative z-50">{penTools.map(t => (<button key={t.id} onClick={() => setTool(t.id)} className={`p-2 rounded-md ${tool === t.id ? t.c : 'text-slate-400 hover:bg-slate-50'}`} title={t.title}><Icon d={t.Icon} size={16} /></button>))}<div className="w-px h-6 bg-slate-200 mx-1"></div><div className="flex bg-slate-50 rounded border border-slate-200 p-0.5 gap-0.5">{STROKE_SIZES.map(s => (<button key={s.id} onClick={() => setStrokeWidth(s.width)} className={`w-6 h-6 flex items-center justify-center rounded hover:bg-slate-200 ${strokeWidth === s.width ? 'bg-slate-200 shadow-inner' : ''}`}><div className="bg-slate-600 rounded-full" style={{ width: s.id * 3, height: s.id * 3 }}></div></button>))}</div>{(tool === 'pen' || tool === 'highlighter') && (<div className="flex items-center gap-2 bg-slate-50 rounded border border-slate-200 p-1.5 ml-2"><Icon d={ICONS.Sun} size={16} className="text-slate-400"/><input type="range" min="10" max="100" value={Math.round(opacity * 100)} onChange={(e) => setOpacity(parseInt(e.target.value) / 100)} className="w-20 h-1 appearance-none bg-blue-200 rounded-full [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-3.5 [&::-webkit-slider-thumb]:h-3.5 [&::-webkit-slider-thumb]:bg-blue-600 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:shadow-lg" title={`Deckkraft: ${Math.round(opacity * 100)}%`}/></div>)}<div className="w-px h-6 bg-slate-200 mx-1"></div><div className="relative"><button onClick={() => setShowColorPicker(!showColorPicker)} className="w-8 h-8 rounded-full border shadow-sm flex items-center justify-center ring-offset-2 focus:ring-2" style={{ backgroundColor: color }}><Icon d={ICONS.Palette} size={12} className="text-white mix-blend-difference" /></button>{showColorPicker && (<div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-3 bg-white p-3 rounded-xl shadow-2xl border border-slate-200 grid grid-cols-4 gap-2 w-[180px] z-[100]"><div className="col-span-4 text-[10px] font-bold text-slate-400 uppercase tracking-wider text-center mb-1">Farbe wählen</div>{COLORS.map(c => <button key={c.id} onClick={() => { setColor(c.value); setShowColorPicker(false); }} className={`w-8 h-8 rounded-full border-2 transition-transform hover:scale-110 ${color === c.value ? 'border-slate-400 shadow-inner scale-110' : 'border-transparent'}`} style={{ backgroundColor: c.value }} title={c.label} />)}</div>)}</div></div>)}{inputMode === 'keyboard' && (<div className="flex gap-1 bg-white p-0.5 rounded-lg border border-slate-200 shadow-sm animate-in items-center relative z-50"><div className="flex bg-slate-50 rounded border border-slate-200 p-0.5 gap-0.5"><button onClick={() => setTextSize('small')} className={`w-8 h-8 flex items-center justify-center rounded text-xs font-bold ${textSize === 'small' ? 'bg-white shadow text-blue-600 ring-1 ring-blue-100' : 'text-slate-500 hover:bg-slate-200'}`}>A</button><button onClick={() => setTextSize('medium')} className={`w-8 h-8 flex items-center justify-center rounded text-sm font-bold ${textSize === 'medium' ? 'bg-white shadow text-blue-600 ring-1 ring-blue-100' : 'text-slate-500 hover:bg-slate-200'}`}>A</button><button onClick={() => setTextSize('large')} className={`w-8 h-8 flex items-center justify-center rounded text-lg font-bold ${textSize === 'large' ? 'bg-white shadow text-blue-600 ring-1 ring-blue-100' : 'text-slate-500 hover:bg-slate-200'}`}>A</button></div><div className="w-px h-6 bg-slate-200 mx-1"></div><div className="flex gap-1"><button onClick={() => setTextStyle(p => ({...p, bold: !p.bold}))} className={`w-8 h-8 rounded flex items-center justify-center font-black transition-colors ${textStyle.bold ? 'bg-blue-100 text-blue-600 ring-1 ring-blue-200' : 'text-slate-500 hover:bg-slate-100'}`} title="Fett"><Icon d={ICONS.Bold} size={16}/></button><button onClick={() => setTextStyle(p => ({...p, italic: !p.italic}))} className={`w-8 h-8 rounded flex items-center justify-center italic font-serif transition-colors ${textStyle.italic ? 'bg-blue-100 text-blue-600 ring-1 ring-blue-200' : 'text-slate-500 hover:bg-slate-100'}`} title="Kursiv"><Icon d={ICONS.Italic} size={16}/></button></div></div>)}</div><div className="flex items-center gap-2">
                            <button onClick={() => setShowSkipReasonModal(true)} className="px-4 py-2 text-slate-500 font-bold text-xs hover:bg-slate-100 rounded-lg transition-colors">Überspringen</button>
                            <button onClick={() => isFormValid && setView('offer')} className={`px-6 py-2 rounded-lg font-bold shadow-lg text-sm flex items-center gap-2 transition-all ${isFormValid ? 'bg-blue-600 text-white hover:bg-blue-700 cursor-pointer' : 'bg-slate-300 text-slate-500 cursor-not-allowed'}`} title={isFormValid ? "Weiter zum Angebot" : "Bitte Pflichtfelder ausfüllen (Kundentyp, Segment, Anbieter)"}>Zum Angebot <Icon d={ICONS.ArrowRight} size={18} /></button>
                        </div></>) : (<div className="w-full flex justify-between items-center"><div className="flex items-center gap-3"><div className="flex gap-1 bg-white p-0.5 rounded-lg border border-slate-200 shadow-sm"><button onClick={() => setInputMode('pen')} className={`p-2 rounded-md transition-colors ${inputMode === 'pen' ? 'bg-blue-100 text-blue-600' : 'text-slate-400 hover:bg-slate-50'}`} title="Stift-Modus (Stylus Only)"><Icon d={ICONS.Pen} size={16} /></button><button onClick={() => setInputMode('keyboard')} className={`p-2 rounded-md transition-colors ${inputMode === 'keyboard' ? 'bg-blue-100 text-blue-600' : 'text-slate-400 hover:bg-slate-50'}`} title="Tastatur-Modus"><Icon d={ICONS.Keyboard} size={16} /></button></div>{inputMode === 'pen' && (<div className="flex gap-1 bg-white p-0.5 rounded-lg border border-slate-200 shadow-sm animate-in items-center relative z-50">{penTools.map(t => (<button key={t.id} onClick={() => setTool(t.id)} className={`p-2 rounded-md ${tool === t.id ? t.c : 'text-slate-400 hover:bg-slate-50'}`} title={t.title}><Icon d={t.Icon} size={16} /></button>))}<div className="w-px h-6 bg-slate-200 mx-1"></div><div className="flex bg-slate-50 rounded border border-slate-200 p-0.5 gap-0.5">{STROKE_SIZES.map(s => (<button key={s.id} onClick={() => setStrokeWidth(s.width)} className={`w-6 h-6 flex items-center justify-center rounded hover:bg-slate-200 ${strokeWidth === s.width ? 'bg-slate-200 shadow-inner' : ''}`}><div className="bg-slate-600 rounded-full" style={{ width: s.id * 3, height: s.id * 3 }}></div></button>))}</div>{(tool === 'pen' || tool === 'highlighter') && (<div className="flex items-center gap-2 bg-slate-50 rounded border border-slate-200 p-1.5 ml-2"><Icon d={ICONS.Sun} size={16} className="text-slate-400"/><input type="range" min="10" max="100" value={Math.round(opacity * 100)} onChange={(e) => setOpacity(parseInt(e.target.value) / 100)} className="w-20 h-1 appearance-none bg-blue-200 rounded-full [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-3.5 [&::-webkit-slider-thumb]:h-3.5 [&::-webkit-slider-thumb]:bg-blue-600 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:shadow-lg" title={`Deckkraft: ${Math.round(opacity * 100)}%`}/></div>)}<div className="w-px h-6 bg-slate-200 mx-1"></div><div className="relative"><button onClick={() => setShowColorPicker(!showColorPicker)} className="w-8 h-8 rounded-full border shadow-sm flex items-center justify-center ring-offset-2 focus:ring-2" style={{ backgroundColor: color }}><Icon d={ICONS.Palette} size={12} className="text-white mix-blend-difference" /></button>{showColorPicker && (<div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-3 bg-white p-3 rounded-xl shadow-2xl border border-slate-200 grid grid-cols-4 gap-2 w-[180px] z-[100]"><div className="col-span-4 text-[10px] font-bold text-slate-400 uppercase tracking-wider text-center mb-1">Farbe wählen</div>{COLORS.map(c => <button key={c.id} onClick={() => { setColor(c.value); setShowColorPicker(false); }} className={`w-8 h-8 rounded-full border-2 transition-transform hover:scale-110 ${color === c.value ? 'border-slate-400 shadow-inner scale-110' : 'border-transparent'}`} style={{ backgroundColor: c.value }} title={c.label} />)}</div>)}</div></div>)}{inputMode === 'keyboard' && (<div className="flex gap-1 bg-white p-0.5 rounded-lg border border-slate-200 shadow-sm animate-in items-center relative z-50"><div className="flex bg-slate-50 rounded border border-slate-200 p-0.5 gap-0.5"><button onClick={() => setTextSize('small')} className={`w-8 h-8 flex items-center justify-center rounded text-xs font-bold ${textSize === 'small' ? 'bg-white shadow text-blue-600 ring-1 ring-blue-100' : 'text-slate-500 hover:bg-slate-200'}`}>A</button><button onClick={() => setTextSize('medium')} className={`w-8 h-8 flex items-center justify-center rounded text-sm font-bold ${textSize === 'medium' ? 'bg-white shadow text-blue-600 ring-1 ring-blue-100' : 'text-slate-500 hover:bg-slate-200'}`}>A</button><button onClick={() => setTextSize('large')} className={`w-8 h-8 flex items-center justify-center rounded text-lg font-bold ${textSize === 'large' ? 'bg-white shadow text-blue-600 ring-1 ring-blue-100' : 'text-slate-500 hover:bg-slate-200'}`}>A</button></div><div className="w-px h-6 bg-slate-200 mx-1"></div><div className="flex gap-1"><button onClick={() => setTextStyle(p => ({...p, bold: !p.bold}))} className={`w-8 h-8 rounded flex items-center justify-center font-black transition-colors ${textStyle.bold ? 'bg-blue-100 text-blue-600 ring-1 ring-blue-200' : 'text-slate-500 hover:bg-slate-100'}`} title="Fett"><Icon d={ICONS.Bold} size={16}/></button><button onClick={() => setTextStyle(p => ({...p, italic: !p.italic}))} className={`w-8 h-8 rounded flex items-center justify-center italic font-serif transition-colors ${textStyle.italic ? 'bg-blue-100 text-blue-600 ring-1 ring-blue-200' : 'text-slate-500 hover:bg-slate-100'}`} title="Kursiv"><Icon d={ICONS.Italic} size={16}/></button></div></div>)}</div><div className="flex items-center gap-4"><button onClick={handleFileAdd} className="p-2 bg-white rounded-lg border border-slate-200 shadow-sm text-slate-500 hover:bg-slate-100 hover:text-blue-600 transition-colors" title="Datei hinzufügen (Kamera / Ordner)"><Icon d={ICONS.Folder} size={18}/></button><div className="relative"><button onClick={() => setShowLanguageDropdown(p => !p)} className="flex items-center gap-2 bg-white p-2 rounded-lg border border-slate-200 shadow-sm hover:bg-slate-100 transition-colors" title={`Sprache: ${SORTED_LANGUAGES.find(l => l.code === displayLanguage)?.name || 'Deutsch'}`}><div className="relative flex items-center justify-center"><Icon d={ICONS.Globe} size={18} className="text-slate-500"/>{displayLanguage !== 'de' && (<span className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-[10px] font-black text-white mix-blend-difference leading-none pointer-events-none">{displayLanguage.toUpperCase()}</span>)}</div></button>{showLanguageDropdown && (<div className="absolute bottom-full right-0 mb-2 w-48 bg-white border border-slate-200 rounded-lg shadow-xl overflow-hidden z-50 animate-in fade-in"><div className="p-2 border-b border-slate-100 text-xs font-bold text-slate-500 uppercase">Sprache wählen</div>{SORTED_LANGUAGES.map(lang => (<button key={lang.code} onClick={() => { setDisplayLanguage(lang.code); setShowLanguageDropdown(false); }} className={`w-full text-left px-3 py-2 text-sm transition-colors flex items-center gap-2 ${displayLanguage === lang.code ? 'bg-blue-50 text-blue-700 font-bold' : 'text-slate-700 hover:bg-slate-100'}`}>{lang.name}{displayLanguage === lang.code && <Icon d={ICONS.CheckCircle} size={14} className="ml-auto"/>}</button>))}</div>)}</div><div className="flex items-center"><button onClick={openOneDriveLink} className="p-2 bg-blue-500 text-white rounded-lg shadow-md hover:bg-blue-600 transition-colors mr-2 flex items-center justify-center" title="Link zur Aktionsmappe (Buch)"><Icon d={ICONS.Book} size={18}/> </button><button onClick={() => setView('situation')} className="px-6 py-2 text-slate-500 font-bold text-xs hover:bg-slate-100 rounded-lg transition-colors mr-2 flex items-center gap-1"><Icon d={ICONS.ArrowLeft} size={14}/> Zurück</button><button onClick={handleFinishOffer} className={`px-6 py-2 rounded-lg font-bold shadow-lg text-sm flex items-center gap-2 transition-all ${customerSignature ? 'bg-emerald-600 hover:bg-emerald-700' : 'bg-green-600 hover:bg-green-700'} text-white`}>{customerSignature ? 'Vertrag drucken' : 'Angebot abschließen'} <Icon d={ICONS.Signature} size={18}/></button></div></div></div>)}</div><input type="file" ref={fileInputRef} onChange={handleFileSelect} accept="image/*, application/pdf" capture="environment" hidden aria-label="Datei auswählen oder Kamera öffnen"/>
                {zoomOpen && (
                  <div className="fixed inset-0 z-[999999] bg-black/40 flex items-center justify-center p-4">
                    <div className="w-full max-w-3xl bg-white rounded-2xl shadow-2xl border border-slate-200 p-4">
                      <div className="flex items-center justify-between mb-3">
                        <div className="flex items-center gap-3">
                          <div className="text-base font-black text-slate-900">{zoomLabel}</div>
                          <div className="flex items-center gap-1 bg-slate-100 rounded-xl p-1 border border-slate-200">
                            <button type="button" onClick={()=>setZoomInputMode('pen')} className={`px-2 py-1 rounded-lg text-xs font-black ${zoomInputMode==='pen'?'bg-white shadow text-slate-900':'text-slate-600 hover:text-slate-900'}`}>✏️ Stift</button>
                            <button type="button" onClick={()=>setZoomInputMode('keyboard')} className={`px-2 py-1 rounded-lg text-xs font-black ${zoomInputMode==='keyboard'?'bg-white shadow text-slate-900':'text-slate-600 hover:text-slate-900'}`}>⌨ Tastatur</button>
                          </div>
                        </div>
                        <button type="button" onClick={closeZoom} className="w-9 h-9 rounded-xl bg-slate-100 hover:bg-slate-200 flex items-center justify-center font-black text-slate-700">✕</button>
                      </div>

                      {zoomInputMode === 'pen' && (
                        <div className="mb-2 text-xs text-slate-600">Mit dem <span className="font-black">Stift</span> ins Feld schreiben (Handschrift). Für normale Eingabe auf <span className="font-black">Tastatur</span> umschalten.</div>
                      )}

                      {(zoomInputMode === 'pen' && zoomType === 'ink') ? (
                        <div className="w-full">
                          <div className="flex items-center justify-end mb-2">
                            <button type="button" onClick={()=>{ zoomInkDirtyRef.current = true; clearZoomInk(); }} className="px-3 py-2 rounded-lg bg-white border border-slate-200 text-sm font-bold text-slate-700 hover:bg-slate-50 flex items-center gap-2">
                              <Icon d={ICONS.Trash} size={14}/> Löschen
                            </button>
                          </div>
                          <div className="relative w-full h-[24vh] bg-white border border-slate-200 rounded-2xl overflow-hidden ink-paper">
                            <canvas
                              ref={zoomInkCanvasRef}
                              className="absolute inset-0 w-full h-full touch-none cursor-crosshair"
                              onPointerDown={zoomInkStart}
                              onPointerMove={zoomInkMove}
                              onPointerUp={zoomInkEnd}
                              onPointerCancel={zoomInkEnd}
                              onPointerLeave={zoomInkEnd}
                            />
                          </div>
                        </div>
                      ) : (zoomType === 'textarea' ? (
                        <textarea
                          ref={zoomInputRef}
                          className="w-full h-[55vh] bg-white border border-slate-200 rounded-2xl p-4 text-base text-slate-800 resize-none focus:outline-none focus:ring-2 focus:ring-blue-300"
                          value={zoomValue}
                          onChange={(e)=>setZoomValue(e.target.value)}
                        />
                      ) : (
                        <input
                          ref={zoomInputRef}
                          type="text"
                          className="w-full h-14 bg-white border border-slate-200 rounded-2xl px-4 text-base text-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-300"
                          value={zoomValue}
                          onChange={(e)=>setZoomValue(e.target.value)}
                        />
                      ))}<div className="mt-4 flex items-center justify-between gap-2">
                        <div className="text-xs text-slate-500">Tipp: Auf iPad/Android kannst du im großen Feld per Handschrift (Stylus) schreiben – ohne Scroll-Probleme.</div>
                        <div className="flex gap-2">
                          <button type="button" onClick={closeZoom} className="px-4 py-2 rounded-xl bg-slate-100 hover:bg-slate-200 font-bold text-slate-800">Abbrechen</button>
                          <button type="button" onClick={applyZoom} className="px-4 py-2 rounded-xl bg-blue-600 hover:bg-blue-700 font-bold text-white shadow-sm shadow-blue-200/40">Übernehmen</button>
                        </div>
                      </div>
                    </div>
                  </div>
                )}

</div>);
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>

<script>
(function(){
  function markKostenabschlussCard(){
    const hs = Array.from(document.querySelectorAll('h3'));
    const h = hs.find(el => (el.textContent||'').includes('Kostenübersicht') && (el.textContent||'').includes('Abschluss'));
    if(!h) return;
    const card = h.closest('div');
    if(card) card.classList.add('print-kostenabschluss');
  }
  if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', markKostenabschlussCard);
  else markKostenabschlussCard();
})();
</script>

</body>
</html>
